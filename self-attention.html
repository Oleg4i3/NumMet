<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer Attention: Full Math & 3D</title>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script>
        MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { 
            --bg: #f8fafc; --panel: #ffffff; --text: #1e293b; --border: #cbd5e1;
            --accent: #4f46e5; 
            --ctx-bio: #16a34a; 
            --ctx-music: #2563eb; 
            --ctx-admin: #db2777; 
        }
        
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; display: flex; height: 100vh; }
        
        /* –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å (–®–∏—Ä—à–∞ –¥–ª—è —Ñ–æ—Ä–º—É–ª) */
        #sidebar {
            width: 50%; min-width: 480px; overflow-y: auto; padding: 25px;
            background: var(--panel); border-right: 1px solid var(--border);
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 25px;
        }

        #canvas-container {
            flex-grow: 1; position: relative; background: #0f172a; overflow: hidden;
        }

        h1 { margin: 0; font-size: 1.6rem; color: var(--accent); }
        h2 { font-size: 1.2rem; border-bottom: 2px solid var(--accent); padding-bottom: 5px; margin-top: 15px; color: #334155; }
        h3 { font-size: 1rem; margin-bottom: 5px; color: #475569; font-weight: 600; margin-top: 15px;}
        p { font-size: 0.95rem; line-height: 1.6; color: #475569; margin-bottom: 10px; }
        
        .step-box { background: #f1f5f9; border: 1px solid var(--border); border-radius: 8px; padding: 20px; }

        .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        button {
            padding: 8px 14px; border: 1px solid var(--border); border-radius: 6px; 
            cursor: pointer; background: white; font-size: 0.9rem; transition: all 0.2s;
        }
        button:hover { background: #e2e8f0; }
        button.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* –¢–∞–±–ª–∏—Ü—ñ */
        .matrix-wrapper { overflow-x: auto; margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 4px;}
        table { border-collapse: collapse; font-family: monospace; font-size: 0.8rem; width: 100%; background: white; }
        td, th { border: 1px solid #cbd5e1; padding: 4px 8px; text-align: center; }
        th { background: #e2e8f0; font-weight: bold; }
        .highlight-cell { background-color: #fef08a; font-weight: bold; border: 2px solid #f59e0b; } 

        /* –ü–æ—è—Å–Ω–µ–Ω–Ω—è */
        .math-expl { 
            font-size: 0.9rem; background: #fffbeb; padding: 12px; 
            border-left: 4px solid #f59e0b; margin: 10px 0; border-radius: 0 4px 4px 0;
        }
        
        /* 3D Legend */
        #scene-legend {
            position: absolute; top: 15px; right: 15px;
            background: rgba(15, 23, 42, 0.85); color: white;
            padding: 15px; border-radius: 8px; font-size: 0.85rem; 
            pointer-events: none; backdrop-filter: blur(4px);
        }

        .label {
            position: absolute; color: white; font-family: sans-serif; font-size: 11px; font-weight: bold;
            background: rgba(0,0,0,0.7); padding: 3px 6px; border-radius: 4px;
            pointer-events: none; user-select: none; transition: opacity 0.2s;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div>
        <h1>–ê–ª–≥–µ–±—Ä–∞—ó—á–Ω—ñ –º–µ—Ç–æ–¥–∏ –®–Ü: Self-Attention</h1>
		
		
			<details style="margin-top: 20px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden;">
        <summary style="padding: 15px; cursor: pointer; background: #e2e8f0; font-weight: bold; color: #334155; list-style: none; display: flex; align-items: center; justify-content: space-between;">
            <span>üìö –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∏–π –¥–æ–≤—ñ–¥–Ω–∏–∫</span>
            <span style="font-size: 1.2em;">‚ñº</span>
        </summary>
        <div style="padding: 20px; font-size: 0.9rem; color: #334155;">
            
            <h3 style="margin-top:0;">1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ä–µ–∂ –∑ –£–≤–∞–≥–æ—é</h3>
            <p>–ú–µ—Ö–∞–Ω—ñ–∑–º Self-Attention –≤–ø–µ—Ä—à–µ —Å—Ç–∞–≤ –ø–æ–ø—É–ª—è—Ä–Ω–∏–º –Ω–µ –≤ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–∞—Ö, –∞ –≤ RNN (LSTM) –¥–ª—è –º–∞—à–∏–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª–∞–¥—É, —â–æ–± –≤–∏—Ä—ñ—à–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É "–∑–∞–±—É–≤–∞–Ω–Ω—è" –ø–æ—á–∞—Ç–∫—É —Ä–µ—á–µ–Ω–Ω—è. –ê–ª–µ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä (2017) –≤—ñ–¥–º–æ–≤–∏–≤—Å—è –≤—ñ–¥ —Ä–µ–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—ñ (–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏) –Ω–∞ –∫–æ—Ä–∏—Å—Ç—å –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—ó —É–≤–∞–≥–∏.</p>
            <ul>
                <li><b>Attention (–£–≤–∞–≥–∞):</b> –ú–µ—Ö–∞–Ω—ñ–∑–º –ø–æ—à—É–∫—É –∑–≤'—è–∑–∫—ñ–≤ –º—ñ–∂ —É—Å—ñ–º–∞ —Å–ª–æ–≤–∞–º–∏ —Ä–µ—á–µ–Ω–Ω—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ.</li>
                <li><b>Feed-Forward Network (FFN):</b> –ó–≤–∏—á–∞–π–Ω–∞ –Ω–µ–π—Ä–æ–º–µ—Ä–µ–∂–∞, —è–∫–∞ –æ–±—Ä–æ–±–ª—è—î –∫–æ–∂–Ω–µ —Å–ª–æ–≤–æ –æ–∫—Ä–µ–º–æ –ø—ñ—Å–ª—è –±–ª–æ–∫—É —É–≤–∞–≥–∏.</li>
                <li><b>Residual Connection ($x + f(x)$):</b> –î–æ–∑–≤–æ–ª—è—î –≥—Ä–∞–¥—ñ—î–Ω—Ç–∞–º "–ø—Ä–æ—Ç—ñ–∫–∞—Ç–∏" –∫—Ä—ñ–∑—å –≥–ª–∏–±–æ–∫—É –º–µ—Ä–µ–∂—É –±–µ–∑ –∑–≥–∞—Å–∞–Ω–Ω—è.</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 15px 0;">

            <h3>2. –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∏–π –∞–ø–∞—Ä–∞—Ç</h3>
            
            <h4>–°–∫–∞–ª—è—Ä–Ω–∏–π –¥–æ–±—É—Ç–æ–∫ (Dot Product)</h4>
            <p>–£ —Ñ–æ—Ä–º—É–ª—ñ $Q \cdot K^T$ –º–∏ –≤–∏–∫–æ–Ω—É—î–º–æ –º–Ω–æ–∂–µ–Ω–Ω—è –º–∞—Ç—Ä–∏—Ü—å. –Ø–∫—â–æ —Ä–æ–∑–≥–ª—è–¥–∞—Ç–∏ –¥–≤–∞ –≤–µ–∫—Ç–æ—Ä–∏ $a$ —ñ $b$:</p>
            <ul>
                <li><b>–ê–ª–≥–µ–±—Ä–∞—ó—á–Ω–æ:</b> $\sum a_i b_i$ (—Å—É–º–∞ –¥–æ–±—É—Ç–∫—ñ–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç).</li>
                <li><b>–ì–µ–æ–º–µ—Ç—Ä–∏—á–Ω–æ:</b> $|a||b| \cos(\theta)$. –Ø–∫—â–æ –≤–µ–∫—Ç–æ—Ä–∏ –Ω–æ—Ä–º–æ–≤–∞–Ω—ñ ($|a|=|b|=1$), –¥–æ–±—É—Ç–æ–∫ –¥–æ—Ä—ñ–≤–Ω—é—î –∫–æ—Å–∏–Ω—É—Å—É –∫—É—Ç–∞ (Cosine Similarity). 1 = —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å, 0 = –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω—ñ, -1 = –ø—Ä–æ—Ç–∏–ª–µ–∂–Ω—ñ.</li>
                <li><b>–°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–æ:</b> –¶–µ —Å—Ö–æ–∂–µ –Ω–∞ <i>–∫–æ–≤–∞—Ä—ñ–∞—Ü—ñ—é</i>. –í—ñ–Ω –ø–æ–∫–∞–∑—É—î, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ –¥–≤—ñ –∑–º—ñ–Ω–Ω—ñ (—Ä–æ–∑–º—ñ—Ä–Ω–æ—Å—Ç—ñ —Å–ª—ñ–≤) –∑–º—ñ–Ω—é—é—Ç—å—Å—è —Ä–∞–∑–æ–º.</li>
            </ul>

            <h4>Softmax</h4>
            $$ \text{softmax}(z_i) = \frac{e^{z_i}}{\sum_{j} e^{z_j}} $$
            <p>–ï–∫—Å–ø–æ–Ω–µ–Ω—Ç–∞ "—Ä–æ–∑—Ç—è–≥—É—î" —Ä—ñ–∑–Ω–∏—Ü—é: —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à—ñ –∑–Ω–∞—á–µ–Ω–Ω—è —Å—Ç–∞—é—Ç—å –∑–Ω–∞—á–Ω–æ –±—ñ–ª—å—à–∏–º–∏ ("winner takes all"), –∞ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ —Å—É–º–∞ –≤—Å—ñ—Ö –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç–µ–π –¥–æ—Ä—ñ–≤–Ω—é—î 1.</p>

             <h4>–ß–æ–º—É –≤ Attention –¥—ñ–ª–∏–º–æ —Å–∞–º–µ –Ω–∞ $\sqrt{d_k}$?</h4>
            $$ \text{Score} = \frac{Q \cdot K^T}{\sqrt{d_k}} $$
            <p>–ü—Ä–∏–ø—É—Å—Ç—ñ–º–æ, —â–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –≤–µ–∫—Ç–æ—Ä—ñ–≤ $Q$ —ñ $K$ ‚Äî —Ü–µ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ –≤–∏–ø–∞–¥–∫–æ–≤—ñ –≤–µ–ª–∏—á–∏–Ω–∏ –∑ –¥–∏—Å–ø–µ—Ä—Å—ñ—î—é 1.</p>
            <ul>
                <li>–°–∫–∞–ª—è—Ä–Ω–∏–π –¥–æ–±—É—Ç–æ–∫ ‚Äî —Ü–µ —Å—É–º–∞ $d_k$ –ø–æ–ø–∞—Ä–Ω–∏—Ö –¥–æ–±—É—Ç–∫—ñ–≤.</li>
                <li>–î–∏—Å–ø–µ—Ä—Å—ñ—è —Å—É–º–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω–∏—Ö –≤–µ–ª–∏—á–∏–Ω –¥–æ—Ä—ñ–≤–Ω—é—î —Å—É–º—ñ —ó—Ö –¥–∏—Å–ø–µ—Ä—Å—ñ–π. –¢–æ–±—Ç–æ –¥–∏—Å–ø–µ—Ä—Å—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –±—É–¥–µ –¥–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ $d_k$.</li>
                <li>–Ø–∫—â–æ $d_k = 100$, —Ç–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Å–∫–∞–ª—è—Ä–Ω–æ–≥–æ –¥–æ–±—É—Ç–∫—É –±—É–¥—É—Ç—å "—Ä–æ–∑–ª—ñ—Ç–∞—Ç–∏—Å—è" –¥—É–∂–µ –¥–∞–ª–µ–∫–æ (–≤—ñ–¥ -30 –¥–æ 30).</li>
                <li>Softmax –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö —á–∏—Å–µ–ª –¥–∞—î 1 –∞–±–æ 0 (–∑–Ω–∏–∫–∞—é—Ç—å –≥—Ä–∞–¥—ñ—î–Ω—Ç–∏).</li>
                <li>–©–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –¥–∏—Å–ø–µ—Ä—Å—ñ—é –¥–æ 1, —Ç—Ä–µ–±–∞ –ø–æ–¥—ñ–ª–∏—Ç–∏ –Ω–∞ <i>–∫–æ—Ä—ñ–Ω—å</i> –∑ –¥–∏—Å–ø–µ—Ä—Å—ñ—ó <b>(—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è)</b>, —Ç–æ–±—Ç–æ –Ω–∞ $\sqrt{d_k}$.</li>
				</ul>
			
			
                <h4>Layer Normalization (LayerNorm)</h4>
            $$ \text{LN}(x) = \frac{x - \mu}{\sigma} \cdot \gamma + \beta $$
            <p>–¢—É—Ç —î –¥–≤–∞ —Ç–∏–ø–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤:</p>
            <ul>
                <li><b>–°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ (–æ–±—á–∏—Å–ª—é—é—Ç—å—Å—è "–Ω–∞ –ª—å–æ—Ç—É" –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å–ª–æ–≤–∞):</b>
                    <ul>
                        <li>$\mu$ (–º—é) ‚Äî —Å–µ—Ä–µ–¥–Ω—î –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–Ω–µ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –≤–µ–∫—Ç–æ—Ä–∞. –¶–µ–Ω—Ç—Ä—É—î –≤–µ–∫—Ç–æ—Ä –Ω–∞–≤–∫–æ–ª–æ –Ω—É–ª—è.</li>
                        <li>$\sigma$ (—Å—ñ–≥–º–∞) ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è. –ú–∞—Å—à—Ç–∞–±—É—î –≤–µ–∫—Ç–æ—Ä —Ç–∞–∫, —â–æ–± –¥–∏—Å–ø–µ—Ä—Å—ñ—è —Å—Ç–∞–ª–∞ –¥–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ 1.</li>
                    </ul>
                </li>
                <li><b>–ù–∞–≤—á–µ–Ω—ñ (Learnable parameters, —á–∞—Å—Ç–∏–Ω–∞ "–ø–∞–º'—è—Ç—ñ" –º–µ—Ä–µ–∂—ñ):</b>
                    <ul>
                        <li>$\gamma$ (–≥–∞–º–º–∞) ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä –º–∞—Å—à—Ç–∞–±—É. –î–æ–∑–≤–æ–ª—è—î –º–µ—Ä–µ–∂—ñ "—Ä–æ–∑—Ç—è–≥–Ω—É—Ç–∏" –≤–µ–∫—Ç–æ—Ä, —è–∫—â–æ —Ü–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ.</li>
                        <li>$\beta$ (–±–µ—Ç–∞) ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä –∑—Å—É–≤—É. –î–æ–∑–≤–æ–ª—è—î –∑–º—ñ—Å—Ç–∏—Ç–∏ —Ü–µ–Ω—Ç—Ä —Ä–æ–∑–ø–æ–¥—ñ–ª—É.</li>
                    </ul>
                </li>
            </ul>
            <p><i>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è $\gamma$ —ñ $\beta$:</i> –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è ($\mu, \sigma$) –º–æ–∂–µ –∑–Ω–∏—â–∏—Ç–∏ –∫–æ—Ä–∏—Å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é. –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ $\gamma$ —ñ $\beta$ –¥–∞—é—Ç—å –º–µ—Ä–µ–∂—ñ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å–∫–∞—Å—É–≤–∞—Ç–∏ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—é –¥–ª—è –ø–µ–≤–Ω–∏—Ö –æ–∑–Ω–∞–∫, —è–∫—â–æ —Ü–µ –¥–æ–ø–æ–º–∞–≥–∞—î –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É.</p>



            <h4>–í–µ—Ä—Ö–Ω—ñ —ñ–Ω–¥–µ–∫—Å–∏ $W^Q, W^K$</h4>
            <p>–¶–µ –Ω–µ —Å—Ç–µ–ø—ñ–Ω—å! –£ —Ç–µ–Ω–∑–æ—Ä–Ω—ñ–π –∞–ª–≥–µ–±—Ä—ñ —Ü–µ –ø—Ä–æ—Å—Ç–æ –º—ñ—Ç–∫–∞. $W^Q$ –æ–∑–Ω–∞—á–∞—î "–ú–∞—Ç—Ä–∏—Ü—è –≤–∞–≥ –¥–ª—è Query". –ú–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ $W_{query}$.</p>

            <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 15px 0;">

            <h3>3. –ß–∏ –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –æ–∑–Ω–∞–∫?</h3>
            <p>–£ –Ω–∞—à–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ –æ—Å—ñ (–ë—ñ–æ–ª–æ–≥—ñ—è, –ú—É–∑–∏–∫–∞, –ë—é—Ä–æ–∫—Ä–∞—Ç—ñ—è) –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω—ñ. –£ —Ä–µ–∞–ª—å–Ω–∏—Ö LLM:</p>
            <ul>
                <li><b>–ú–∞–π–∂–µ –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å:</b> –£ –ø—Ä–æ—Å—Ç–æ—Ä—ñ –∑ 12,000 –≤–∏–º—ñ—Ä—ñ–≤ –º–æ–∂–Ω–∞ —Ä–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ —Ç–∏—Å—è—á—ñ –º–∞–π–∂–µ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–∏—Ö –≤–µ–∫—Ç–æ—Ä—ñ–≤.</li>
                <li><b>–°—É–ø–µ—Ä–ø–æ–∑–∏—Ü—ñ—è:</b> –û–¥–Ω–µ —Å–ª–æ–≤–æ –º–æ–∂–µ –±—É—Ç–∏ –ª—ñ–Ω—ñ–π–Ω–æ—é –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—î—é –±–∞–≥–∞—Ç—å–æ—Ö —Ç–µ–º. "–û—Ä–≥–∞–Ω" –Ω–µ –ª–µ–∂–∏—Ç—å –Ω–∞ –æ—Å—ñ, –≤—ñ–Ω –º–∞—î –ø—Ä–æ—î–∫—Ü—ñ—ó –Ω–∞ –∫—ñ–ª—å–∫–∞ –æ—Å–µ–π.</li>
                <li><b>–ù–µ—ñ–¥–µ–∞–ª—å–Ω–∞ –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å:</b> –†–µ–∞–ª—å–Ω—ñ –≤–µ–∫—Ç–æ—Ä–∏ —Å–ª—ñ–≤ —É—Ç–≤–æ—Ä—é—é—Ç—å —â—ñ–ª—å–Ω—ñ —Ö–º–∞—Ä–∏, —ñ —Ç–µ–º–∏ —á–∞—Å—Ç–æ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–º–µ–¥–∏—Ü–∏–Ω–∞" —ñ "–±—ñ–æ–ª–æ–≥—ñ—è" –∫–æ—Ä–µ–ª—é—é—Ç—å).</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 15px 0;">

            <h3>4. –Ø–∫ –Ω–∞–≤—á–∞—é—Ç—å—Å—è –º–∞—Ç—Ä–∏—Ü—ñ $W$?</h3>
            <p>–°–ø–æ—á–∞—Ç–∫—É $W^Q, W^K, W^V$ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—é—Ç—å—Å—è –≤–∏–ø–∞–¥–∫–æ–≤–∏–º–∏ —á–∏—Å–ª–∞–º–∏ (–≥–∞—É—Å—ñ–≤—Å—å–∫–∏–π —à—É–º). –£–≤–∞–≥–∞ –ø—Ä–∞—Ü—é—î —Ö–∞–æ—Ç–∏—á–Ω–æ.</p>
            <p>–ü—ñ–¥ —á–∞—Å –Ω–∞–≤—á–∞–Ω–Ω—è (Backpropagation) –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –º–∞—Ç—Ä–∏—Ü—ñ $W^Q, W^K, W^V$:</p>
          
            $$ W_{new} = W_{old} - \eta \cdot \nabla Loss $$
            <ul>
                <li>$\nabla Loss$ (–≥—Ä–∞–¥—ñ—î–Ω—Ç) ‚Äî –≤–µ–∫—Ç–æ—Ä, —â–æ –≤–∫–∞–∑—É—î –Ω–∞–ø—Ä—è–º–æ–∫ –Ω–∞–π—à–≤–∏–¥—à–æ–≥–æ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏. –ú–∏ —Ä—É—Ö–∞—î–º–æ—Å—å —É –ø—Ä–æ—Ç–∏–ª–µ–∂–Ω–∏–π –±—ñ–∫ (–º—ñ–Ω—É—Å).</li>
                <li>$\eta$ (–µ—Ç–∞) ‚Äî <b>Learning Rate</b> (—à–≤–∏–¥–∫—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è). 
                    <br>–¶–µ "—Ä–æ–∑–º—ñ—Ä –∫—Ä–æ–∫—É". –Ø–∫—â–æ $\eta$ –∑–∞–≤–µ–ª–∏–∫–∏–π ‚Äî –º–∏ –ø–µ—Ä–µ—Å—Ç—Ä–∏–±–Ω–µ–º–æ –º—ñ–Ω—ñ–º—É–º. –Ø–∫—â–æ –∑–∞–º–∞–ª–∏–π ‚Äî –±—É–¥–µ–º–æ –≤—á–∏—Ç–∏—Å—è –≤—ñ—á–Ω—ñ—Å—Ç—å.
                </li>
            </ul>
			
			
            <p>–ú–µ—Ä–µ–∂–∞ —Å–∞–º–∞ "—Ä–æ–∑—É–º—ñ—î", —â–æ –¥–ª—è –≥—Ä–∞–º–∞—Ç–∏–∫–∏ —Ç—Ä–µ–±–∞ –æ–¥–Ω–∞ –º–∞—Ç—Ä–∏—Ü—è —É–≤–∞–≥–∏, –∞ –¥–ª—è —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è –æ–º–æ–Ω—ñ–º—ñ—ó ‚Äî —ñ–Ω—à–∞ (Multi-Head Attention).</p>
       
			<hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 15px 0;">

            <h3>5. –û–±—á–∏—Å–ª—é–≤–∞–ª—å–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å </h3>
            <p>–ì–æ–ª–æ–≤–Ω–∏–π –Ω–µ–¥–æ–ª—ñ–∫ Self-Attention ‚Äî —Ü–µ "–∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å" –≤—ñ–¥–Ω–æ—Å–Ω–æ –¥–æ–≤–∂–∏–Ω–∏ –≤—Ö—ñ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É ($N$).</p>
            <ul>
                <li><b>–ú–∞—Ç—Ä–∏—Ü—è –£–≤–∞–≥–∏:</b> –©–æ–± –∫–æ–∂–Ω–µ —Å–ª–æ–≤–æ "–ø–æ–¥–∏–≤–∏–ª–æ—Å—è" –Ω–∞ –∫–æ–∂–Ω–µ —ñ–Ω—à–µ, –º–∏ –æ–±—á–∏—Å–ª—é—î–º–æ –º–∞—Ç—Ä–∏—Ü—é $Attn$ —Ä–æ–∑–º—ñ—Ä–æ–º $N \times N$.</li>
                <li><b>–û–ø–µ—Ä–∞—Ü—ñ—ó:</b> –ú–Ω–æ–∂–µ–Ω–Ω—è $Q$ ($N \times d$) –Ω–∞ $K^T$ ($d \times N$) –≤–∏–º–∞–≥–∞—î $O(N^2 \cdot d)$ –æ–ø–µ—Ä–∞—Ü—ñ–π.</li>
                <li><b>–ü–∞–º'—è—Ç—å:</b> –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –º–∞—Ç—Ä–∏—Ü—ñ $N \times N$ —Ç–µ–∂ –≤–∏–º–∞–≥–∞—î –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ—ó –ø–∞–º'—è—Ç—ñ.</li>
            </ul>
            <p><b>–ù–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ:</b> –Ø–∫—â–æ –≤–∏ –∑–±—ñ–ª—å—à–∏—Ç–µ –¥–æ–≤–∂–∏–Ω—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤ 2 —Ä–∞–∑–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑ 4 —Ç–∏—Å. –¥–æ 8 —Ç–∏—Å. —Ç–æ–∫–µ–Ω—ñ–≤), —á–∞—Å –æ–±—Ä–æ–±–∫–∏ —Ç–∞ —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –ø–∞–º'—è—Ç—ñ –∑—Ä–æ—Å—Ç—É—Ç—å —É <b>4 —Ä–∞–∑–∏</b>. –°–∞–º–µ —Ç–æ–º—É —Å—Ç–∞—Ä—ñ –º–æ–¥–µ–ª—ñ –º–∞–ª–∏ –ª—ñ–º—ñ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—É, —ñ —Å–∞–º–µ —Ç–æ–º—É —Ä–æ–∑—Ä–æ–±–∫–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, <i>FlashAttention</i>) —î –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ—é –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —Ü—ñ–ª–∏–º–∏ –∫–Ω–∏–≥–∞–º–∏.</p>


	   </div>
    </details>
	
		
		
		
		
        <p>–°–∏–º—É–ª—è—Ü—ñ—è –ø—Ä–æ—Ü–µ—Å—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–ª–æ–≤–∞ <b>"–æ—Ä–≥–∞–Ω"</b> —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω—ñ–∑–º —É–≤–∞–≥–∏ —Ç–∞ –∑–∞–ª–∏—à–∫–æ–≤—ñ –∑–≤'—è–∑–∫–∏ (Residual Connections).</p>
    </div>

    <div class="controls">
        <button id="btn1" onclick="setScenario(1)" class="active">–ö–æ–Ω—Ç–µ–∫—Å—Ç 1: –ë—ñ–æ–ª–æ–≥—ñ—è</button>
        <button id="btn2" onclick="setScenario(2)">–ö–æ–Ω—Ç–µ–∫—Å—Ç 2: –ú—É–∑–∏–∫–∞</button>
        <button id="btn3" onclick="setScenario(3)">–ö–æ–Ω—Ç–µ–∫—Å—Ç 3: –ë—é—Ä–æ–∫—Ä–∞—Ç—ñ—è</button>
    </div>
    <p id="current-sentence" style="font-weight: bold; font-style: italic; color: var(--accent); text-align: center; font-size: 1.1rem; margin: 0;">...</p>

    <div class="step-box">
        <h2>1. –í—Ö—ñ–¥–Ω—ñ –ï–º–±–µ–¥–¥—ñ–Ω–≥–∏ ($X$)</h2>
        <p>–ö–æ–∂–Ω–µ —Å–ª–æ–≤–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–µ –≤–µ–∫—Ç–æ—Ä–æ–º. –£ —Ä–µ–∞–ª—å–Ω–∏—Ö LLM (GPT-4, BERT) —Ä–æ–∑–º—ñ—Ä–Ω—ñ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä–∞ ($d_{model}$) —Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ñ–¥ 768 –¥–æ 12288. –î–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 3 –≤–∏–º—ñ—Ä–∏:</p>
        <ul>
            <li><b>$x_1$:</b> –ë—ñ–æ–ª–æ–≥—ñ—á–Ω—ñ—Å—Ç—å</li>
            <li><b>$x_2$:</b> –ú—É–∑–∏—á–Ω—ñ—Å—Ç—å</li>
            <li><b>$x_3$:</b> –ë—é—Ä–æ–∫—Ä–∞—Ç—ñ—è/–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</li>
        </ul>
        <div id="matrix-X" class="matrix-wrapper"></div>
    </div>

    <div class="step-box">
        <h2>2. –ü—Ä–æ—î–∫—Ü—ñ—ó: Query, Key, Value</h2>
        <div class="math-expl">
            –ú–∏ —Å—Ç–≤–æ—Ä—é—î–º–æ —Ç—Ä–∏ –≤–µ—Ä—Å—ñ—ó –∫–æ–∂–Ω–æ–≥–æ —Å–ª–æ–≤–∞, –º–Ω–æ–∂–∞—á–∏ $X$ –Ω–∞ –Ω–∞–≤—á–µ–Ω—ñ –º–∞—Ç—Ä–∏—Ü—ñ –≤–∞–≥ ($W^Q, W^K, W^V$):
            $$ Q = X \cdot W^Q, \quad K = X \cdot W^K, \quad V = X \cdot W^V $$
            <ul>
                <li><b>Query (Q) - –ó–∞–ø–∏—Ç:</b> "–©–æ —è —à—É–∫–∞—é?" (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —ñ–º–µ–Ω–Ω–∏–∫ —à—É–∫–∞—î –ø—Ä–∏–∫–º–µ—Ç–Ω–∏–∫).</li>
                <li><b>Key (K) - –ö–ª—é—á:</b> "–Ø–∫ –º–µ–Ω–µ –∑–Ω–∞–π—Ç–∏/—ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏?" (–º–æ—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—è).</li>
                <li><b>Value (V) - –ó–Ω–∞—á–µ–Ω–Ω—è:</b> "–Ø–∫–∏–π –∑–º—ñ—Å—Ç —è –ø–µ—Ä–µ–¥–∞–º, —è–∫—â–æ –Ω–∞ –º–µ–Ω–µ –∑–≤–µ—Ä–Ω—É—Ç—å —É–≤–∞–≥—É?"</li>
            </ul>
        </div>
        <p><i>–î–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è —É —Ü—ñ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó –º–∞—Ç—Ä–∏—Ü—ñ –≤–∞–≥ $W$ —î –¥—ñ–∞–≥–æ–Ω–∞–ª—å–Ω–∏–º–∏ (–º–∞–π–∂–µ –æ–¥–∏–Ω–∏—á–Ω–∏–º–∏), —Ç–æ–º—É Q, K, V —Å—Ö–æ–∂—ñ –Ω–∞ X.</i></p>
        
        <h3>–ú–∞—Ç—Ä–∏—Ü—è Query (Q)</h3>
        <div id="matrix-Q" class="matrix-wrapper"></div>
        
        <h3>–ú–∞—Ç—Ä–∏—Ü—è Key (K)</h3>
        <div id="matrix-K" class="matrix-wrapper"></div>
    </div>

    <div class="step-box">
        <h2>3. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –£–≤–∞–≥–∏ (Attention)</h2>
        <p>–Ø–¥—Ä–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–∞ ‚Äî —Ü–µ —Ñ–æ—Ä–º—É–ª–∞ <b>Scaled Dot-Product Attention</b>:</p>
        $$ \text{Attention}(Q, K) = \text{softmax}\left(\frac{Q \cdot K^T}{\sqrt{d_k}}\right) $$
        
        <div class="math-expl">
            <b>–ü–æ—è—Å–Ω–µ–Ω–Ω—è —Å–∫–ª–∞–¥–æ–≤–∏—Ö:</b><br>
            1. <b>$Q \cdot K^T$ (–°–∫–∞–ª—è—Ä–Ω–∏–π –¥–æ–±—É—Ç–æ–∫):</b> –¶–µ –º—ñ—Ä–∞ –∫–æ—Ä–µ–ª—è—Ü—ñ—ó. –ì–µ–æ–º–µ—Ç—Ä–∏—á–Ω–æ —Ü–µ $ |a||b|\cos(\theta) $. –ß–∏–º –±—ñ–ª—å—à–µ –≤–µ–∫—Ç–æ—Ä–∏ —Å—Ö–æ–∂—ñ (–≤–∫–∞–∑—É—é—Ç—å –≤ –æ–¥–∏–Ω –±—ñ–∫), —Ç–∏–º –±—ñ–ª—å—à–µ —á–∏—Å–ª–æ. –ú–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ö–æ–∂—ñ—Å—Ç—å –ó–∞–ø–∏—Ç—É —Å–ª–æ–≤–∞ –ê –∑ –ö–ª—é—á–µ–º —Å–ª–æ–≤–∞ –ë.<br>
            2. <b>$\sqrt{d_k}$ (–ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è):</b> –ü—Ä–∏ –≤–µ–ª–∏–∫–∏—Ö —Ä–æ–∑–º—ñ—Ä–Ω–æ—Å—Ç—è—Ö —Å–∫–∞–ª—è—Ä–Ω—ñ –¥–æ–±—É—Ç–∫–∏ —Å—Ç–∞—é—Ç—å –≤–µ–ª–∏—á–µ–∑–Ω–∏–º–∏, —â–æ "–ª–∞–º–∞—î" –≥—Ä–∞–¥—ñ—î–Ω—Ç–∏. –î—ñ–ª–µ–Ω–Ω—è –Ω–∞ –∫–æ—Ä—ñ–Ω—å –∑ —Ä–æ–∑–º—ñ—Ä–Ω–æ—Å—Ç—ñ (—Ç—É—Ç $\sqrt{3} \approx 1.73$) —Å—Ç–∞–±—ñ–ª—ñ–∑—É—î –Ω–∞–≤—á–∞–Ω–Ω—è.<br>
            3. <b>Softmax:</b> –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î "—Å–∏—Ä—ñ" —á–∏—Å–ª–∞ (–ª–æ–≥—ñ—Ç–∏) –Ω–∞ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ. –°—É–º–∞ –∑–Ω–∞—á–µ–Ω—å —É —Ä—è–¥–∫—É —Å—Ç–∞—î 1 (100% —É–≤–∞–≥–∏ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—î—Ç—å—Å—è –º—ñ–∂ —Å–ª–æ–≤–∞–º–∏).
        </div>

        <h3>–ú–∞—Ç—Ä–∏—Ü—è –í–∞–≥ –£–≤–∞–≥–∏ (–ø—ñ—Å–ª—è Softmax):</h3>
        <p>–†—è–¥–æ–∫ –ø–æ–∫–∞–∑—É—î, —è–∫ —Å–ª–æ–≤–æ –∑–ª—ñ–≤–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—î —Å–≤–æ—é —É–≤–∞–≥—É. –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ —Ä—è–¥–æ–∫ <b>"–æ—Ä–≥–∞–Ω"</b>.</p>
        <div id="matrix-Attn" class="matrix-wrapper"></div>
    </div>

    <div class="step-box">
        <h2>4. –ö–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—è (Residual)</h2>
        <div class="math-expl">
            –£ —Å—É—á–∞—Å–Ω–∏—Ö —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–∞—Ö –º–∏ –¥–æ–¥–∞—î–º–æ –∑–Ω–∞–π–¥–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞ (Residual Connection), –∞ –ø–æ—Ç—ñ–º –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ:
             $$ Z_{\text{raw}} = X + (\text{Attention} \cdot V) $$
             $$ Z = \text{LayerNorm}(Z_{\text{raw}}) $$
        </div>
        <p>
            <b>–§—ñ–∑–∏—á–Ω–∏–π –∑–º—ñ—Å—Ç:</b> –í–µ–∫—Ç–æ—Ä $(\text{Attention} \cdot V)$ ‚Äî —Ü–µ "–≤—ñ—Ç–µ—Ä –∑–º—ñ–Ω", —â–æ –¥–º–µ –≤—ñ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É. 
            –°–ª–æ–≤–∞, —è–∫—ñ –≤–ø–µ–≤–Ω–µ–Ω—ñ —É —Å–æ–±—ñ (–∫–æ–Ω—Ç–µ–∫—Å—Ç), –¥–æ–¥–∞—é—Ç—å –¥–æ —Å–µ–±–µ –≤–µ–∫—Ç–æ—Ä–∏, —Å—Ö–æ–∂—ñ –Ω–∞ –Ω–∏—Ö —Å–∞–º–∏—Ö (—Ç–æ–º—É –≤–æ–Ω–∏ –º–∞–π–∂–µ –Ω–µ —Ä—É—Ö–∞—é—Ç—å—Å—è). 
            –°–ª–æ–≤–æ "–æ—Ä–≥–∞–Ω" –æ—Ç—Ä–∏–º—É—î –≤–µ–∫—Ç–æ—Ä –≤—ñ–¥ —Å—É—Å—ñ–¥—ñ–≤, —â–æ –∑–º—ñ—â—É—î –π–æ–≥–æ —É –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä.
        </p>
        <h3>–§—ñ–Ω–∞–ª—å–Ω—ñ –≤–µ–∫—Ç–æ—Ä–∏ (Z):</h3>
        <div id="matrix-Z" class="matrix-wrapper"></div>
    </div>

	
	
</div>

<div id="canvas-container">
    <div id="scene-legend">
        <div style="margin-bottom:5px; font-weight:bold; border-bottom:1px solid #555; padding-bottom:5px;">–ü—Ä–æ—Å—Ç—ñ—Ä –∑–º—ñ—Å—Ç—ñ–≤ $\mathbb{R}^3$</div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <span style="display:inline-block; width:12px; height:12px; background:#16a34a; border-radius:2px;"></span>
            <span>–í—ñ—Å—å X: –ë—ñ–æ–ª–æ–≥—ñ—è</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <span style="display:inline-block; width:12px; height:12px; background:#2563eb; border-radius:2px;"></span>
            <span>–í—ñ—Å—å Y: –ú—É–∑–∏–∫–∞</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <span style="display:inline-block; width:12px; height:12px; background:#db2777; border-radius:2px;"></span>
            <span>–í—ñ—Å—å Z: –ë—é—Ä–æ–∫—Ä–∞—Ç—ñ—è</span>
        </div>
    </div>
    <div id="labels-container"></div>
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- –î–ê–ù–Ü ---
    // –í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ –≤–∞–≥–∏ –¥–ª—è –±—ñ–ª—å—à–æ—ó –ª–æ–≥—ñ—á–Ω–æ—Å—Ç—ñ
    // Format: [Bio(X), Music(Y), Admin(Z)]
    const vocab = {
        "–Ω–µ–ø–∞—Ä–Ω–∏–π":    [0.9, 0.05, 0.05], // –ß–∏—Å—Ç–∞ –±—ñ–æ–ª–æ–≥—ñ—è
        "–æ—Ä–≥–∞–Ω":       [0.35, 0.35, 0.35], // –ù–µ–≤–∏–∑–Ω–∞—á–µ–Ω—ñ—Å—Ç—å (—Ü–µ–Ω—Ç—Ä)
        "–µ–Ω–¥–æ–∫—Ä–∏–Ω–Ω–æ—ó": [0.95, 0.0, 0.05], // Bio
        "—Å–∏—Å—Ç–µ–º–∏":     [0.6, 0.1, 0.6],   // Bio + Admin (—Å–∏—Å—Ç–µ–º–∏ –±—É–≤–∞—é—Ç—å —ñ —Ç–∞–º —ñ —Ç–∞–º)
        "–≤–µ–ª–∏–∫–∏–π":     [0.2, 0.2, 0.2],   // Neutral generic
        "–∑–≤—É—á–∞–≤":      [0.05, 0.95, 0.0], // Music
        "—É—Ä–æ—á–∏—Å—Ç–æ":    [0.0, 0.8, 0.5],   // Music + Admin (—Ü–µ—Ä–µ–º–æ–Ω—ñ—ó)
        "–¥–µ—Ä–∂–∞–≤–Ω–∏–π":   [0.0, 0.0, 0.95],  // Admin
        "—É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è":  [0.05, 0.1, 0.9],  // Admin
        "–æ—Å–≤—ñ—Ç–æ—é":     [0.1, 0.05, 0.85]  // Admin
    };

    const scenarios = {
        1: ["–Ω–µ–ø–∞—Ä–Ω–∏–π", "–æ—Ä–≥–∞–Ω", "–µ–Ω–¥–æ–∫—Ä–∏–Ω–Ω–æ—ó", "—Å–∏—Å—Ç–µ–º–∏"],
        2: ["–≤–µ–ª–∏–∫–∏–π", "–æ—Ä–≥–∞–Ω", "–∑–≤—É—á–∞–≤", "—É—Ä–æ—á–∏—Å—Ç–æ"],
        3: ["–¥–µ—Ä–∂–∞–≤–Ω–∏–π", "–æ—Ä–≥–∞–Ω", "—É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è", "–æ—Å–≤—ñ—Ç–æ—é"]
    };

    // –ú–∞—Ç—Ä–∏—Ü—ñ –≤–∞–≥ (Identity for simplicity in demo, but conceptually present)
    const WQ = [[1,0,0], [0,1,0], [0,0,1]];
    const WK = [[1,0,0], [0,1,0], [0,0,1]];
    const WV = [[1,0,0], [0,1,0], [0,0,1]];

    let currentScenarioId = 1;
    let scene, camera, renderer, controls;
    let spheres = []; 
    let labels = []; 
    
    // --- MATH UTILS ---
    function matMul(A, B) {
        let rowsA = A.length, colsA = A[0].length, colsB = B[0].length;
        let C = Array(rowsA).fill(0).map(() => Array(colsB).fill(0));
        for (let i = 0; i < rowsA; i++) {
            for (let j = 0; j < colsB; j++) {
                for (let k = 0; k < colsA; k++) {
                    C[i][j] += A[i][k] * B[k][j];
                }
            }
        }
        return C;
    }
    
    function addMat(A, B) {
        return A.map((row, i) => row.map((val, j) => val + B[i][j]));
    }

    function transpose(A) { return A[0].map((_, c) => A.map(r => r[c])); }

    function softmax(matrix) {
        return matrix.map(row => {
            let max = Math.max(...row);
            let exps = row.map(x => Math.exp(x - max));
            let sum = exps.reduce((a, b) => a + b, 0);
            return exps.map(x => x / sum);
        });
    }
    
    function normalizeRows(matrix) {
        return matrix.map(row => {
            let mag = Math.sqrt(row.reduce((sum, val) => sum + val*val, 0));
            return (mag === 0) ? row : row.map(x => x / mag); 
        });
    }

    function formatMatrix(matrix, rowLabels, colLabels, highlightIdx = -1) {
        let html = '<table><thead><tr><th></th>';
        if (colLabels) colLabels.forEach(l => html += `<th>${l}</th>`);
        else matrix[0].forEach((_, i) => html += `<th>${i}</th>`);
        html += '</tr></thead><tbody>';
        matrix.forEach((row, i) => {
            const style = (i === highlightIdx) ? 'class="highlight-cell"' : '';
            html += `<tr><th ${style}>${rowLabels ? rowLabels[i] : i}</th>`;
            row.forEach(val => {
                let bg = `rgba(79, 70, 229, ${Math.min(Math.abs(val), 1) * 0.3})`;
                html += `<td style="background:${bg}">${val.toFixed(2)}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        return html;
    }

    // --- LOGIC ---
    function runSimulation() {
        const words = scenarios[currentScenarioId];
        const X = words.map(w => vocab[w]); 
        
        // 1. Projections
        const Q = matMul(X, WQ);
        const K = matMul(X, WK);
        const V = matMul(X, WV);

        // 2. Attention Scores
        const KT = transpose(K);
        let scores = matMul(Q, KT);
        
        // Scaling and Softmax
        const sharpFactor = 0.6; // Tuning parameter for demo visuals
        scores = scores.map(row => row.map(val => val / sharpFactor));
        const attn = softmax(scores);

        // 3. Context Vector (Delta)
        const Delta = matMul(attn, V);

        // 4. Residual + Norm
        const Z_raw = addMat(X, Delta);
        const Z = normalizeRows(Z_raw);

        // --- UI UPDATES ---
        document.getElementById('current-sentence').innerText = `"${words.join(' ')}"`;
        const cols = ["Bio(X)", "Mus(Y)", "Adm(Z)"];
        
        // Render all matrices
        document.getElementById('matrix-X').innerHTML = formatMatrix(X, words, cols);
        document.getElementById('matrix-Q').innerHTML = formatMatrix(Q, words, cols);
        document.getElementById('matrix-K').innerHTML = formatMatrix(K, words, cols);
        document.getElementById('matrix-Attn').innerHTML = formatMatrix(attn, words, words, 1); // Highlight Organ row
        document.getElementById('matrix-Z').innerHTML = formatMatrix(Z, words, cols, 1);

        // Update 3D
        update3DScene(words, X, Z);
        
        // Refresh MathJax
        if(window.MathJax) MathJax.typeset();
    }

    // --- 3D SCENE ---
    function init3D() {
        const container = document.getElementById('canvas-container');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f172a);

        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.set(3, 2.5, 4); 
        camera.lookAt(0.5, 0.5, 0.5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0.5, 0.5, 0.5);

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dl = new THREE.DirectionalLight(0xffffff, 1);
        dl.position.set(5, 10, 7);
        scene.add(dl);

        // Custom Axes
        const axesMaterial = new THREE.LineBasicMaterial({ vertexColors: true, linewidth: 3 });
        const axesPoints = [
            new THREE.Vector3(0,0,0), new THREE.Vector3(3,0,0), // X
            new THREE.Vector3(0,0,0), new THREE.Vector3(0,3,0), // Y
            new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,3)  // Z
        ];
        const axesGeometry = new THREE.BufferGeometry().setFromPoints(axesPoints);
        // Colors: Green(Bio), Blue(Music), Pink(Admin)
        const colors = [
            0.086, 0.639, 0.290,  0.086, 0.639, 0.290, // Bio
            0.145, 0.388, 0.921,  0.145, 0.388, 0.921, // Music
            0.858, 0.152, 0.466,  0.858, 0.152, 0.466  // Admin
        ];
        axesGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        const axesLines = new THREE.LineSegments(axesGeometry, axesMaterial);
        scene.add(axesLines);

        window.addEventListener('resize', onWindowResize);
        animate();
    }

    function update3DScene(words, startVecs, endVecs) {
        spheres.forEach(obj => scene.remove(obj));
        spheres = [];
        const labelCont = document.getElementById('labels-container');
        labelCont.innerHTML = '';
        labels = [];

        words.forEach((w, i) => {
            const geo = new THREE.SphereGeometry(0.06, 32, 32);
            
            // Calculate color based on FINAL position
            const v = endVecs[i];
            const colBio = new THREE.Color(0x16a34a);
            const colMusic = new THREE.Color(0x2563eb);
            const colAdmin = new THREE.Color(0xdb2777);
            
            let color = new THREE.Color(0x000000);
            color.add(colBio.multiplyScalar(v[0]));
            color.add(colMusic.multiplyScalar(v[1]));
            color.add(colAdmin.multiplyScalar(v[2]));

            const isOrgan = w.includes("–æ—Ä–≥–∞–Ω");
            
            const mat = new THREE.MeshStandardMaterial({ 
                color: isOrgan ? 0xffffff : color,
                roughness: 0.4, metalness: 0.1
            });
            
            const mesh = new THREE.Mesh(geo, mat);
            
            // Scale positions for visualization space
            const s = startVecs[i];
            const e = endVecs[i];
            mesh.position.set(s[0]*1.8, s[1]*1.8, s[2]*1.8);
            
            mesh.userData = {
                start: mesh.position.clone(),
                end: new THREE.Vector3(e[0]*1.8, e[1]*1.8, e[2]*1.8),
                finalColor: color,
                isDynamic: isOrgan
            };

            scene.add(mesh);
            spheres.push(mesh);

            // Label
            const el = document.createElement('div');
            el.className = 'label';
            el.textContent = w;
            if (isOrgan) el.style.border = "1px solid rgba(255,255,255,0.5)";
            labelCont.appendChild(el);
            labels.push(el);
        });
        
        animationTime = 0;
    }

    let animationTime = 0;

    function animate() {
        requestAnimationFrame(animate);
        controls.update();

        // Animation Loop
        if (animationTime < 1) {
            animationTime += 0.01; // Slower animation
            spheres.forEach(s => {
                s.position.lerpVectors(s.userData.start, s.userData.end, animationTime);
                if(s.userData.isDynamic) {
                    s.material.color.lerp(s.userData.finalColor, 0.02);
                }
            });
        }

        updateLabels();
        renderer.render(scene, camera);
    }

    function updateLabels() {
        const container = document.getElementById('canvas-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        let points = [];

        spheres.forEach((mesh, i) => {
            const v = mesh.position.clone();
            v.project(camera); 
            if (v.z > 1) {
                labels[i].style.opacity = 0;
                return;
            } else {
                labels[i].style.opacity = 1;
            }
            const x = (v.x * .5 + .5) * width;
            const y = -(v.y * .5 - .5) * height;
            points.push({ id: i, x: x, y: y, el: labels[i] });
        });

        // Repulsion Logic
        for(let iter=0; iter<8; iter++) {
            for(let i=0; i<points.length; i++) {
                for(let j=i+1; j<points.length; j++) {
                    let dx = points[i].x - points[j].x;
                    let dy = points[i].y - points[j].y;
                    let distSq = dx*dx + dy*dy;
                    let minDist = 35; 

                    if (distSq < minDist*minDist) {
                        let dist = Math.sqrt(distSq);
                        let overlap = minDist - dist;
                        let angle = Math.atan2(dy, dx);
                        let moveX = Math.cos(angle) * overlap * 0.5;
                        let moveY = Math.sin(angle) * overlap * 0.5;
                        points[i].x += moveX; points[i].y += moveY;
                        points[j].x -= moveX; points[j].y -= moveY;
                    }
                }
            }
        }
        points.forEach(p => {
            p.el.style.transform = `translate(${p.x}px, ${p.y}px)`;
        });
    }

    function onWindowResize() {
        const c = document.getElementById('canvas-container');
        camera.aspect = c.clientWidth / c.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(c.clientWidth, c.clientHeight);
    }

    window.setScenario = function(id) {
        currentScenarioId = id;
        document.querySelectorAll('.controls button').forEach((b, i) => {
            b.className = (i+1 === id) ? 'active' : '';
        });
        runSimulation();
    }

    init3D();
    runSimulation();

</script>
</body>
</html>