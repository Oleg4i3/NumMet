<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BnB: Bin Packing</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #d35400;
            --success: #27ae60;
            --danger: #c0392b;
            --backtrack: #7f8c8d;
            --bg: #f8f9fa;
            --highlight-rule: #f1c40f;
        }
        body { font-family: 'Verdana', sans-serif; background: var(--bg); padding: 20px; max-width: 1200px; margin: 0 auto; color: #333; }
        
        /* Grid Layout */
        .main-wrapper { display: grid; grid-template-columns: 350px 1fr; gap: 20px; align-items: start; }
        @media (max-width: 900px) { .main-wrapper { grid-template-columns: 1fr; } }

        /* Panels */
        .panel { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #ddd; }
        
        /* Rules Sidebar */
        .rules-box { font-size: 13px; line-height: 1.4; background: #eef2f3; border-left: 5px solid var(--primary); }
        .rules-list { padding-left: 20px; margin: 5px 0; }
        .rules-list li { margin-bottom: 8px; padding: 4px; border-radius: 4px; transition: 0.3s; color: #555; }
        .rules-list li.active { background: #ffeaa7; color: black; font-weight: bold; border-left: 4px solid #f39c12; transform: scale(1.02); }

        .metrics-box { background: #e8f8f5; border: 2px dashed var(--success); text-align: center; padding: 10px; margin-bottom: 15px; border-radius: 8px; }
        .metric-val { font-size: 18px; font-weight: bold; color: var(--success); }

        /* Academic Note Styles */
        .academic-note {
            background: #fff; border: 1px solid #ccc; border-radius: 8px; margin-top: 15px; font-family: 'Georgia', serif;
        }
        .academic-note summary {
            padding: 10px; cursor: pointer; background: #f1f2f6; border-radius: 8px; font-weight: bold; color: var(--primary);
        }
        .academic-note summary:hover { background: #e2e6ea; }
        .academic-content { padding: 15px; font-size: 14px; line-height: 1.6; color: #444; border-top: 1px solid #ddd; }
        .math-block { background: #f9f9f9; padding: 5px; border-left: 3px solid #bdc3c7; margin: 5px 0; font-style: italic; }

        /* Game Area */
        .box {
            display: inline-flex; justify-content: center; align-items: center;
            width: 36px; height: 36px; background: var(--accent); color: white;
            font-weight: bold; border-radius: 6px; border: 2px solid #a04000; margin: 3px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.1); font-size: 14px; cursor: grab; user-select: none;
        }
        .box.active-item { transform: scale(1.3); background: #e67e22; border-color: #f1c40f; z-index: 100; box-shadow: 0 0 15px rgba(241, 196, 15, 0.6); }
        .box.dragging { opacity: 0.5; }

        .truck-container { display: flex; flex-wrap: wrap; gap: 10px; min-height: 160px; align-items: flex-start; margin-top: 20px; }
        .truck {
            width: 80px; min-height: 140px; background: #ecf0f1; border: 3px dashed #bdc3c7;
            border-radius: 0 0 10px 10px; border-top: none; position: relative;
            display: flex; flex-direction: column-reverse; align-items: center; padding-bottom: 5px;
            transition: 0.3s;
        }
        .truck.target { border-color: var(--primary); background: #dfe6e9; box-shadow: 0 0 15px rgba(44, 62, 80, 0.2); transform: scale(1.05); }
        .truck-label { position: absolute; top: -25px; width: 100%; text-align: center; font-size: 11px; font-weight: bold; color: #7f8c8d; }
        .truck-fill { width: 100%; background: var(--success); opacity: 0.3; position: absolute; bottom: 0; left: 0; transition: height 0.3s; pointer-events: none; }
        .truck-info { position: absolute; bottom: -20px; font-size: 10px; font-weight: bold; width: 100%; text-align: center; }

        /* Controls */
        button { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; margin: 2px; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        button.preset-btn { background: #8e44ad; }
        button.finish-btn { background: #27ae60; }
        
        .progress-bar { height: 6px; background: #eee; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }
        
        .narrative-box { font-size: 15px; min-height: 80px; padding: 10px; background: #fffde7; border: 1px solid #f9e79f; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<h2 style="text-align: center; margin: 10px 0;">–ú–µ—Ç–æ–¥ –º–µ–∂ —ñ –≥—ñ–ª–æ–∫ (BnB): –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ü–∞–∫—É–≤–∞–Ω–Ω—è (Bin Packing)</h2>

<div class="panel" style="text-align: center; padding: 10px;">
    <div style="margin-bottom: 8px;">
        <button class="preset-btn" onclick="loadPreset()">üìå –ü—Ä–µ—Å–µ—Ç (6, 5, 4...)</button>
        <button onclick="generateRandom()">üé≤ –í–∏–ø–∞–¥–∫–æ–≤—ñ</button>
        <button onclick="resetGame()">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
    </div>
    <div style="font-size: 14px;">
        –í–∞–Ω—Ç–∞–∂—ñ: <b id="items-display">[]</b> | –ú—ñ—Å—Ç–∫—ñ—Å—Ç—å: <b style="color:var(--danger)" id="cap-display">10</b>
    </div>
</div>

<div class="main-wrapper">
    
    <div>
        <div class="panel metrics-box">
            <div> –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∏–π –º—ñ–Ω—ñ–º—É–º (–ú–ï–ñ–ê): <span id="theory-min" class="metric-val">-</span> –º–∞—à.</div>
            <div style="font-size: 14px; color: #955;">(–°—É–º–∞ –≤–∞–≥–∏ / –ú—ñ—Å—Ç–∫—ñ—Å—Ç—å)</div>
            <hr style="border:0; border-top:1px dashed #ccc; margin:5px 0;">
            <div> –ü–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∫–æ—Ä–¥: <span id="best-record" class="metric-val">?</span> –º–∞—à.</div>
        </div>

        <div class="panel rules-box">
            <h4 style="margin:0 0 10px 0;">–ü–†–û–ì–†–ê–ú–ê –î–Ü–ô (–ê–õ–ì–û–†–ò–¢–ú):</h4>
            <ol class="rules-list">
                <li id="rule-0"><b>–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞:</b> –°–æ—Ä—Ç—É—é –≤–∞–Ω—Ç–∞–∂—ñ (–≤—ñ–¥ –≤–µ–ª–∏–∫–∏—Ö –¥–æ –º–∞–ª–∏—Ö). –†–∞—Ö—É—é –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –º–æ–∂–ª–∏–≤—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –º–∞—à–∏–Ω (Lower Bound).</li>
                <li id="rule-1"><b>–î—ñ—è:</b> –ë–µ—Ä—É –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ—Ä–æ–±–∫—É. –ü–µ—Ä–µ–≤—ñ—Ä—è—é –º–∞—à–∏–Ω–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ —á–µ—Ä–∑—ñ (‚Ññ1, ‚Ññ2...).</li>
                <li id="rule-2"><b>–ü—Ä–∞–≤–∏–ª–æ "–ü–µ—Ä—à–∞ –ø—ñ–¥—Ö–æ–¥—è—â–∞":</b> –Ø–∫—â–æ –≤–ª—ñ–∑–ª–∞ ‚Äî –∑–∞–ª–∏—à–∞—é —ñ –±–µ—Ä—É –Ω–∞—Å—Ç—É–ø–Ω—É. –ù–µ —à—É–∫–∞—é —ñ–¥–µ–∞–ª –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑.</li>
                <li id="rule-3"><b>–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è (–ê–Ω—Ç–∏-–¥—É–±–ª—å):</b> –Ø–∫—â–æ –ú–∞—à–∏–Ω–∞ –ê —ñ –ú–∞—à–∏–Ω–∞ –ë –æ–¥–Ω–∞–∫–æ–≤–æ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ, —è –Ω–µ –±—É–¥—É –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –ë, —è–∫—â–æ –ê –Ω–µ –ø—ñ–¥—ñ–π—à–ª–∞.</li>
                <li id="rule-4"><b>–ù–æ–≤–∞ –º–∞—à–∏–Ω–∞:</b> –Ø–∫—â–æ –Ω—ñ–∫—É–¥–∏ –Ω–µ –ª—ñ–∑–µ ‚Äî –±–µ—Ä—É –Ω–æ–≤—É.</li>
                <li id="rule-5"><b>–í—ñ–¥—Å—ñ–∫–∞–Ω–Ω—è:</b> –Ø–∫—â–æ —è –±–∞—á—É, —â–æ –ø–æ—Ç–æ—á–Ω–∏–π —à–ª—è—Ö –≤–∂–µ –≥—ñ—Ä—à–∏–π –∑–∞ –∑–Ω–∞–π–¥–µ–Ω–∏–π —Ä–µ–∫–æ—Ä–¥ ‚Äî –∑—É–ø–∏–Ω—è—é—Å—å. –¶–µ —ñ —î –≥—ñ–ª–∫–∞ (–¥–µ—Ä–µ–≤–∞ —Ä—ñ—à–µ–Ω—å), —â–æ –≤—ñ–¥—Å—ñ–∫–∞—î—Ç—å—Å—è, –∑–º–µ–Ω—à—É—é—á–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫—Ä–æ–∫—ñ–≤</li>
                <li id="rule-6"><b>–í–Ü–î–ö–ê–¢:</b> (–ö–æ–ª–∏ —è –∑–º—ñ–Ω—é—é —Ä—ñ—à–µ–Ω–Ω—è) –ö–æ–ª–∏ —è –¥—ñ–π—à–æ–≤ –¥–æ –∫—ñ–Ω—Ü—è —ñ –∑–∞–ø–∞–∫—É–≤–∞–≤ —É—Å–µ, —è –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ—Ç—ñ–º —è –ø–æ–≤–µ—Ä—Ç–∞—é—Å—å –Ω–∞–∑–∞–¥, <b>–≤–∏–π–º–∞—é –æ—Å—Ç–∞–Ω–Ω—é –∫–æ—Ä–æ–±–∫—É</b> —ñ –ø—Ä–æ–±—É—é –ø–æ–∫–ª–∞—Å—Ç–∏ —ó—ó –≤ –ù–ê–°–¢–£–ü–ù–£ –º–∞—à–∏–Ω—É (–≤ —è–∫—É —â–µ –Ω–µ –ø—Ä–æ–±—É–≤–∞–≤).</li>
            </ol>
        </div>

        <details class="academic-note">
            <summary>üéì –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞</summary>
            <div class="academic-content">
                <p><b>–ó–∞–¥–∞—á–∞ –æ–¥–Ω–æ–≤–∏–º—ñ—Ä–Ω–æ–≥–æ –ø–∞–∫—É–≤–∞–Ω–Ω—è (1BP)</b> ‚Äî —Ü–µ –∫–ª–∞—Å–∏—á–Ω–∞ –∑–∞–¥–∞—á–∞ –∫–æ–º–±—ñ–Ω–∞—Ç–æ—Ä–Ω–æ—ó –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó. </p>
                <div class="math-block">
                    –ú–µ—Ç–∞: —Ä–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ <i>n</i> –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –∑ –≤–∞–≥–∞–º–∏ <i>w<sub>1</sub>...w<sub>n</sub></i> —É –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ —î–º–Ω—ñ—Å—Ç—é <i>C</i>.
                </div>
                <p><b>–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:</b> –ó–∞–¥–∞—á–∞ —î <b>NP-hard</b>. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –Ω–µ —ñ—Å–Ω—É—î –≤—ñ–¥–æ–º–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É, —è–∫–∏–π –≤–∏—Ä—ñ—à—É–≤–∞–≤ –±–∏ —ó—ó –∑–∞ –ø–æ–ª—ñ–Ω–æ–º—ñ–∞–ª—å–Ω–∏–π —á–∞—Å –¥–ª—è –±—É–¥—å-—è–∫–∏—Ö –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö. </p>
                <p><b>–ê–ª–≥–æ—Ä–∏—Ç–º –ì—ñ–ª–æ–∫ —Ç–∞ –ú–µ–∂ (Branch and Bound):</b></p>
                <ul>
                    <li><b>Branch (–ì—ñ–ª–∫—É–≤–∞–Ω–Ω—è):</b> –†–æ–∑–±–∏—Ç—Ç—è –∑–∞–¥–∞—á—ñ –Ω–∞ –ø—ñ–¥–∑–∞–¥–∞—á—ñ (–¥–µ—Ä–µ–≤–æ —Ä—ñ—à–µ–Ω—å), –¥–µ –∫–æ–∂–µ–Ω –≤—É–∑–æ–ª ‚Äî —Ü–µ —Å–ø—Ä–æ–±–∞ –ø–æ–∫–ª–∞—Å—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç —É –ø–µ–≤–Ω—É –º–∞—à–∏–Ω—É.</li>
                    <li><b>Bound (–ú–µ–∂—ñ):</b> –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –æ—Ü—ñ–Ω–æ–∫ (Lower Bound), —â–æ–± –¥–æ–≤–µ—Å—Ç–∏, —â–æ –ø–æ—Ç–æ—á–Ω–∞ –≥—ñ–ª–∫–∞ –Ω–µ –º–æ–∂–µ –¥–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫—Ä–∞—â–∏–π –∑–∞ –≤–∂–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π, —ñ –≤—ñ–¥—Å—ñ–∫—Ç–∏ —ó—ó (pruning).</li>
                </ul>
                <p><b>–û—Ü—ñ–Ω–∫–∞ (Lower Bound):</b> –≤–∏–∑–Ω–∞—á–∞—î —Ç–µ–æ—Ä–µ—Ç–∏—á–Ω–∏–π –º—ñ–Ω—ñ–º—É–º  - —Ü–µ —Å—É–º–∞ –≤–∞–≥ –¥—ñ–ª–µ–Ω–∞ –Ω–∞ —î–º–Ω—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–æ–∫—Ä—É–≥–ª–µ–Ω–æ –≤–≥–æ—Ä—É –¥–æ —Ü—ñ–ª–æ–≥–æ).</p>
            </div>
        </details>
    </div>

    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">–°–∫–ª–∞–¥ & –ê–≤—Ç–æ–ø–∞—Ä–∫</h3>
            <div>
                <button class="secondary" onclick="runSolver()" id="btn-start"> –ó–∞–ø—É—Å–∫ –ê–ª–≥–æ—Ä–∏—Ç–º—É</button>
            </div>
        </div>

        <div style="min-height: 50px; margin-top:15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <span style="font-size:12px; color:#7f8c8d; font-weight:bold;">–ß–ï–†–ì–ê (–ö–æ–Ω–≤–µ—î—Ä):</span>
            <div id="queue-area" style="display: flex; gap: 5px; flex-wrap: wrap; padding: 5px;"></div>
        </div>

        <div id="trucks-area" class="truck-container"></div>

        <div class="narrative-box" id="narrative">
            –ó–∞—Ä–∞–∑ –ø—Ä–∞—Ü—é—î <b>–†—É—á–Ω–∏–π —Ä–µ–∂–∏–º</b>. 
            –í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞—Ç–∏ –∫–æ—Ä–æ–±–∫–∏ –º–∏—à–∫–æ—é. <br>
            –ö–æ–ª–∏ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ñ, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å <b>"–ó–∞–ø—É—Å–∫ –ê–ª–≥–æ—Ä–∏—Ç–º—É"</b>, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏, —è–∫ —Ü–µ —Ä–æ–±–∏—Ç—å –∫–æ–º–ø'—é—Ç–µ—Ä.
        </div>

        <div style="margin-top: 15px;">
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top:5px;">
                <button id="btn-prev" onclick="stepper(-1)" disabled>‚è™ –ù–∞–∑–∞–¥</button>
                <span id="step-counter" style="font-size: 12px; font-weight:bold; color:#7f8c8d;">0 / 0</span>
                <div>
                    <button id="btn-next" onclick="stepper(1)" disabled>–í–ø–µ—Ä–µ–¥ ‚è©</button>
                    <button id="btn-finish" class="finish-btn" onclick="jumpToEnd()" disabled>‚è≠ –î–æ –∫—ñ–Ω—Ü—è</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let CAPACITY = 10;
    let itemsData = [];
    let trucks = []; // –î–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
    
    // –ê–ª–≥–æ—Ä–∏—Ç–º—ñ—á–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
    let steps = [];
    let currentStep = -1;
    let bestSolution = Infinity;
    let bestBins = []; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –Ω–∞–π–∫—Ä–∞—â–æ–≥–æ —Ä—ñ—à–µ–Ω–Ω—è
    let stopAlgorithm = false;
    let theoreticalMin = 0;

    // --- INIT & MANUAL MODE ---
    function loadPreset() {
        CAPACITY = 10;
        initGame([6, 5, 4, 4, 3, 3, 3, 2]);
    }

    function generateRandom() {
        CAPACITY = 10;
        let arr = Array.from({length: 12}, () => Math.floor(Math.random() * 6) + 2);
        initGame(arr);
    }

    function resetGame() {
        initGame(itemsData.map(i => i.w));
    }

    function initGame(weights) {
        // –°–∫–∏–¥–∞–Ω–Ω—è UI
        itemsData = weights.map((w, i) => ({ id: i, w: w }));
        document.getElementById('items-display').innerText = `[${weights.join(', ')}]`;
        document.getElementById('cap-display').innerText = CAPACITY;
        
        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –º–µ—Ç—Ä–∏–∫
        let sum = weights.reduce((a, b) => a + b, 0);
        theoreticalMin = Math.ceil(sum / CAPACITY);
        document.getElementById('theory-min').innerText = theoreticalMin;
        document.getElementById('best-record').innerText = "?";
        
        // –°–∫–∏–¥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –∞–ª–≥–æ—Ä–∏—Ç–º—É
        steps = [];
        bestBins = [];
        currentStep = -1;
        document.getElementById('btn-prev').disabled = true;
        document.getElementById('btn-next').disabled = true;
        document.getElementById('btn-finish').disabled = true;
        document.getElementById('btn-start').disabled = false;
        document.getElementById('progress').style.width = '0%';
        document.getElementById('step-counter').innerText = "0 / 0";
        highlightRule(-1);

        // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
        document.getElementById('narrative').innerHTML = "<b>–†—É—á–Ω–∏–π —Ä–µ–∂–∏–º:</b> –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å –∫–æ—Ä–æ–±–∫–∏ –≤ –º–∞—à–∏–Ω–∏";
        renderManualMode();
    }

    // --- MANUAL DRAG & DROP RENDERER ---
    function renderManualMode() {
        const queueEl = document.getElementById('queue-area');
        const trucksEl = document.getElementById('trucks-area');
        queueEl.innerHTML = '';
        trucksEl.innerHTML = '';

        itemsData.forEach(item => {
            let box = createBoxEl(item.w, item.id);
            box.draggable = true;
            box.ondragstart = (e) => { e.dataTransfer.setData("text", JSON.stringify({id: item.id, w: item.w})); };
            queueEl.appendChild(box);
        });

        for(let i=0; i<3; i++) {
            trucksEl.appendChild(createManualTruck(i));
        }
        let addBtn = document.createElement('button');
        addBtn.innerText = "+";
        addBtn.onclick = () => { trucksEl.insertBefore(createManualTruck(document.querySelectorAll('.truck').length), addBtn); };
        trucksEl.appendChild(addBtn);
    }

    function createBoxEl(w, id) {
        let d = document.createElement('div');
        d.className = 'box';
        d.innerText = w;
        d.id = 'box-'+id;
        return d;
    }

    function createManualTruck(id) {
        let t = document.createElement('div');
        t.className = 'truck';
        t.dataset.load = 0;
        t.innerHTML = `<div class="truck-label">#${id+1}</div><div class="truck-fill"></div>`;
        
        t.ondragover = (e) => e.preventDefault();
        t.ondrop = (e) => {
            e.preventDefault();
            let data = JSON.parse(e.dataTransfer.getData("text"));
            let currentLoad = parseInt(t.dataset.load);
            
            if (currentLoad + data.w <= CAPACITY) {
                let originalBox = document.getElementById('box-'+data.id);
                if(originalBox) originalBox.remove(); 
                
                let newBox = createBoxEl(data.w, data.id);
                newBox.draggable = false;
                t.appendChild(newBox);
                
                let newLoad = currentLoad + data.w;
                t.dataset.load = newLoad;
                t.querySelector('.truck-fill').style.height = (newLoad/CAPACITY)*100 + '%';
            } else {
                alert('–ù–µ –ª—ñ–∑–µ!');
            }
        };
        return t;
    }

    // --- ALGORITHM SOLVER ---
    
    function runSolver() {
        // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è (–í–∞–∂–ª–∏–≤–∞ –µ–≤—Ä–∏—Å—Ç–∏–∫–∞)
        itemsData.sort((a, b) => b.w - a.w);
        
        steps = [];
        bestSolution = itemsData.length + 1;
        bestBins = [];
        stopAlgorithm = false;

        // –ö—Ä–æ–∫ 0: –ü–ª–∞–Ω
        steps.push({
            msg: `üîç <b>–°—Ç–∞—Ä—Ç:</b> –í–∞–Ω—Ç–∞–∂—ñ –≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω–æ. –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∏–π –º—ñ–Ω—ñ–º—É–º = <b>${theoreticalMin}</b> –º–∞—à–∏–Ω.<br>–Ø–∫—â–æ —è –∑–Ω–∞–π–¥—É —Ä—ñ—à–µ–Ω–Ω—è –Ω–∞ ${theoreticalMin} –º–∞—à–∏–Ω, —è –∑—É–ø–∏–Ω—é—Å—å, –±–æ –∫—Ä–∞—â–µ –Ω–µ –±—É–≤–∞—î.`,
            bins: [], itemIdx: -1, rule: 0, best: "?"
        });

        solve(0, []);

        if(stopAlgorithm && bestBins.length > 0) {
             // –Ø–∫—â–æ –º–∏ –∑—É–ø–∏–Ω–∏–ª–∏—Å—å –¥–æ—Å—Ç—Ä–æ–∫–æ–≤–æ (—ñ–¥–µ–∞–ª), –º–∏ –≤–∂–µ –∑–∞–ø–∏—Å–∞–ª–∏ –∫—Ä–æ–∫.
             // –ê–ª–µ –ø—Ä–æ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —Ñ—ñ–Ω–∞–ª
        } 
        else if (bestBins.length > 0) {
            // –î–æ–¥–∞—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∫—Ä–æ–∫ –∑ –Ω–∞–π–∫—Ä–∞—â–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
            steps.push({
                msg: `üèÜ <b>–§–Ü–ù–Ü–®:</b> –ü–æ—à—É–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –û—Å—å –Ω–∞–π–∫—Ä–∞—â–µ –∑–Ω–∞–π–¥–µ–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è: <b>${bestSolution}</b> –º–∞—à–∏–Ω.`,
                bins: clone(bestBins), itemIdx: itemsData.length, rule: 5, best: bestSolution, type: 'perfect'
            });
        } else {
             steps.push({
                msg: `üèÅ <b>–ö—ñ–Ω–µ—Ü—å:</b> –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è (—â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫).`,
                bins: [], itemIdx: -1, rule: 0, best: bestSolution
            });
        }

        // –ó–∞–ø—É—Å–∫ UI
        currentStep = 0;
        document.getElementById('btn-start').disabled = true;
        document.getElementById('btn-next').disabled = false;
        document.getElementById('btn-prev').disabled = false;
        document.getElementById('btn-finish').disabled = false;
        updateUI();
    }

    function solve(itemIdx, currentBins) {
        if (stopAlgorithm) return;

        // 1. –ü–ï–†–ï–í–Ü–†–ö–ê –ù–ê –ó–ê–í–ï–†–®–ï–ù–ù–Ø
        if (itemIdx === itemsData.length) {
            if (currentBins.length < bestSolution) {
                bestSolution = currentBins.length;
                bestBins = clone(currentBins); // –ó–ë–ï–†–Ü–ì–ê–Ñ–ú–û –ö–†–ê–©–£ –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Æ
                
                steps.push({
                    msg: `üéâ <b>–†–ï–ö–û–†–î!</b> –í—Å–µ –≤–º—ñ—Å—Ç–∏–ª–æ—Å—è —É <b>${bestSolution}</b> –º–∞—à–∏–Ω. <br>–ó–±–µ—Ä—ñ–≥–∞—é —Ü–µ–π –≤–∞—Ä—ñ–∞–Ω—Ç. –ß–∏ –º–æ–∂–Ω–∞ –∫—Ä–∞—â–µ? –ó–∞—Ä–∞–∑ –∑—Ä–æ–±–ª—é –≤—ñ–¥–∫–∞—Ç —ñ –ø–µ—Ä–µ–≤—ñ—Ä—é.`,
                    bins: clone(currentBins), itemIdx: itemIdx, rule: 6, best: bestSolution, type: 'record'
                });
                
                // –°—É–ø–µ—Ä-–≤—ñ–¥—Å—ñ–∫–∞–Ω–Ω—è: —è–∫—â–æ –¥–æ—Å—è–≥–ª–∏ —Ç–µ–æ—Ä–µ—Ç–∏—á–Ω–æ–≥–æ –º—ñ–Ω—ñ–º—É–º—É
                if (bestSolution === theoreticalMin) {
                    steps.push({
                        msg: `‚ú® <b>–Ü–î–ï–ê–õ!</b> –ú–∏ –¥–æ—Å—è–≥–ª–∏ —Ç–µ–æ—Ä–µ—Ç–∏—á–Ω–æ–≥–æ –º—ñ–Ω—ñ–º—É–º—É (${theoreticalMin}). –ö—Ä–∞—â–µ –Ω–µ–º–æ–∂–ª–∏–≤–æ. <br>–ó—É–ø–∏–Ω—è—é –ø–æ—à—É–∫.`,
                        bins: clone(currentBins), itemIdx: itemIdx, rule: 5, best: bestSolution, type: 'perfect'
                    });
                    stopAlgorithm = true;
                }
            }
            return;
        }

        let item = itemsData[itemIdx];

        // 2. –í–Ü–î–°–Ü–ö–ê–ù–ù–Ø (PRUNING) - Bound
        let currentLoadSum = currentBins.reduce((a,b) => a+b.load, 0);
        let remainingWeight = itemsData.slice(itemIdx).reduce((a,b) => a+b.w, 0);
        let minPossibleTotal = Math.max(currentBins.length, Math.ceil((currentLoadSum + remainingWeight)/CAPACITY));

        if (minPossibleTotal >= bestSolution) {
            steps.push({
                msg: `üõë <b>–°–¢–û–ü (–í—ñ–¥—Å—ñ–∫–∞–Ω–Ω—è):</b> –Ø –ø–æ—Ä–∞—Ö—É–≤–∞–≤, —â–æ —Ü–∏–º —à–ª—è—Ö–æ–º –≤–∏–π–¥–µ –º—ñ–Ω—ñ–º—É–º <b>${minPossibleTotal}</b> –º–∞—à–∏–Ω. <br>–ê–ª–µ —É –Ω–∞—Å –≤–∂–µ —î —Ä–µ–∫–æ—Ä–¥ <b>${bestSolution}</b>. –í–µ—Ä—Ç–∞—é—Å—å –Ω–∞–∑–∞–¥!`,
                bins: clone(currentBins), itemIdx: itemIdx, rule: 5, best: bestSolution, type: 'prune'
            });
            return;
        }

        // 3. –ü–ï–†–ï–ë–Ü–† –ú–ê–®–ò–ù
        for (let i = 0; i < currentBins.length; i++) {
            if (stopAlgorithm) return;

            // Symmetry Breaking
            if (i > 0 && currentBins[i].load === currentBins[i-1].load) {
                continue;
            }

            if (currentBins[i].load + item.w <= CAPACITY) {
                steps.push({
                    msg: `üëâ –ë–µ—Ä—É <b>${item.w}</b>. –ö–ª–∞–¥—É –≤ <b>–ú–∞—à–∏–Ω—É ‚Ññ${i+1}</b> (—Ç–∞–º ${currentBins[i].load}/${CAPACITY}).<br>–í–ª—ñ–∑–ª–æ! –û–¥—Ä–∞–∑—É –±–µ—Ä—É –Ω–∞—Å—Ç—É–ø–Ω—É.`,
                    bins: clone(currentBins), itemIdx: itemIdx, rule: 2, best: bestSolution, 
                    activeTruck: i, activeItem: true
                });

                let newBins = clone(currentBins);
                newBins[i].items.push(item.w);
                newBins[i].load += item.w;

                solve(itemIdx + 1, newBins);
                
                if (stopAlgorithm) return;

                steps.push({
                    msg: `üîô <b>–í–Ü–î–ö–ê–¢:</b> –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤ –≤—Å–µ –∑ <b>${item.w}</b> —É –ú–∞—à–∏–Ω—ñ ‚Ññ${i+1}.<br>–¢–µ–ø–µ—Ä –≤–∏–π–º–∞—é —ó—ó —ñ –ø—Ä–æ–±—É—é –Ω–∞—Å—Ç—É–ø–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç.`,
                    bins: clone(currentBins), itemIdx: itemIdx, rule: 6, best: bestSolution,
                    activeTruck: i
                });
            }
        }

        // 4. –ù–û–í–ê –ú–ê–®–ò–ù–ê
        if (stopAlgorithm) return;

        steps.push({
            msg: `üÜï –£ –Ω–∞—è–≤–Ω—ñ –º–∞—à–∏–Ω–∏ –Ω–µ –ª—ñ–∑–µ (–∞–±–æ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –ø–æ–≥–∞–Ω—ñ).<br>–ë–µ—Ä—É <b>–ù–û–í–£ –ú–∞—à–∏–Ω—É ‚Ññ${currentBins.length+1}</b> –¥–ª—è –≤–∞–Ω—Ç–∞–∂—É <b>${item.w}</b>.`,
            bins: clone(currentBins), itemIdx: itemIdx, rule: 4, best: bestSolution, activeItem: true
        });

        let newBinsNew = clone(currentBins);
        newBinsNew.push({items: [item.w], load: item.w});
        
        solve(itemIdx + 1, newBinsNew);

        if (!stopAlgorithm) {
             steps.push({
                msg: `üîô <b>–í–Ü–î–ö–ê–¢:</b> –ü—Ä–∏–±–∏—Ä–∞—é –Ω–æ–≤—É –º–∞—à–∏–Ω—É –∑ –≤–∞–Ω—Ç–∞–∂–µ–º <b>${item.w}</b>. –ü–æ–≤–µ—Ä—Ç–∞—é—Å—å –Ω–∞ —Ä—ñ–≤–µ–Ω—å –≤–∏—â–µ.`,
                bins: clone(currentBins), itemIdx: itemIdx, rule: 6, best: bestSolution
            });
        }
    }

    // --- VISUALIZATION HELPERS ---
    function stepper(dir) {
        currentStep += dir;
        if(currentStep < 0) currentStep = 0;
        if(currentStep >= steps.length) currentStep = steps.length - 1;
        updateUI();
    }

    function jumpToEnd() {
        currentStep = steps.length - 1;
        updateUI();
    }

    function updateUI() {
        const s = steps[currentStep];
        
        // Narrative & Highlight
        document.getElementById('narrative').innerHTML = s.msg;
        highlightRule(s.rule);
        
        // Metrics
        document.getElementById('best-record').innerText = (s.best === Infinity || s.best === "?") ? "?" : s.best;
        document.getElementById('step-counter').innerText = `${currentStep+1} / ${steps.length}`;
        document.getElementById('progress').style.width = `${((currentStep+1)/steps.length)*100}%`;

        // Queue Render
        const qContainer = document.getElementById('queue-area');
        qContainer.innerHTML = '';
        itemsData.forEach((item, idx) => {
            let div = document.createElement('div');
            div.className = 'box';
            div.innerText = item.w;
            // –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ —á–µ—Ä–∑—ñ:
            // –Ø–∫—â–æ –º–∏ –Ω–∞ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–º—É –∫—Ä–æ—Ü—ñ (s.itemIdx == itemsData.length), —á–µ—Ä–≥–∞ –ø—É—Å—Ç–∞ –∞–±–æ —Å—ñ—Ä–∞
            if (s.type === 'perfect' && idx < itemsData.length) {
                div.style.opacity = '0.2';
            } else {
                 if (idx === s.itemIdx && s.activeItem) div.classList.add('active-item');
                 if (idx < s.itemIdx) div.style.opacity = '0.2'; // Already placed
            }
            qContainer.appendChild(div);
        });

        // Trucks Render
        const tContainer = document.getElementById('trucks-area');
        tContainer.innerHTML = '';
        
        let binsToRender = s.bins;
        
        binsToRender.forEach((bin, bIdx) => {
            renderTruck(tContainer, bin, bIdx, s);
        });

        // –Ø–∫—â–æ —Ç–∏–ø 'new', –¥–æ–º–∞–ª—é—î–º–æ –ø—Ä–∏–º–∞—Ä–Ω—É –Ω–æ–≤—É –º–∞—à–∏–Ω—É
        if (s.rule === 4) {
            let ghostBin = {load: itemsData[s.itemIdx].w, items: [itemsData[s.itemIdx].w]};
            let div = renderTruck(tContainer, ghostBin, binsToRender.length, s);
            div.style.opacity = '0.7';
            div.classList.add('target');
        }
    }

    function renderTruck(container, bin, idx, stepState) {
        let div = document.createElement('div');
        div.className = 'truck';
        if (stepState.activeTruck === idx && stepState.rule === 2) div.classList.add('target');
        // –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä—ñ—à–µ–Ω–Ω—è
        if (stepState.type === 'perfect') {
            div.style.borderColor = '#27ae60';
            div.style.backgroundColor = '#e8f8f5';
        }

        div.innerHTML = `<div class="truck-label">#${idx+1}</div>`;
        
        // Items
        bin.items.forEach(w => {
            let b = document.createElement('div');
            b.className = 'box';
            b.innerText = w;
            div.appendChild(b);
        });

        // Fill
        let fillH = (bin.load / CAPACITY) * 100;
        div.innerHTML += `<div class="truck-fill" style="height:${fillH}%"></div>`;
        div.innerHTML += `<div class="truck-info">${bin.load}/${CAPACITY}</div>`;

        container.appendChild(div);
        return div;
    }

    function highlightRule(id) {
        document.querySelectorAll('.rules-list li').forEach(li => li.classList.remove('active'));
        if (id >= 0) {
            const el = document.getElementById('rule-' + id);
            if(el) el.classList.add('active');
        }
    }

    function clone(obj) { return JSON.parse(JSON.stringify(obj)); }

    // Start with preset
    loadPreset();

</script>
</body>
</html>