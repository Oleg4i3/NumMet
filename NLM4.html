<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLM Denoising Simulator v7 (Pro)</title>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #e2e8f0;
            --accent: #38bdf8;
            --border: #334155;
            --highlight: #facc15;
            --success: #10b981;
            --danger: #f43f5e;
            --conv: #f472b6;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1500px;
        }

        /* Theory Spoiler */
        .theory-spoiler {
            width: 100%;
            max-width: 1500px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--panel);
            overflow: hidden;
        }
        
        .theory-spoiler summary {
            padding: 15px;
            background: #28364a;
            cursor: pointer;
            font-weight: 600;
            color: var(--accent);
            list-style: none; /* Hide default triangle */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .theory-spoiler summary::after { content: "‚ñº"; font-size: 0.8em; transition: transform 0.2s; }
        .theory-spoiler[open] summary::after { transform: rotate(180deg); }

        .theory-content {
            padding: 20px;
            font-size: 0.95em;
            line-height: 1.6;
            color: #cbd5e1;
            border-top: 1px solid var(--border);
        }

        .theory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        h4 { color: var(--highlight); margin: 0 0 10px 0; }
        ul { padding-left: 20px; margin: 0; }
        li { margin-bottom: 5px; }

        /* Controls Panel */
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .control-group { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        
        label { display: block; margin-bottom: 8px; font-size: 0.9em; color: #cbd5e1; }
        
        input[type="range"] {
            width: 100%;
            background: var(--bg);
            height: 6px;
            border-radius: 3px;
            appearance: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }
        
        #convBlur::-webkit-slider-thumb { background: var(--conv); }
        #convSharpen::-webkit-slider-thumb { background: var(--conv); }

        .val-display { float: right; color: var(--accent); font-family: monospace; }
        .val-conv { float: right; color: var(--conv); font-family: monospace; }

        /* Buttons & Selects */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }

        button, select {
            width: 100%;
            padding: 10px;
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
            font-family: inherit;
        }
        button:hover, select:hover { background: #334155; }
        button.active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: bold;}
        
        select { background-color: #0f172a; margin-bottom: 10px; }
        
        input[type="file"] { display: none; }
        .upload-btn { background: #475569; }

        /* Visualization Area */
        .viz-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .canvas-grid {
            display: grid;
            grid-template-columns: repeat(2, auto);
            gap: 20px;
            justify-content: center;
        }

        .canvas-container {
            background: #000;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .canvas-label {
            background: var(--panel);
            width: 100%;
            text-align: center;
            padding: 8px 0;
            font-size: 0.85em;
            border-bottom: 1px solid var(--border);
            color: #94a3b8;
            font-weight: 600;
        }

        canvas { image-rendering: pixelated; }

        /* Inspector */
        .inspector {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            display: grid;
            grid-template-columns: auto auto 1fr;
            gap: 25px;
            align-items: center;
        }

        .mini-view {
            width: 90px;
            height: 90px;
            border: 2px solid var(--border);
            background: #000;
            margin-top: 5px;
            display: block;
        }

        .legend-container {
            width: 100%;
            padding: 5px 15px;
            box-sizing: border-box;
            background: var(--panel);
            border-top: 1px solid var(--border);
        }
        .legend-bar {
            height: 10px;
            width: 100%;
            background: linear-gradient(to right, #0000ff, #0080ff, #00ffff, #00ff00, #ffff00, #ff0000);
            border-radius: 6px;
            margin-bottom: 4px;
        }
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.75em; color: #94a3b8; }

        .status-badge {
            display: inline-block; padding: 4px 8px; border-radius: 4px;
            font-size: 0.8em; font-weight: bold; width: 100%; text-align: center;
            box-sizing: border-box; margin-top: 5px;
        }
        .status-idle { background: #064e3b; color: #34d399; }
        .status-busy { background: #78350f; color: #fbbf24; }

        .warning-text { font-size: 0.8em; color: var(--danger); margin-top: 5px; display: none; }

        #overlayCanvas { position: absolute; top: 33px; left: 0; cursor: crosshair; }
    </style>
</head>
<body>

    <div style="text-align:center; max-width: 800px; margin-bottom: 20px;">
        <h1 style="margin-bottom:5px">–ù–µ–ª–æ–∫–∞–ª—å–Ω–µ —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–Ω—è (NLM) –¥–ª—è –¥–µ–Ω–æ–π–∑—ñ–Ω–≥–∞</h1>
       
    </div>

    <details class="theory-spoiler">
        <summary>üìö –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞: Non-Local Means (–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏)</summary>
        <div class="theory-content">
            <div class="theory-grid">
                <div>
                    <h4>üí° –û—Å–Ω–æ–≤–Ω–∞ –Ü–¥–µ—è</h4>
                    <p>–ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (—è–∫—ñ —É—Å–µ—Ä–µ–¥–Ω—é—é—Ç—å –ª–∏—à–µ —Ñ—ñ–∑–∏—á–Ω–∏—Ö —Å—É—Å—ñ–¥—ñ–≤), <b>Non-Local Means (NLM)</b> –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î <i>–Ω–∞–¥–ª–∏—à–∫–æ–≤—ñ—Å—Ç—å</i> —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó —É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ. –ë—É–¥—å-—è–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä–∞ –∞–±–æ –∫—Ä–∞–π –º–∞—î "–¥–≤—ñ–π–Ω–∏–∫—ñ–≤" –≤ —ñ–Ω—à–∏—Ö —á–∞—Å—Ç–∏–Ω–∞—Ö –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.</p>
                    <p><b>–ê–ª–≥–æ—Ä–∏—Ç–º:</b> –©–æ–± –æ—á–∏—Å—Ç–∏—Ç–∏ –ø—ñ–∫—Å–µ–ª—å $p$, –º–∏ —à—É–∫–∞—î–º–æ —Å—Ö–æ–∂—ñ –Ω–∞ –π–æ–≥–æ –æ–∫—ñ–ª (–ø–∞—Ç—á) —ñ–Ω—à—ñ –ø–∞—Ç—á—ñ $q$ –≤ –º–µ–∂–∞—Ö –∑–æ–Ω–∏ –ø–æ—à—É–∫—É —ñ –æ–±—á–∏—Å–ª—é—î–º–æ –∑–≤–∞–∂–µ–Ω–µ —Å–µ—Ä–µ–¥–Ω—î.</p>
                    
                    <h4>üìê –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –ú–æ–¥–µ–ª—å</h4>
                    <p>–ó–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ–≥–æ –ø—ñ–∫—Å–µ–ª—è $NL(p)$:</p>
                    $$ NL(p) = \frac{1}{Z(p)} \sum_{q \in \Omega} w(p,q) \cdot v(q) $$
                    <p>–î–µ –≤–∞–≥–∞ $w(p,q)$ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å—Ö–æ–∂–æ—Å—Ç—ñ –ø–∞—Ç—á—ñ–≤ $P_p$ —Ç–∞ $P_q$:</p>
                    $$ w(p,q) = e^{-\frac{||P_p - P_q||^2_2}{h^2}} $$
                    <ul>
                        <li>$||P_p - P_q||^2_2$ ‚Äî –µ–≤–∫–ª—ñ–¥–æ–≤–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –∫–æ–ª—å–æ—Ä–∞–º–∏ –ø—ñ–∫—Å–µ–ª—ñ–≤ —É –ø–∞—Ç—á–∞—Ö.</li>
                        <li>$h$ ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è (—Å–∏–ª–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó).</li>
                        <li>$Z(p)$ ‚Äî –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ–π–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç (—Å—É–º–∞ –≤—Å—ñ—Ö –≤–∞–≥).</li>
                    </ul>
                </div>
                <div>
                    <h4>üîë –¢–µ—Ä–º—ñ–Ω–æ–ª–æ–≥—ñ—è</h4>
                    <ul>
                        <li><b>–ü–∞—Ç—á (Patch):</b> –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞ –æ–±–ª–∞—Å—Ç—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, $5 \times 5$), —â–æ –æ—Ç–æ—á—É—î –ø—ñ–∫—Å–µ–ª—å. –°—Ö–æ–∂—ñ—Å—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è —Å–∞–º–µ –∑–∞ –≤–º—ñ—Å—Ç–æ–º –ø–∞—Ç—á—ñ–≤, –∞ –Ω–µ –æ–∫—Ä–µ–º–∏—Ö –ø—ñ–∫—Å–µ–ª—ñ–≤.</li>
                        <li><b>–ó–æ–Ω–∞ –ø–æ—à—É–∫—É (Search Window):</b> –û–±–ª–∞—Å—Ç—å –Ω–∞–≤–∫–æ–ª–æ –ø—ñ–∫—Å–µ–ª—è, –¥–µ –º–∏ —à—É–∫–∞—î–º–æ "–¥–≤—ñ–π–Ω–∏–∫—ñ–≤".</li>
                        <li><b>–ß–µ–±–∏—à–µ–≤—Å—å–∫–∞ –º–µ—Ç—Ä–∏–∫–∞ ($L_1$ vs $L_\infty$):</b> –£ –∫–æ–º–ø'—é—Ç–µ—Ä–Ω–æ–º—É –∑–æ—Ä—ñ "—Ä–∞–¥—ñ—É—Å $R$" —á–∞—Å—Ç–æ –æ–∑–Ω–∞—á–∞—î –∫–≤–∞–¥—Ä–∞—Ç –∑—ñ —Å—Ç–æ—Ä–æ–Ω–æ—é $2R+1$ (–º–µ—Ç—Ä–∏–∫–∞ –ß–µ–±–∏—à–æ–≤–∞), —â–æ –º–∏ —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä—ñ.</li>
                        <li><b>Self-similarity:</b> –í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º—ñ—Å—Ç–∏—Ç–∏ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏.</li>
                    </ul>

                    <h4>üöÄ –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è</h4>
                    <ul>
                        <li><b>–ú–µ–¥–∏—á–Ω–∞ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è (MRI/CT):</b> –í–∏–¥–∞–ª–µ–Ω–Ω—è —à—É–º—É –†–∞–π—Å–∞ –±–µ–∑ —Ä–æ–∑–º–∏—Ç—Ç—è –¥—Ä—ñ–±–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π —Ç–∫–∞–Ω–∏–Ω.</li>
                        <li><b>–ê—Å—Ç—Ä–æ—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—è:</b> –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è —Å–∏–≥–Ω–∞–ª/—à—É–º.</li>
                        <li><b>–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å–∏–Ω–≥:</b> –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —è–∫–æ—Å—Ç—ñ –ø–µ—Ä–µ–¥ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è–º –∞–±–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è–º –æ–±—Ä–∞–∑—ñ–≤.</li>
                    </ul>
                </div>
            </div>
        </div>
    </details>

    <div class="container">
        <div class="panel">
            <h3>1. –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ</h3>
            <div class="control-group">
                <label>–†–æ–∑–¥—ñ–ª—å–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å:</label>
                <select id="resSelect" onchange="changeResolution()">
                    <option value="128">128 x 128 (–°–µ—Ä–µ–¥–Ω—î)</option>
					 <option value="64">64 x 64 (–®–≤–∏–¥–∫–æ)</option>
                    <option value="256">256 x 256 (–ü–æ–≤—ñ–ª—å–Ω–æ!)</option>
                </select>
                <div id="resWarning" class="warning-text">‚ö†Ô∏è –£–≤–∞–≥–∞: 256x256 –≤–∏–º–∞–≥–∞—î –∑–Ω–∞—á–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å. –ë—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ –ø—ñ–¥–≤–∏—Å–∞—Ç–∏.</div>
<div class="btn-grid">
    <button onclick="setPreset('shapes', this)">–ì–µ–æ–º–µ—Ç—Ä—ñ—è</button>
    
    <button onclick="setPreset('texture', this)">–¢–µ–∫—Å—Ç—É—Ä–∞</button>
    
    <button class="active" onclick="setPreset('mri', this)">–ú–†–¢</button>
    
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
</div>
                <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(this)">
                
                <div style="margin-top:15px;">
                    <label>–®—É–º ($\sigma$): <span id="val-noise" class="val-display">26</span></label>
                    <input type="range" id="noise" min="0" max="80" value="26">
                </div>
            </div>

            <h3>2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è NLM</h3>
			
			<div style="margin-bottom: 10px;">
    <label>–§–æ—Ä–º–∞ –æ–±–ª–∞—Å—Ç—ñ:</label>
    <select id="metricSelect" onchange="updateParamsFromDOM()">
       <option value="euclidean">–ö–æ–ª–æ (–ï–≤–∫–ª—ñ–¥)</option>
	   <option value="chebyshev">–ö–≤–∞–¥—Ä–∞—Ç (–ß–µ–±–∏—à–µ–≤)</option>
       
    </select>
</div>
            <div class="control-group">
                <label>–†–∞–¥—ñ—É—Å –ü–∞—Ç—á–∞ ($r$): <span id="val-patch" class="val-display">1 px</span></label>
                <input type="range" id="patchSize" min="1" max="5" step="1" value="1">
                <div style="font-size:0.75em; color:#64748b; margin-top:-5px; margin-bottom: 10px">–í—ñ–∫–Ω–æ: <span id="lbl-patch-dim" style="color:var(--highlight)">5x5</span></div>
                
                <label>–†–∞–¥—ñ—É—Å –ü–æ—à—É–∫—É ($R$): <span id="val-search" class="val-display">10 px</span></label>
                <input type="range" id="searchRadius" min="5" max="25" step="1" value="10">
				
				<label>–§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è ($h$): <span id="val-h" class="val-display">0.7</span></label>
				<input type="range" id="paramH" min="0.1" max="10" step="0.1" value="0.7">
				
                <div id="status" class="status-badge status-idle">NLM –ì–æ—Ç–æ–≤–æ</div>
            </div>

            <h3 style="color:var(--conv)">3. –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è (–ó–≥–æ—Ä—Ç–∫–æ–≤–∏–π —Ñ—ñ–ª—å—Ç—Ä)</h3>
            <div class="control-group">
                <label>Blur (–†–æ–∑–º–∏—Ç—Ç—è): <span id="val-blur" class="val-conv">1</span></label>
                <input type="range" id="convBlur" min="0" max="5" step="1" value="1">
                
                <label>Sharpen (–†—ñ–∑–∫—ñ—Å—Ç—å): <span id="val-sharpen" class="val-conv">1</span></label>
                <input type="range" id="convSharpen" min="0" max="10" step="1" value="1">
            </div>
        </div>

        <div class="viz-area">
            
            <div class="canvas-grid">
                <div class="canvas-container">
                    <div class="canvas-label">A. –í—Ö—ñ–¥–Ω–µ + –®—É–º (–õ–ö–ú - –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –æ–±–ª–∞—Å—Ç—å)</div>
                    <canvas id="noisyCanvas" width="256" height="256"></canvas>
                    <canvas id="overlayCanvas" width="256" height="256"></canvas>
                </div>

                <div class="canvas-container">
                    <div class="canvas-label">B. –ö–∞—Ä—Ç–∞ –°—Ö–æ–∂–µ—Å—Ç—ñ NLM</div>
                    <canvas id="weightCanvas" width="256" height="256"></canvas>
                    <div class="legend-container">
                        <div class="legend-bar"></div>
                        <div class="legend-labels">
                            <span>0 (–†—ñ–∑–Ω–µ)</span>
                            <span>–í–∞–≥–∞</span>
                            <span>1 (–°—Ö–æ–∂–µ)</span>
                        </div>
                    </div>
                </div>
                
                <div class="canvas-container" style="border-color: var(--accent);">
                    <div class="canvas-label" style="color:var(--accent)">C. –†–µ–∑—É–ª—å—Ç–∞—Ç NLM</div>
                    <canvas id="outputCanvas" width="256" height="256"></canvas>
                </div>

                <div class="canvas-container" style="border-color: var(--conv);">
                    <div class="canvas-label" style="color:var(--conv)">D. –ó–≤–∏—á–∞–π–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä</div>
                    <canvas id="convCanvas" width="256" height="256"></canvas>
                </div>
            </div>

            <div class="panel inspector">
                <div style="text-align:center">
                    <label style="margin-bottom:5px; color:var(--highlight)">–¶—ñ–ª—å–æ–≤–∏–π –ü–∞—Ç—á</label>
                    <canvas id="patchRef" class="mini-view" width="64" height="64"></canvas>
                </div>
                <div style="text-align:center">
                    <label style="margin-bottom:5px">NLM –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è</label>
                    <canvas id="patchAvg" class="mini-view" width="64" height="64"></canvas>
                </div>
                <div>
                    <h3 style="margin-top:0; color:#fff">–ø—ñ–∫—Å–µ–ª—å</h3>
                    <div id="inspectorText" style="font-family: monospace; color: #cbd5e1; font-size: 0.95em; line-height: 1.6;">
                        –ù–∞–≤–µ–¥—ñ—Ç—å –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ê...
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Constants & Configuration ---
        // Dynamic Resolution Variables
       // Dynamic Resolution Variables
let SIZE = 128;           // –ë—É–ª–æ 64, —Å—Ç–∞–≤–∏–º–æ 128
const CANVAS_DISPLAY = 256; 
let SCALE = 2;            // –ë—É–ª–æ 4. (–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫: 256 / 128 = 2)
        // Data Arrays
        let originalData = null;
        let noisyData = null;
        let denoisedData = null; 
        
        // Params
        let p_sigma = 20;
        let p_patch = 2;   
        let p_search = 10; 
        let p_h = 0.7;
        let p_blur = 1;
        let p_sharpen = 1;
		

		let p_metric = 'euclidean';

        // UI State
        let lastMouseX = -1; 
        let lastMouseY = -1;
        let isFrozen = false; 
        let debounceTimer;
        let currentPresetType = 'shapes'; // Track current preset to reload on res change

        // --- Initialization ---
        window.addEventListener('load', () => {
            initBuffers();
            init();
        });

        function initBuffers() {
            originalData = new Float32Array(SIZE * SIZE);
            noisyData = new Float32Array(SIZE * SIZE);
            denoisedData = new Float32Array(SIZE * SIZE);
            // Default center mouse
            lastMouseX = Math.floor(SIZE/2);
            lastMouseY = Math.floor(SIZE/2);
        }

      function init() {
    // 1. –í–º–∏–∫–∞—î–º–æ —Å–ª–∞–π–¥–µ—Ä–∏ —Ç–∞ –º–∏—à–∫—É (–¶–¨–û–ì–û –†–Ø–î–ö–ê –ù–ï –í–ò–°–¢–ê–ß–ê–õ–û)
    setupControls();

    // 2. –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∫–Ω–æ–ø–∫—É MRI (–≤–æ–Ω–∞ —Ç—Ä–µ—Ç—è –∑–∞ —Ä–∞—Ö—É–Ω–∫–æ–º, —ñ–Ω–¥–µ–∫—Å 2)
    const mriBtn = document.querySelectorAll('.btn-grid button')[2];
    
    // 3. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–µ—Å–µ—Ç MRI
    setPreset('mri', mriBtn);
}

        function setupControls() {
            // Noise Slider
            document.getElementById('noise').addEventListener('input', (e) => {
                p_sigma = parseFloat(e.target.value);
                document.getElementById('val-noise').innerText = p_sigma;
                regenerateNoise();
            });

            // NLM Params
            ['patchSize', 'searchRadius', 'paramH'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateParamsFromDOM);
            });

            // Convolution Params
            document.getElementById('convBlur').addEventListener('input', (e) => {
                p_blur = parseInt(e.target.value);
                document.getElementById('val-blur').innerText = p_blur;
                runStandardFilter();
            });
            document.getElementById('convSharpen').addEventListener('input', (e) => {
                p_sharpen = parseInt(e.target.value);
                document.getElementById('val-sharpen').innerText = p_sharpen;
                runStandardFilter();
            });

            // Mouse Interaction
            const overlay = document.getElementById('overlayCanvas');
            overlay.addEventListener('mousemove', (e) => {
                if (isFrozen) return;
                const rect = overlay.getBoundingClientRect();
                const mx = Math.floor((e.clientX - rect.left) / SCALE);
                const my = Math.floor((e.clientY - rect.top) / SCALE);
                if (mx >= 0 && mx < SIZE && my >= 0 && my < SIZE) {
                    lastMouseX = mx; lastMouseY = my;
                    visualizeLive();
                }
            });
            overlay.addEventListener('click', () => {
                isFrozen = !isFrozen; 
                const txt = document.getElementById('inspectorText');
                txt.style.borderLeft = isFrozen ? "3px solid #f43f5e" : "none";
            });
        }

        function changeResolution() {
            const sel = document.getElementById('resSelect');
            SIZE = parseInt(sel.value);
            SCALE = CANVAS_DISPLAY / SIZE;
            
            // Warning for 256
            const warning = document.getElementById('resWarning');
            warning.style.display = (SIZE === 256) ? 'block' : 'none';

            initBuffers();
            
            // Reload current content
            if (currentPresetType === 'file' || currentPresetType === 'mri') {
                // If it was a file, we might need to re-crop/re-load. 
                // For simplicity, let's revert to procedural if it was file, 
                // OR try to reload if element exists.
                // Re-triggering the click is safest if we want to keep flow.
                const activeBtn = document.querySelector('.btn-grid button.active');
                if (activeBtn.innerText.includes('MRI')) setPreset('mri', activeBtn);
                else setPreset('shapes', document.querySelectorAll('.btn-grid button')[0]);
            } else {
                setPreset(currentPresetType);
            }
        }

        function updateParamsFromDOM() {
            p_patch = parseInt(document.getElementById('patchSize').value);
            p_search = parseInt(document.getElementById('searchRadius').value);
            p_h = parseFloat(document.getElementById('paramH').value);

			p_metric = document.getElementById('metricSelect').value;
            document.getElementById('val-patch').innerText = p_patch + " px";
            document.getElementById('lbl-patch-dim').innerText = `${2*p_patch+1}x${2*p_patch+1}`;
            document.getElementById('val-search').innerText = p_search + " px";
            document.getElementById('val-h').innerText = p_h.toFixed(1);

            visualizeLive(); 
            scheduleFullDenoise();
        }

        // --- Image Loading Logic ---

        function setPreset(type, btn) {
            currentPresetType = type;
            if(btn) setActiveBtn(btn);

            if (type === 'mri') {
              const mriBase64 = "data:image/png;base64,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"; 
                
                loadImageFromFile(mriBase64);
                return;
            }

            // Procedural Generation
            generateProcedural(type);
        }

        function setActiveBtn(btn) {
            document.querySelectorAll('.btn-grid button').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentPresetType = 'file';
                    loadImageFromFile(e.target.result);
                    setActiveBtn(document.querySelector('.upload-btn')); 
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function loadImageFromFile(src) {
            const img = new Image();
            img.onload = () => {
                // CROP Logic
                const tempCv = document.createElement('canvas');
                tempCv.width = SIZE; tempCv.height = SIZE;
                const tempCtx = tempCv.getContext('2d');
                
                // Calculate crop (cover/center)
                const minDim = Math.min(img.width, img.height);
                const sx = (img.width - minDim) / 2;
                const sy = (img.height - minDim) / 2;

                // Draw clipped portion to fit SIZE x SIZE
                tempCtx.drawImage(img, sx, sy, minDim, minDim, 0, 0, SIZE, SIZE);
                
                const pData = tempCtx.getImageData(0, 0, SIZE, SIZE).data;

                // Grayscale conversion
                for(let i=0; i<SIZE*SIZE; i++) {
                    const r = pData[i*4];
                    const g = pData[i*4+1];
                    const b = pData[i*4+2];
                    originalData[i] = 0.299*r + 0.587*g + 0.114*b;
                }
                regenerateNoise();
            };
            img.onerror = () => {
                alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.");
            }
            img.src = src;
        }

        function generateProcedural(type) {
            // Scale factor for shapes to look consistent across resolutions
            const ratio = SIZE / 64; 

            for (let y = 0; y < SIZE; y++) {
                for (let x = 0; x < SIZE; x++) {
                    let val = 0;
                    if (type === 'shapes') {
                        // Scale coordinates
                        if (x > 15*ratio && x < 45*ratio && y > 15*ratio && y < 45*ratio) val = 200; else val = 50;
                        if ((x-48*ratio)**2 + (y-48*ratio)**2 < 60*(ratio**2)) val = 150;
                    } else if (type === 'texture') {
                        // Texture frequency remains constant or scales? 
                        // Let's keep frequency constant (more texture on larger canvas)
                        val = ((x + y) % 8 < 4) ? 180 : 40;
                    }
                    originalData[y * SIZE + x] = val;
                }
            }
            regenerateNoise();
        }

        function regenerateNoise() {
            const ctx = document.getElementById('noisyCanvas').getContext('2d');
            for (let i = 0; i < SIZE * SIZE; i++) {
                let noise = (Math.random() + Math.random() + Math.random() + Math.random() - 2) * p_sigma;
                noisyData[i] = Math.max(0, Math.min(255, originalData[i] + noise));
            }
            drawDataToCanvas(ctx, noisyData);
            scheduleFullDenoise();
            runStandardFilter();
            visualizeLive();
        }

        // --- Standard Filter Logic ---
        function runStandardFilter() {
            const cvs = document.getElementById('convCanvas');
            const ctx = cvs.getContext('2d');
            
            let tempData = new Float32Array(noisyData);
            
            // Blur
            if (p_blur > 0) {
                const blurRes = new Float32Array(SIZE * SIZE);
                const r = p_blur;
                for(let y=0; y<SIZE; y++) {
                    for(let x=0; x<SIZE; x++) {
                        let sum = 0, count = 0;
                        for(let dy=-r; dy<=r; dy++) {
                            for(let dx=-r; dx<=r; dx++) {
                                let nx = x+dx, ny = y+dy;
                                if(nx>=0 && nx<SIZE && ny>=0 && ny<SIZE) {
                                    sum += tempData[ny*SIZE+nx];
                                    count++;
                                }
                            }
                        }
                        blurRes[y*SIZE+x] = sum/count;
                    }
                }
                tempData = blurRes;
            }

            // Sharpen
            if (p_sharpen > 0) {
                const sharpRes = new Float32Array(SIZE * SIZE);
                const s = p_sharpen * 0.5;
                for(let y=0; y<SIZE; y++) {
                    for(let x=0; x<SIZE; x++) {
                        let center = tempData[y*SIZE+x];
                        let neighbors = 0;
                        const dirs = [[0,1], [0,-1], [1,0], [-1,0]];
                        dirs.forEach(d => {
                            let nx = x+d[0], ny = y+d[1];
                            if(nx>=0 && nx<SIZE && ny>=0 && ny<SIZE) neighbors += tempData[ny*SIZE+nx];
                            else neighbors += center;
                        });
                        let val = (1 + 4*s) * center - s * neighbors;
                        sharpRes[y*SIZE+x] = Math.max(0, Math.min(255, val));
                    }
                }
                tempData = sharpRes;
            }

            drawDataToCanvas(ctx, tempData);
        }

        // --- NLM Core & Viz ---
        function visualizeLive() {
            if(lastMouseX < 0) return;
            const px = lastMouseX, py = lastMouseY;
            
            const ctxOverlay = document.getElementById('overlayCanvas').getContext('2d');
            const ctxWeights = document.getElementById('weightCanvas').getContext('2d');

            ctxOverlay.clearRect(0, 0, CANVAS_DISPLAY, CANVAS_DISPLAY);
            
           // Search Box
        
		// Search Box
            const sRad = p_search;
            
            // 1. –°–ø–æ—á–∞—Ç–∫—É –æ–±—á–∏—Å–ª—é—î–º–æ –º–µ–∂—ñ (—Ü–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–æ–±–æ—Ç–∏ 2-—ó –∫–∞–Ω–≤–∏ - –∫–∞—Ä—Ç–∏ —Å—Ö–æ–∂–µ—Å—Ç—ñ)
            const sMinX = Math.max(0, px - sRad), sMaxX = Math.min(SIZE-1, px + sRad);
            const sMinY = Math.max(0, py - sRad), sMaxY = Math.min(SIZE-1, py + sRad);
            
            ctxOverlay.strokeStyle = 'rgba(56, 255, 255, 0.9)';
            ctxOverlay.lineWidth = 2;
            ctxOverlay.setLineDash([4, 4]);

            // 2. –¢–µ–ø–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –º–µ—Ç—Ä–∏–∫—É –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –Ω–∞ 1-–π –∫–∞–Ω–≤—ñ
            if (p_metric === 'euclidean') {
                // –ú–∞–ª—é—î–º–æ –ö–û–õ–û –¥–ª—è –ï–≤–∫–ª—ñ–¥–∞
                ctxOverlay.beginPath();
                ctxOverlay.arc((px + 0.5) * SCALE, (py + 0.5) * SCALE, sRad * SCALE, 0, Math.PI * 2);
                ctxOverlay.stroke();
            } else {
                // –ú–∞–ª—é—î–º–æ –ö–í–ê–î–†–ê–¢ –¥–ª—è –ß–µ–±–∏—à–µ–≤–∞ (–∞–±–æ —è–∫—â–æ –º–µ—Ç—Ä–∏–∫–∞ –Ω–µ –æ–±—Ä–∞–Ω–∞)
                ctxOverlay.strokeRect(sMinX * SCALE, sMinY * SCALE, (sMaxX - sMinX + 1) * SCALE, (sMaxY - sMinY + 1) * SCALE);
            }

            ctxOverlay.setLineDash([]);
		
		
            // Patch Box
            const pRad = p_patch;
            ctxOverlay.strokeStyle = '#facc15'; ctxOverlay.lineWidth = 2;
            const pSize = (pRad*2+1);
            ctxOverlay.strokeRect((px - pRad) * SCALE, (py - pRad) * SCALE, pSize * SCALE, pSize * SCALE);

            // Weights Heatmap
            ctxWeights.fillStyle = '#000020'; ctxWeights.fillRect(0,0,CANVAS_DISPLAY, CANVAS_DISPLAY);
            let totalWeight = 0, weightedSum = 0, maxW = 0;
            const tempWeights = []; 
            
            // Scaled H parameter to make filtering aggressiveness independent of noise level
            const safeSigma = Math.max(p_sigma, 1.0);
            const h2 = (p_h * safeSigma) ** 2;

            for (let y = sMinY; y <= sMaxY; y++) {
                for (let x = sMinX; x <= sMaxX; x++) {
				
				// –¢—É—Ç (px, py) - —Ü–µ–Ω—Ç—Ä, –∞ (x, y) - –ø–æ—Ç–æ—á–Ω–∏–π –ø—ñ–∫—Å–µ–ª—å –≤—ñ–∫–Ω–∞
                if (p_metric === 'euclidean') {
                    const dx = x - px;
                    const dy = y - py;
                    if (dx*dx + dy*dy > p_search*p_search) continue;
                }
                    const dist2 = calculatePatchDistance(px, py, x, y);
                    
                    // IMPROVED WEIGHT FORMULA:
                    // 1. Removes the hard subtraction "dist2 - 2*sigma^2" which caused excessive blurring ("soaping") at high noise.
                    // 2. Scales h with sigma so the slider behavior is consistent across different noise levels.
                    const w = Math.exp( -dist2 / h2 );

                    if (w > maxW) maxW = w;
                    totalWeight += w; weightedSum += w * noisyData[y * SIZE + x];
                    
                    // Add ALL pixels in range to visualization to avoid black holes in heatmap
                    tempWeights.push({x, y, w});
                }
            }

            if (maxW < 1e-6) maxW = 1;
            for (let item of tempWeights) {
                const val = item.w / maxW; 
                const hue = (1.0 - val) * 240; 
               ctxWeights.fillStyle = `hsla(${hue}, 100%, 50%, 1.0)`;
				//ctxWeights.fillStyle = `hsl(${(1 - w) * 240}, 100%, 50%)`; //f–Ω–µ –ø—Ä–∞—Ü—é—î
                ctxWeights.fillRect(item.x * SCALE, item.y * SCALE, SCALE, SCALE);
            }

            const resultVal = totalWeight > 0 ? weightedSum / totalWeight : noisyData[py*SIZE+px];
            document.getElementById('inspectorText').innerHTML = 
                `–ö–æ–æ—Ä–¥: <b>(${px}, ${py})</b> ${isFrozen ? '<span style="color:#f43f5e">[FIXED]</span>' : ''}<br>` +
                `NLM: <span style="color:#facc15">${resultVal.toFixed(1)}</span> (Orig: ${noisyData[py*SIZE+px].toFixed(0)})<br>` +
                ``;

            // –ü–µ—Ä—à–∏–π –ø–∞—Ç—á –ø–æ–∫–∞–∑—É—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —à—É–º (noisyData –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
    drawPatchView('patchRef', px, py);
    
    // –î—Ä—É–≥–∏–π –ø–∞—Ç—á —Ç–µ–ø–µ—Ä –±–µ—Ä–µ –¥–∞–Ω—ñ –∑ denoisedData
    // resultVal –∑–∞–ª–∏—à–∞—î–º–æ –¥–ª—è –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ø—ñ–∫—Å–µ–ª—è, —è–∫–∏–π –º–∏ —â–æ–π–Ω–æ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞–ª–∏ "–Ω–∞ –ª—å–æ—Ç—É"
    drawPatchView('patchAvg', px, py, resultVal, denoisedData);
        }

        function scheduleFullDenoise() {
            const statusEl = document.getElementById('status');
            statusEl.innerText = "–û–±—Ä–æ–±–∫–∞..."; statusEl.className = "status-badge status-busy";
            clearTimeout(debounceTimer);
            // Longer debounce for larger images
            const delay = (SIZE > 100) ? 200 : 50; 
            debounceTimer = setTimeout(runFullDenoiseProcess, delay);
        }

        function runFullDenoiseProcess() {
            const start = performance.now();
            
            // Consistent H scaling
            const safeSigma = Math.max(p_sigma, 1.0);
            const h2 = (p_h * safeSigma) ** 2;

            for (let y = 0; y < SIZE; y++) {
                for (let x = 0; x < SIZE; x++) {
                    let totalWeight = 0, weightedSum = 0;
                    const sMinX = Math.max(0, x - p_search), sMaxX = Math.min(SIZE-1, x + p_search);
                    const sMinY = Math.max(0, y - p_search), sMaxY = Math.min(SIZE-1, y + p_search);

                    for (let sy = sMinY; sy <= sMaxY; sy++) {
                        for (let sx = sMinX; sx <= sMaxX; sx++) {
						
					// –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É (x, y) –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—ñ–∫—Å–µ–ª—è (sx, sy)
						if (p_metric === 'euclidean') {
							const dx = sx - x;
							const dy = sy - y;
							if (dx*dx + dy*dy > p_search*p_search) continue;
							}
                            const dist2 = calculatePatchDistance(x, y, sx, sy);
                            const w = Math.exp( -dist2 / h2 );
                            
                            totalWeight += w; weightedSum += w * noisyData[sy * SIZE + sx];
                        }
                    }
                    denoisedData[y*SIZE+x] = totalWeight > 0 ? weightedSum/totalWeight : noisyData[y*SIZE+x];
                }
            }
            drawDataToCanvas(document.getElementById('outputCanvas').getContext('2d'), denoisedData);
            const statusEl = document.getElementById('status');
            statusEl.innerText = `NLM –ì–æ—Ç–æ–≤–æ (${(performance.now() - start).toFixed(0)} ms)`;
            statusEl.className = "status-badge status-idle";
        }

        // --- Helpers ---
        function calculatePatchDistance(x1, y1, x2, y2) {
            let dist = 0; const dim = p_patch;
            for (let dy = -dim; dy <= dim; dy++) {
                for (let dx = -dim; dx <= dim; dx++) {
                    const val1 = getSafePixel(x1 + dx, y1 + dy);
                    const val2 = getSafePixel(x2 + dx, y2 + dy);
                    dist += (val1 - val2) ** 2;
                }
            }
            return dist / ((2*dim+1)**2);
        }

 

	function getSafePixel(x, y, sourceData = noisyData) {
    if (x < 0) x = -x; if (y < 0) y = -y;
    if (x >= SIZE) x = 2*SIZE - x - 2; if (y >= SIZE) y = 2*SIZE - y - 2;
    if (x < 0) x = 0; if (x >= SIZE) x = SIZE-1;
    if (y < 0) y = 0; if (y >= SIZE) y = SIZE-1;
    
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–µ—Ä–µ–¥–∞–Ω–∏–π –º–∞—Å–∏–≤ –∞–±–æ noisyData –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    return sourceData[y * SIZE + x];
			}

        function drawDataToCanvas(ctx, data) {
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,CANVAS_DISPLAY, CANVAS_DISPLAY);
            for (let y = 0; y < SIZE; y++) {
                for (let x = 0; x < SIZE; x++) {
                    const val = Math.floor(data[y * SIZE + x]);
                    ctx.fillStyle = `rgb(${val},${val},${val})`;
                    ctx.fillRect(x*SCALE, y*SCALE, SCALE, SCALE);
                }
            }
        }

    
function drawPatchView(canvasId, cx, cy, overrideCenter = null, dataSrc = noisyData) {
    const cvs = document.getElementById(canvasId);
    const ctx = cvs.getContext('2d');
    const w = cvs.width; 
    const dim = p_patch * 2 + 1;
    const blockSize = w / dim; 

    ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,w);

    for (let dy = 0; dy < dim; dy++) {
        for (let dx = 0; dx < dim; dx++) {
            const lx = cx + (dx - p_patch);
            const ly = cy + (dy - p_patch);
            
            // –¢–£–¢ –ó–ú–Ü–ù–ê: –ü–µ—Ä–µ–¥–∞—î–º–æ dataSrc —É getSafePixel
            let val = getSafePixel(lx, ly, dataSrc);
            
            const isCenter = (dx === p_patch && dy === p_patch);
            if (overrideCenter !== null && isCenter) val = overrideCenter;

            val = Math.floor(val);
            ctx.fillStyle = `rgb(${val},${val},${val})`;
            const drawX = Math.floor(dx * blockSize);
            const drawY = Math.floor(dy * blockSize);
            const drawSize = Math.ceil(blockSize);
            ctx.fillRect(drawX, drawY, drawSize, drawSize);

            if (isCenter) {
                ctx.strokeStyle = overrideCenter !== null ? '#10b981' : '#facc15';
                ctx.lineWidth = 2;
                ctx.strokeRect(drawX+1, drawY+1, drawSize-2, drawSize-2);
            }
        }
    }
}
    </script>
</body>
</html>