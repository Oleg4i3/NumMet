<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACELP Vocoder</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      startup: {
        typeset: false // –ú–∏ –±—É–¥–µ–º–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ä–µ–Ω–¥–µ—Ä –≤—Ä—É—á–Ω—É –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è DOM
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --panel: #ffffff; --text: #334155; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 1100px; width: 100%; display: grid; grid-template-columns: 1fr; gap: 20px; }
        
        /* Panel Styles */
        .control-panel { background: var(--panel); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 600; transition: 0.2s; }
        button:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        button:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-1px); }
        button.reset { background: #dc2626; }
        
        /* Theory Box Styles */
        .theory-box { background: #fff; border-left: 6px solid var(--primary); padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); min-height: 250px; line-height: 1.7; font-size: 1.05em; }
        h2 { margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; color: #0f172a; }
        h3 { color: #1e40af; margin-top: 20px; margin-bottom: 5px; font-size: 1.1em; }
        
        /* LaTeX Container */
        .math-block { 
            background: #f1f5f9; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            overflow-x: auto; /* –í–∞–∂–ª–∏–≤–æ –¥–ª—è –¥–æ–≤–≥–∏—Ö —Ñ–æ—Ä–º—É–ª */
            border: 1px solid #e2e8f0;
            font-size: 1.1em;
        }
        
        /* Highlight concept */
        .concept { background: #dbeafe; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: #1e40af; }

        /* Sliders & Visuals */
        .slider-section { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #cbd5e1; display: none; margin-top: 15px; }
        .chart-wrapper { background: white; padding: 15px; border-radius: 12px; height: 350px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center;">–í–æ–∫–æ–¥–µ—Ä —Ç–∞ –õ—ñ–Ω—ñ–π–Ω–µ –ü–µ—Ä–µ–¥–±–∞—á–µ–Ω–Ω—è</h1>
    
    <div class="control-panel">
        <div class="btn-group">
            <button id="btnRecord" onclick="startRecording()">üé§ –ó–∞–ø–∏—Å–∞—Ç–∏ (–°–∫–∞–∂—ñ—Ç—å —Å–ª–æ–≤–æ)</button>
            <button id="btnStep" onclick="nextStep()" disabled>‚ñ∂ –ö—Ä–æ–∫ –í–ø–µ—Ä–µ–¥</button>
            <button id="btnReset" onclick="location.reload()" class="reset" style="display:none;">‚Ü∫ –°–∫–∏–Ω—É—Ç–∏</button>
            <span id="status" style="align-self:center; font-weight:bold; color:#64748b; margin-left:10px;">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Å—É...</span>
        </div>

        <div id="vocoderControls" class="slider-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <strong>–°—Ç—É–ø—ñ–Ω—å —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è (–Ø–∫—ñ—Å—Ç—å –∑–∞–ª–∏—à–∫—É)</strong>
                <span id="compLabel">100% (Lossless)</span>
            </div>
            <input type="range" id="compSlider" min="0" max="100" value="100" style="width:100%" oninput="updateSlider(this.value)">
            <p style="font-size:0.9em; color:#475569; margin-top:10px;">
                <strong>100%:</strong> –ü–µ—Ä–µ–¥–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Å–∏–≥–Ω–∞–ª –ø–æ–º–∏–ª–∫–∏ (—è–∫ FLAC/WAV). <br>
                <strong>0% (Pure Vocoder):</strong> –°–∏–≥–Ω–∞–ª –ø–æ–º–∏–ª–∫–∏ –≤–∏–∫–∏–¥–∞—î—Ç—å—Å—è. –ó–∞–º—ñ—Å—Ç—å –Ω—å–æ–≥–æ —Å–∏–Ω—Ç–µ–∑—É—î—Ç—å—Å—è —ñ–¥–µ–∞–ª—å–Ω–∏–π "–≥—É–ª" (Buzz) –Ω–∞ —á–∞—Å—Ç–æ—Ç—ñ —Ç–æ–Ω—É. –¶–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–µ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è (—è–∫ —É –≤—ñ–π—Å—å–∫–æ–≤–∏—Ö —Ä–∞—Ü—ñ—è—Ö).
            </p>
            <button onclick="playAudioResult()" style="background:#16a34a; width:100%;">‚ñ∂ –°–ª—É—Ö–∞—Ç–∏ –†–µ–∑—É–ª—å—Ç–∞—Ç</button>
        </div>
    </div>

    <div class="theory-box" id="theoryContent">
        <h2>–í—Å—Ç—É–ø: –Ø–∫ —Å—Ç–∏—Å–Ω—É—Ç–∏ –≥–æ–ª–æ—Å —É 100+ —Ä–∞–∑—ñ–≤?</h2>
        <p>–Ü—Å–Ω—É—î –¥–≤–∞ –ø—ñ–¥—Ö–æ–¥–∏ –¥–æ –ø–µ—Ä–µ–¥–∞—á—ñ –∞—É–¥—ñ–æ:</p>
        <ol>
            <li><strong>–•–≤–∏–ª—å–æ–≤–µ –∫–æ–¥—É–≤–∞–Ω–Ω—è (Waveform Coding):</strong> –ú–∏ –Ω–∞–º–∞–≥–∞—î–º–æ—Å—å –∑–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ä–º—É —Ö–≤–∏–ª—ñ (MP3, AAC). –¶–µ —è–∫ –∑—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—é —Ç–µ–∫—Å—Ç—É. –í–∏–º–∞–≥–∞—î –±–∞–≥–∞—Ç–æ –ø–∞–º'—è—Ç—ñ.</li>
            <li><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–Ω–µ –∫–æ–¥—É–≤–∞–Ω–Ω—è (Vocoder/LPC):</strong> –ú–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—î–º–æ –∑–≤—É–∫. –ú–∏ –ø–µ—Ä–µ–¥–∞—î–º–æ <em>—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é</em>, —è–∫ –π–æ–≥–æ —Å–∏–Ω—Ç–µ–∑—É–≤–∞—Ç–∏. –¶–µ —è–∫ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Å–∞–º —Ç–µ–∫—Å—Ç (ASCII) –∑–∞–º—ñ—Å—Ç—å –π–æ–≥–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó.</li>
        </ol>
        <p>–ö–æ–¥–µ–∫ <span class="concept">ACELP</span> (–æ—Å–Ω–æ–≤–∞ –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î <strong>–õ—ñ–Ω—ñ–π–Ω–µ –ü–µ—Ä–µ–¥–±–∞—á–µ–Ω–Ω—è (LPC)</strong>. –ú–∏ –∑–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω—É –º–æ–¥–µ–ª—å –≤–∞—à–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ç—Ä–∞–∫—Ç—É (—Ñ—ñ–ª—å—Ç—Ä) —ñ –ø–µ—Ä–µ–¥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —ó—ó –ø–∞—Ä–∞–º–µ—Ç—Ä–∏.</p>
        
	

		<details class="theory-box" style="margin-top: 15px; min-height: auto; padding: 15px; border-left-color: #8b5cf6;">
    <summary style="cursor: pointer; font-weight: bold; color: #7c3aed; font-size: 1.1em;">
        üéì –î–æ–≤—ñ–¥–∫–∞: –©–æ —Ç–∞–∫–µ Z-–ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è?
    </summary>
    
    <div style="margin-top: 15px; line-height: 1.6;">
        <p>–°–∏–≥–Ω–∞–ª - —Ü–µ –º–∞—Å–∏–≤ —á–∏—Å–µ–ª <code>x[0], x[1], x[2]...</code>. <strong>Z-–ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è</strong> ‚Äî —Ü–µ —Å–ø–æ—Å—ñ–± –∑–∞–ø–∏—Å–∞—Ç–∏ —Ü–µ–π –º–∞—Å–∏–≤ —è–∫ –æ–¥–∏–Ω –¥–æ–≤–≥–∏–π –ø–æ–ª—ñ–Ω–æ–º:</p>
        
        <div style="background: #f5f3ff; padding: 10px; border-radius: 4px; border: 1px solid #ddd6fe; font-family: 'Times New Roman', serif; font-size: 1.2em; text-align: center;">
            <i>X</i>(<i>z</i>) = <i>x</i>[0] + <i>x</i>[1]<i>z</i><sup>-1</sup> + <i>x</i>[2]<i>z</i><sup>-2</sup> + ...
        </div>
        
        <h3>1. –ù–∞–≤—ñ—â–æ —Ü–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ? </h3>
        <p>–£ DSP –Ω–∞–π–≥–æ–ª–æ–≤–Ω—ñ—à–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è ‚Äî —Ü–µ –≤–∑—è—Ç–∏ "–º–∏–Ω—É–ª–µ –∑–Ω–∞—á–µ–Ω–Ω—è" (<code>x[n-1]</code>). –£ Z-–æ–±–ª–∞—Å—Ç—ñ <strong>–∑–∞—Ç—Ä–∏–º–∫–∞ –Ω–∞ 1 —Ç–∞–∫—Ç ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ –º–Ω–æ–∂–µ–Ω–Ω—è –Ω–∞ <i>z</i><sup>-1</sup></strong>.</p>
        <p>–¶–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —Å–∫–ª–∞–¥–Ω—ñ —Ü–∏–∫–ª–∏ –Ω–∞ –ø—Ä–æ—Å—Ç—É –∞–ª–≥–µ–±—Ä—É.</p>

        <h3>2. –ü—Ä–∏–∫–ª–∞–¥: –ó–≤—ñ–¥–∫–∏ –±–µ—Ä–µ—Ç—å—Å—è H(z)?</h3>
        <p>–£—è–≤—ñ—Ç—å –ø—Ä–æ—Å—Ç–∏–π —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä: <br>
        <em>"–ü–æ—Ç–æ—á–Ω–µ = –í—Ö—ñ–¥ + 0.5 * –ú–∏–Ω—É–ª–µ"</em></p>
        <p>–£ –∫–æ–¥—ñ: <code>y[n] = x[n] + 0.5 * y[n-1]</code></p>
        
        <p>–ó–∞—Å—Ç–æ—Å—É—î–º–æ Z-–ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è (–∑–∞–º—ñ–Ω–∏–º–æ <code>y[n-1]</code> –Ω–∞ <i>z</i><sup>-1</sup><i>Y</i>(<i>z</i>)):</p>
        
        <div style="background: #f5f3ff; padding: 10px; border-radius: 4px; border: 1px solid #ddd6fe; font-family: 'Times New Roman', serif; font-size: 1.2em; text-align: center;">
            <i>Y</i>(<i>z</i>) = <i>X</i>(<i>z</i>) + 0.5 ¬∑ <i>z</i><sup>-1</sup> ¬∑ <i>Y</i>(<i>z</i>)
        </div>
        
        <p>–ü–µ—Ä–µ–Ω–µ—Å–µ–º–æ <i>Y</i>(<i>z</i>) –≤–ª—ñ–≤–æ:</p>
        
        <div style="background: #f5f3ff; padding: 10px; border-radius: 4px; border: 1px solid #ddd6fe; font-family: 'Times New Roman', serif; font-size: 1.2em; text-align: center;">
            <i>Y</i>(<i>z</i>) ¬∑ (1 - 0.5<i>z</i><sup>-1</sup>) = <i>X</i>(<i>z</i>)
        </div>
        
        <p>–ó–Ω–∞–π–¥–µ–º–æ <strong>–ü–µ—Ä–µ–¥–∞—Ç–Ω—É –§—É–Ω–∫—Ü—ñ—é</strong> (–í–∏—Ö—ñ–¥ / –í—Ö—ñ–¥):</p>
        
        <div style="background: #f5f3ff; padding: 10px; border-radius: 4px; border: 1px solid #ddd6fe; font-family: 'Times New Roman', serif; font-size: 1.2em; text-align: center;">
            <i>H</i>(<i>z</i>) = 
            <span style="display: inline-block; vertical-align: middle; text-align: center;">
                <div style="border-bottom: 1px solid black; padding-bottom: 2px;">1</div>
                <div style="padding-top: 2px;">1 - 0.5<i>z</i><sup>-1</sup></div>
            </span>
        </div>
        
        <h3>3. –ü–æ–ª—é—Å–∏ —Ç–∞ –†–µ–∑–æ–Ω–∞–Ω—Å</h3>
        <p>–ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–∞ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ –¥—Ä–æ–±—É. –ö–æ–ª–∏ (1 - 0.5<i>z</i><sup>-1</sup>) –Ω–∞–±–ª–∏–∂–∞—î—Ç—å—Å—è –¥–æ –Ω—É–ª—è, –∑–Ω–∞—á–µ–Ω–Ω—è <i>H</i>(<i>z</i>) —Å—Ç—Ä—ñ–º–∫–æ –∑—Ä–æ—Å—Ç–∞—î.</p>
        <p>
            <span style="background: #dbeafe; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: #1e40af;">–í–∏—Å–Ω–æ–≤–æ–∫:</span> 
            –§—ñ–ª—å—Ç—Ä <i>A</i>(<i>z</i>) ‚Äî —Ü–µ —Å—É–º–∞, –≤—ñ–Ω —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π. 
            –§—ñ–ª—å—Ç—Ä 1/<i>A</i>(<i>z</i>) ‚Äî —Ü–µ –¥—Ä—ñ–±, –π–æ–≥–æ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ —Å—Ç–≤–æ—Ä—é—î —Ä–µ–∑–æ–Ω–∞–Ω—Å–∏ (—Ñ–æ—Ä–º–∞–Ω—Ç–∏), —ñ–º—ñ—Ç—É—é—á–∏ –≥–æ–ª–æ—Å.
        </p>
    </div>
</details>
		
		
		<p><em>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–∞–ø–∏—Å–∞—Ç–∏", —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É.</em></p>
    </div>

    <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
    </div>
    <div class="chart-wrapper" id="chart2Container" style="display:none;">
        <canvas id="secChart"></canvas>
    </div>
</div>

<script>
    // --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ---
    const FRAME_SIZE = 512; // ~11ms
    const LPC_ORDER = 10;   // –ü–æ—Ä—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä–∞ (p)
    const MAX_LAG = 150;    // –î–ª—è –ø–æ—à—É–∫—É Pitch
    
    let audioCtx;
    let fullBuffer = null;
    let displayFrame = null;
    let r_coeffs = [];
    let lpc_coeffs = [];
    let currentStep = 0;
    
    let chart1 = null;
    let chart2 = null;

    // --- –ö–†–û–ö–ò –°–ò–ú–£–õ–Ø–¶–Ü–á ---
    const steps = [
        {
            title: "–ö—Ä–æ–∫ 1: –§—Ä–µ–π–º—ñ–Ω–≥ —Ç–∞ –í—ñ–∫–Ω–æ",
            html: `
                <p>–ú–∏ —Ä–æ–∑–±–∏–ª–∏ —Å–∏–≥–Ω–∞–ª –Ω–∞ –∫–æ—Ä–æ—Ç–∫—ñ –≤—ñ–¥—Ä—ñ–∑–∫–∏ (—Ñ—Ä–µ–π–º–∏) –ø–æ $N=${FRAME_SIZE}$ —Å–µ–º–ø–ª—ñ–≤. –©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ –Ω–∞ –∫—Ä–∞—è—Ö ("–∫–ª–∞—Ü–∞–Ω–Ω—è" –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏), –º–∏ –º–Ω–æ–∂–∏–º–æ —Å–∏–≥–Ω–∞–ª –Ω–∞ <strong>–≤—ñ–∫–Ω–æ –•–µ–º–º—ñ–Ω–≥–∞</strong> $w[n]$:</p>
                <div class="math-block">
                $$ x_w[n] = x[n] \\cdot \\left( 0.54 - 0.46 \\cos\\left(\\frac{2\\pi n}{N-1}\\right) \\right) $$
                </div>
                <p>–¢–µ–ø–µ—Ä —Å–∏–≥–Ω–∞–ª –ø–ª–∞–≤–Ω–æ –∑–∞—Ç—É—Ö–∞—î –¥–æ –Ω—É–ª—è –Ω–∞ –∫—Ä–∞—è—Ö, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–µ–∫—Ç–Ω–æ –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –π–æ–≥–æ —Å–ø–µ–∫—Ç—Ä.</p>
            `,
            action: () => {
                const wData = applyHamming(displayFrame);
                drawWaveform(wData, "–°–∏–≥–Ω–∞–ª –ø—ñ—Å–ª—è –≤—ñ–∫–Ω–∞");
                displayFrame = wData;
            }
        },
        {
            title: "–ö—Ä–æ–∫ 2: –ê–≤—Ç–æ–∫–æ—Ä–µ–ª—è—Ü—ñ—è (Pitch Detection)",
            html: `
                <p>–©–æ–± –ø–µ—Ä–µ–¥–±–∞—á–∏—Ç–∏ –º–∞–π–±—É—Ç–Ω—î —Å–∏–≥–Ω–∞–ª—É, —Ç—Ä–µ–±–∞ –∑–Ω–∞—Ç–∏ –π–æ–≥–æ –º–∏–Ω—É–ª–µ. –ê–≤—Ç–æ–∫–æ—Ä–µ–ª—è—Ü—ñ—è $R(k)$ –ø–æ–∫–∞–∑—É—î –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –º—ñ–∂ —Å–∏–≥–Ω–∞–ª–æ–º —Ç–∞ –π–æ–≥–æ –∫–æ–ø—ñ—î—é, –∑—Å—É–Ω—É—Ç–æ—é –Ω–∞ $k$ –∫—Ä–æ–∫—ñ–≤:</p>
                <div class="math-block">
                $$ R(k) = \\sum_{n=k}^{N-1} x_w[n] \\cdot x_w[n-k] $$
                </div>
                <p>–ì—Ä–∞—Ñ—ñ–∫ –ø–æ–∫–∞–∑—É—î –¥–≤–∞ –≤–∞–∂–ª–∏–≤—ñ —Ñ–∞–∫—Ç–∏:</p>
                <ul>
                    <li><strong>–ú–∞–∫—Å–∏–º—É–º –ø—Ä–∏ $k=0$:</strong> –¶–µ –ø–æ–≤–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è —Å–∏–≥–Ω–∞–ª—É.</li>
                    <li><strong>–î—Ä—É–≥–∏–π –ø—ñ–∫:</strong> –¶–µ –ø–µ—Ä—ñ–æ–¥ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–æ–Ω—É (Pitch). –í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –Ω—å–æ–≥–æ –ø–æ–∫–∞–∑—É—î, —è–∫ —à–≤–∏–¥–∫–æ –≤—ñ–±—Ä—É—é—Ç—å –≤–∞—à—ñ –≥–æ–ª–æ—Å–æ–≤—ñ –∑–≤'—è–∑–∫–∏.</li>
                </ul>
            `,
            action: () => {
                r_coeffs = autocorrelate(displayFrame, MAX_LAG);
                drawAutocorr(r_coeffs);
            }
        },
       {
            title: "–ö—Ä–æ–∫ 3: –†—ñ–≤–Ω—è–Ω–Ω—è –Æ–ª–∞-–£–æ–∫–µ—Ä–∞",
            html: `
                <p>–î–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏—Ö –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ $a_k$? –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è <strong>–ú–µ—Ç–æ–¥ –Ω–∞–π–º–µ–Ω—à–∏—Ö –∫–≤–∞–¥—Ä–∞—Ç—ñ–≤</strong>.</p>
                
                <p>1. –í–∏–∑–Ω–∞—á–∏–º–æ –µ–Ω–µ—Ä–≥—ñ—é –ø–æ–º–∏–ª–∫–∏ –ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–Ω—è $\\mathcal{E}$ —è–∫ —Å—É–º—É –∫–≤–∞–¥—Ä–∞—Ç—ñ–≤ —Ä—ñ–∑–Ω–∏—Ü—å –º—ñ–∂ —Ä–µ–∞–ª—å–Ω–∏–º —Å–∏–≥–Ω–∞–ª–æ–º —Ç–∞ –ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∏–º:</p>
                <div class="math-block">
                $$ \\mathcal{E} = \\sum_{n} (e[n])^2 = \\sum_{n} \\left( x[n] + \\sum_{k=1}^{p} a_k x[n-k] \\right)^2 $$
                </div>

                <p>2. –©–æ–± –ø–æ–º–∏–ª–∫–∞ –±—É–ª–∞ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—é, –º–∏ –±–µ—Ä–µ–º–æ —á–∞—Å—Ç–∏–Ω–Ω—É –ø–æ—Ö—ñ–¥–Ω—É –ø–æ –∫–æ–∂–Ω–æ–º—É –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—É $a_i$ (–¥–µ $1 \\le i \\le p$) —ñ –ø—Ä–∏—Ä—ñ–≤–Ω—é—î–º–æ —ó—ó –¥–æ –Ω—É–ª—è:</p>
                <div class="math-block">
                $$ \\frac{\\partial \\mathcal{E}}{\\partial a_i} = 2 \\sum_{n} \\underbrace{\\left( x[n] + \\sum_{k=1}^{p} a_k x[n-k] \\right)}_{e[n]} \\cdot (x[n-i]) = 0 $$
                </div>
                
                <p>3. –¶–µ —Ä—ñ–≤–Ω—è–Ω–Ω—è –æ–∑–Ω–∞—á–∞—î, —â–æ <em>–ø–æ–º–∏–ª–∫–∞ –º–∞—î –±—É—Ç–∏ –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–æ—é –¥–æ –º–∏–Ω—É–ª–∏—Ö –∑–Ω–∞—á–µ–Ω—å —Å–∏–≥–Ω–∞–ª—É</em>. –Ø–∫—â–æ —Ä–æ–∑–∫—Ä–∏—Ç–∏ –¥—É–∂–∫–∏ —ñ –∑–≥–∞–¥–∞—Ç–∏, —â–æ $\\sum x[n]x[n-i]$ ‚Äî —Ü–µ –∞–≤—Ç–æ–∫–æ—Ä–µ–ª—è—Ü—ñ—è $R(i)$, –º–∏ –æ—Ç—Ä–∏–º—É—î–º–æ:</p>
                <div class="math-block">
                $$ R(i) + \\sum_{k=1}^{p} a_k R(i-k) = 0 $$
                </div>
                
                <p>–¶–µ —ñ —î —Å–∏—Å—Ç–µ–º–∞ <strong>–Æ–ª–∞-–£–æ–∫–µ—Ä–∞</strong>. –£ –º–∞—Ç—Ä–∏—á–Ω–æ–º—É –≤–∏–≥–ª—è–¥—ñ –≤–æ–Ω–∞ –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫ (–¥–ª—è $p=${LPC_ORDER}):</p>
                <div class="math-block">
                $$ 
                \\begin{bmatrix} 
                R(0) & R(1) & \\cdots & R(p-1) \\\\ 
                R(1) & R(0) & \\cdots & R(p-2) \\\\ 
                \\vdots & \\vdots & \\ddots & \\vdots \\\\ 
                R(p-1) & R(p-2) & \\cdots & R(0) 
                \\end{bmatrix} 
                \\begin{bmatrix} a_1 \\\\ a_2 \\\\ \\vdots \\\\ a_p \\end{bmatrix} = 
                -\\begin{bmatrix} R(1) \\\\ R(2) \\\\ \\vdots \\\\ R(p) \\end{bmatrix} 
                $$
                </div>
                <p>–†–æ–∑–≤'—è–∑–∞–≤—à–∏ —Ü—é —Å–∏—Å—Ç–µ–º—É, –º–∏ –æ—Ç—Ä–∏–º—É—î–º–æ "–∑–ª—ñ–ø–æ–∫" —Ñ–æ—Ä–º–∏ –≤–∞—à–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ç—Ä–∞–∫—Ç—É.</p>
            `,
            action: () => {
                // –í—ñ–∑—É–∞–ª—å–Ω–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –º—ñ–Ω—è—î–º–æ
            }
        },
        {
            title: "–ö—Ä–æ–∫ 4: LPC –°–ø–µ–∫—Ç—Ä (–†–æ–∑–≤'—è–∑–æ–∫)",
            html: `
                <p>–ú–∏ —Ä–æ–∑–≤'—è–∑–∞–ª–∏ —Å–∏—Å—Ç–µ–º—É —ñ –∑–Ω–∞–π—à–ª–∏ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ $a_k$. –í–æ–Ω–∏ —Ñ–æ—Ä–º—É—é—Ç—å —Ñ—ñ–ª—å—Ç—Ä $A(z) = 1 + \\sum a_k z^{-k}$.</p>
                <p>–Ø–∫—â–æ –ø–æ–±—É–¥—É–≤–∞—Ç–∏ —á–∞—Å—Ç–æ—Ç–Ω—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É $H(z) = \\frac{1}{A(z)}$ (—á–µ—Ä–≤–æ–Ω–∞ –ª—ñ–Ω—ñ—è), –º–∏ –ø–æ–±–∞—á–∏–º–æ, —â–æ –≤–æ–Ω–∞ –æ–≥–∏–Ω–∞—î —Å–ø–µ–∫—Ç—Ä —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≥–æ–ª–æ—Å—É.</p>
					
                <p>–¶—ñ "–≥–æ—Ä–±–∏" –Ω–∞–∑–∏–≤–∞—é—Ç—å—Å—è <strong>—Ñ–æ—Ä–º–∞–Ω—Ç–∞–º–∏</strong>. –¶–µ —Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω—ñ —á–∞—Å—Ç–æ—Ç–∏ –≤–∞—à–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ç—Ä–∞–∫—Ç—É (–≥–æ—Ä–ª–∞, —Ä–æ—Ç–æ–≤–æ—ó –ø–æ—Ä–æ–∂–Ω–∏–Ω–∏). –ú–∏ —Å—Ç–∏—Å–Ω—É–ª–∏ —Å–∫–ª–∞–¥–Ω—É —Ñ–æ—Ä–º—É —Å–ø–µ–∫—Ç—Ä–∞ –≤—Å—å–æ–≥–æ —É ${LPC_ORDER}$ —á–∏—Å–µ–ª!</p>
         
				<div class="concept-block">
    <h3>–ê–Ω–∞–ª—ñ–∑ vs –°–∏–Ω—Ç–µ–∑:</h3>
    <p>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ LPC –ø—Ä–∞—Ü—é—î —É –¥–≤–∞ –±–æ–∫–∏</p>
    <ul>
        <li><strong>–ê–Ω–∞–ª—ñ–∑ (–ö–æ–¥—É–≤–∞–Ω–Ω—è):</strong> –ú–∏ –±–µ—Ä–µ–º–æ —Å–∫–ª–∞–¥–Ω–∏–π –≥–æ–ª–æ—Å —ñ "–≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤—É—î–º–æ" –∑ –Ω—å–æ–≥–æ —Ñ–æ—Ä–º–∞–Ω—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–æ–º $A(z)$. –ù–∞ –≤–∏—Ö–æ–¥—ñ ‚Äî –ø—Ä–æ—Å—Ç–∏–π —à—É–º (–∑–∞–ª–∏—à–æ–∫). –¶–µ —è–∫ <em>–≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–∞–¥–ª–∏—à–∫–æ–≤–æ—Å—Ç—ñ</em>.</li>
        <li><strong>–°–∏–Ω—Ç–µ–∑ (–î–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è):</strong> –ú–∏ –±–µ—Ä–µ–º–æ –ø—Ä–æ—Å—Ç–∏–π —à—É–º —ñ –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —á–µ—Ä–µ–∑ –æ–±–µ—Ä–Ω–µ–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä $H(z) = 1/A(z)$. –í—ñ–Ω –¥—ñ—î —è–∫ —Ä–µ–∑–æ–Ω–∞—Ç–æ—Ä, –ø–æ–≤–µ—Ä—Ç–∞—é—á–∏ —Ñ–æ—Ä–º–∞–Ω—Ç–∏ –Ω–∞ –º—ñ—Å—Ü–µ. –¶–µ <em>–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–≤—É–∫—É</em>.</li>
    </ul>
</div>
				
			   `,
            action: () => {
                const sol = levinsonDurbin(r_coeffs, LPC_ORDER);
                lpc_coeffs = sol.a;
                drawLPCSpectrum(displayFrame, lpc_coeffs);
            }
        },
  

{
            title: "–ö—Ä–æ–∫ 5: –§–æ—Ä–º—É–≤–∞–Ω–Ω—è —Å–∏–≥–Ω–∞–ª—É",
            html: `
                <p>–†–æ–∑–∫–ª–∞–¥–µ–º–æ –ø—Ä–æ—Ü–µ—Å —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∑–≤—É–∫—É –Ω–∞ –æ–∫—Ä–µ–º—ñ —Å–∫–ª–∞–¥–æ–≤—ñ. –ó–∞–º—ñ—Å—Ç—å –Ω–∞–∫–ª–∞–¥–∞–Ω–Ω—è, –ø–æ–¥–∏–≤–∏–º–æ—Å—å –Ω–∞ –∫–æ–∂–µ–Ω –µ—Ç–∞–ø –æ–∫—Ä–µ–º–æ.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background:#f8fafc; padding:10px; border:1px solid #e2e8f0; border-radius:8px;">
                        <strong>1. –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ –∫–Ω–∏–≥–∞ (Pitch)</strong>
                        <p style="font-size:0.9em; margin:5px 0;">"–õ—É–Ω–∞" –∑ –º–∏–Ω—É–ª–æ–≥–æ ($g_p v[n]$). –§–æ—Ä–º—É—î –æ—Å–Ω–æ–≤—É —Ç–æ–Ω—É.</p>
                        <div style="height:120px;"><canvas id="chartPitch"></canvas></div>
                    </div>

                    <div style="background:#f8fafc; padding:10px; border:1px solid #e2e8f0; border-radius:8px;">
                        <strong>2. –ê–ª–≥–µ–±—Ä–∞—ó—á–Ω–∏–π –∫–æ–¥ (Code)</strong>
                        <p style="font-size:0.9em; margin:5px 0;">"–Ü–Ω–Ω–æ–≤–∞—Ü—ñ—è" ($g_c c[n]$). –†—ñ–¥–∫—ñ—Å–Ω—ñ —ñ–º–ø—É–ª—å—Å–∏ –¥–ª—è –∫–æ—Ä–µ–∫—Ü—ñ—ó.</p>
                        <div style="height:120px;"><canvas id="chartCode"></canvas></div>
                    </div>
                </div>

                <div style="margin-top:15px; background:#fff1f2; padding:15px; border:1px solid #fecaca; border-radius:8px;">
                    <strong>3. –í—ñ–¥–≥—É–∫ —Ñ—ñ–ª—å—Ç—Ä–∞ –Ω–∞ –∫–æ–¥</strong>
                    <p>–©–æ –±—É–¥–µ, —è–∫—â–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ —á–µ—Ä–µ–∑ –≥–æ–ª–æ—Å–æ–≤–∏–π —Ç—Ä–∞–∫—Ç (—Ñ—ñ–ª—å—Ç—Ä $1/A(z)$) <em>—Ç—ñ–ª—å–∫–∏</em> —á–µ—Ä–≤–æ–Ω—ñ —ñ–º–ø—É–ª—å—Å–∏ -–∫–æ–¥–∏? 
                    –§—ñ–ª—å—Ç—Ä –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —ó—Ö, –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—á–∏ –∫–æ—Ä–æ—Ç–∫—ñ —ñ–º–ø—É–ª—å—Å–∏ –Ω–∞ –ø–ª–∞–≤–Ω—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è-–≤—ñ–¥–≥—É–∫–∏. –¶–µ –Ω–∞–∑–∏–≤–∞—é—Ç—å —ñ–º–ø—É–ª—å—Å–Ω–æ—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–æ—é —Ñ—ñ–ª—å—Ç—Ä–∞ (Impulse response)</p>
                    <div style="height:150px;"><canvas id="chartCodeSynth"></canvas></div>
                </div>

              
            `,
            action: () => {
                // 1. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö (Target)
                const targetRes = filterFIR(displayFrame, [1, ...lpc_coeffs]);
                
                // 2. –°–∏–º—É–ª—è—Ü—ñ—è PITCH (v[n])
                let bestLag = 20; let maxCorr = -Infinity;
                for(let L=20; L<140; L++) {
                    let c = 0; for(let i=0; i<targetRes.length-L; i++) c+=targetRes[i]*targetRes[i+L];
                    if(c>maxCorr){ maxCorr=c; bestLag=L; }
                }
                let v_n = new Float32Array(targetRes.length);
                for(let i=0; i<targetRes.length; i++) v_n[i] = targetRes[Math.abs(i-bestLag)%targetRes.length];
                let g_p = 0.75; // –§—ñ–∫—Å–æ–≤–∞–Ω–∏–π gain –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó

                // 3. –°–∏–º—É–ª—è—Ü—ñ—è CODE (c[n]) - Matching Pursuit
                let error = new Float32Array(targetRes.length);
                for(let i=0; i<targetRes.length; i++) error[i] = targetRes[i] - (g_p * v_n[i]);
                
                let c_n = new Float32Array(targetRes.length).fill(0);
                let tempErr = [...error];
                // –®—É–∫–∞—î–º–æ 6 —ñ–º–ø—É–ª—å—Å—ñ–≤
                for(let k=0; k<6; k++) {
                    let m=0, midx=0;
                    for(let i=0; i<tempErr.length; i++) if(Math.abs(tempErr[i])>m){m=Math.abs(tempErr[i]); midx=i;}
                    c_n[midx] = tempErr[midx] > 0 ? 1 : -1;
                    tempErr[midx] = 0; // –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø—ñ–∫
                }
                // Gain –∫–æ–¥—É (—Å–µ—Ä–µ–¥–Ω—è –µ–Ω–µ—Ä–≥—ñ—è –ø–æ–º–∏–ª–∫–∏ –≤ –ø—ñ–∫–∞—Ö)
                let g_c = 0; let cnt=0;
                for(let i=0; i<c_n.length; i++) if(c_n[i]!=0) { g_c += Math.abs(error[i]); cnt++; }
                g_c = (g_c/ (cnt||1));

                // 4. –°–∏–Ω—Ç–µ–∑ –≤—ñ–¥–≥—É–∫—É –Ω–∞ –∫–æ–¥ (Code Synthesis)
                // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –¢–Ü–õ–¨–ö–ò –∫–æ–¥ —á–µ—Ä–µ–∑ —Ñ—ñ–ª—å—Ç—Ä 1/A(z)
                // –î–ª—è —Ü—å–æ–≥–æ –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø–∞–º'—è—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∞ (–Ω—É–ª—å–æ–≤–∞ –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É)
                let codeSignal = c_n.map(x => x * g_c);
                let codeSynth = filterIIR(codeSignal, [1, ...lpc_coeffs], new Float32Array(LPC_ORDER).fill(0));

                // 5. –ü–æ–≤–Ω–∞ —Å—É–º–∞ –∑–±—É–¥–∂–µ–Ω–Ω—è
                let u_n = new Float32Array(targetRes.length);
                for(let i=0; i<u_n.length; i++) u_n[i] = (g_p * v_n[i]) + (g_c * c_n[i]);

                // --- –ú–ê–õ–Æ–í–ê–ù–ù–Ø ---
                
                // Helper –¥–ª—è –º—ñ–Ω—ñ-–≥—Ä–∞—Ñ—ñ–∫—ñ–≤
                const drawMini = (id, data, color, type='line') => {
                    new Chart(document.getElementById(id).getContext('2d'), {
                        type: type,
                        data: { labels: [...Array(data.length).keys()], datasets: [{data: [...data], borderColor:color, backgroundColor:color, borderWidth:1.5, pointRadius:0, barThickness:3}] },
                        options: { 
                            responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
                            scales:{x:{display:false}, y:{display:false}} 
                        }
                    });
                };

                // –ì—Ä–∞—Ñ—ñ–∫ 1: Pitch
                drawMini('chartPitch', v_n.map(x=>x*g_p), '#2563eb');
                
                // –ì—Ä–∞—Ñ—ñ–∫ 2: Code (Bar chart)
                drawMini('chartCode', c_n.map(x=>x*g_c), '#dc2626', 'bar');

                // –ì—Ä–∞—Ñ—ñ–∫ 3: Code Synthesis (Response)
                // –¢—É—Ç —Ü—ñ–∫–∞–≤–æ –ø–æ–∫–∞–∑–∞—Ç–∏ —ñ —ñ–º–ø—É–ª—å—Å–∏ (–±–ª—ñ–¥–æ) —ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—è—Å–∫—Ä–∞–≤–æ)
                new Chart(document.getElementById('chartCodeSynth').getContext('2d'), {
                    type: 'line',
                    data: { 
                        labels: [...Array(codeSynth.length).keys()], 
                        datasets: [
                            { label: '–Ü–º–ø—É–ª—å—Å–∏', data: c_n.map(x=>x*g_c*3), type:'bar', backgroundColor:'rgba(220, 38, 38, 0.2)', barThickness:2, order:2 },
                            { label: '–í—ñ–¥–≥—É–∫ —Ñ—ñ–ª—å—Ç—Ä–∞', data: [...codeSynth], borderColor:'#be123c', borderWidth:2, pointRadius:0, order:1 }
                        ] 
                    },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}} }
                });

                // –ì–æ–ª–æ–≤–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ (–ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑–∞–ª–∏—à–∫—ñ–≤)
                drawDualChart(targetRes, u_n, "–û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫", "–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–∏–π (Pitch + Code)");
            }
        },


  {
            title: "–ö—Ä–æ–∫ 6: ACELP",
            html: `
                <p>–§–æ—Ä–º—É–ª–∞ $u[n] = g_p v[n] + g_c c[n]$ ‚Äî —Ü–µ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è "–∑–±–æ—Ä–∫–∏" –∑–≤—É–∫—É –∑ –¥–≤–æ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤. –í—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ —É –¥–≤–∞ –µ—Ç–∞–ø–∏:</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background:#eff6ff; padding:15px; border-radius:8px; border:1px solid #bfdbfe;">
                        <h4 style="margin-top:0; color:#1e40af;">1. –®–∞—Ä "–ü–∞–º'—è—Ç—å" ($g_p v[n]$)</h4>
                        <p><strong>v[n] (–í–µ–∫—Ç–æ—Ä –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—ó –∫–Ω–∏–≥–∏):</strong> –¶–µ "–ª—É–Ω–∞" –∑ –º–∏–Ω—É–ª–æ–≥–æ. –ë–µ—Ä–µ–º–æ —à–º–∞—Ç–æ–∫ –∑–≤—É–∫—É, —è–∫–∏–π –±—É–≤ $T$ —Å–µ–º–ø–ª—ñ–≤ —Ç–æ–º—É. –¶–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ <em>–æ—Å–Ω–æ–≤–Ω–∏–π —Ç–æ–Ω (Pitch)</em>.</p>
                        <p><strong>g_p (Gain Pitch):</strong> –ì—É—á–Ω—ñ—Å—Ç—å —Ü—ñ—î—ó "–ª—É–Ω–∏".</p>
                    </div>
                    <div style="background:#fef2f2; padding:15px; border-radius:8px; border:1px solid #fecaca;">
                        <h4 style="margin-top:0; color:#991b1b;">2. –®–∞—Ä "–Ü–Ω–Ω–æ–≤–∞—Ü—ñ—è" ($g_c c[n]$)</h4>
                        <p><strong>c[n] (–í–µ–∫—Ç–æ—Ä —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—ó –∫–Ω–∏–≥–∏):</strong> –¶–µ —Ç–µ, —á–æ–≥–æ –Ω–µ –±—É–ª–æ –≤ –º–∏–Ω—É–ª–æ–º—É. –¶–µ –Ω–∞–±—ñ—Ä –∑ –ª–∏—à–µ 4-—Ö —ñ–º–ø—É–ª—å—Å—ñ–≤ (+1 –∞–±–æ -1) –Ω–∞ 40 —Å–µ–º–ø–ª—ñ–≤. –¶–µ –¥–æ–¥–∞—î —á—ñ—Ç–∫—ñ—Å—Ç—å —ñ –¥–µ—Ç–∞–ª—ñ.</p>
                        <p><strong>g_c (Gain Code):</strong> –ì—É—á–Ω—ñ—Å—Ç—å —Ü–∏—Ö —ñ–º–ø—É–ª—å—Å—ñ–≤.</p>
                    </div>
                </div>

                <p>ACELP –∞–ª–≥–æ—Ä–∏—Ç–º:</p>
                <ol>
                    <li><strong>–ö—Ä–æ–∫ 1:</strong> –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞–π–∫—Ä–∞—â–∏–π —à–º–∞—Ç–æ–∫ –∑ –º–∏–Ω—É–ª–æ–≥–æ ($v[n]$), —â–æ–± –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ñ–æ—Ä–º—É —Ö–≤–∏–ª—ñ. –í—ñ–¥–Ω—ñ–º–∞—î–º–æ –π–æ–≥–æ.</li>
                    <li><strong>–ö—Ä–æ–∫ 2:</strong> –¢–µ, —â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å (–ø–æ–º–∏–ª–∫–∞), –º–∏ –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∫—ñ–ª—å–∫–æ–º–∞ —ñ–º–ø—É–ª—å—Å–∞–º–∏ ($c[n]$).</li>
                </ol>
                <div class="math-block">
                $$ \\text{–ó–∞–≥–∞–ª—å–Ω–µ –∑–±—É–¥–∂–µ–Ω–Ω—è } u[n] = \\underbrace{g_p v[n]}_{\\text{–ú–∏–Ω—É–ª–µ}} + \\underbrace{g_c c[n]}_{\\text{–ù–æ–≤—ñ —ñ–º–ø—É–ª—å—Å–∏}} $$
                </div>
                <p>–ù–∞ –≥—Ä–∞—Ñ—ñ–∫—É –Ω–∏–∂—á–µ: <br>
                <span style="color:#2563eb; font-weight:bold;">–°–∏–Ω—è –ª—ñ–Ω—ñ—è</span> ‚Äî —Ü–µ –≤–Ω–µ—Å–æ–∫ –º–∏–Ω—É–ª–æ–≥–æ (Pitch).<br>
                <span style="color:#dc2626; font-weight:bold;">–ß–µ—Ä–≤–æ–Ω—ñ —Å—Ç–æ–≤–ø—á–∏–∫–∏</span> ‚Äî —Ü–µ –∞–ª–≥–µ–±—Ä–∞—ó—á–Ω–∏–π –∫–æ–¥ (Code).<br>
                <span style="color:#16a34a; font-weight:bold;">–ó–µ–ª–µ–Ω–∞ –ª—ñ–Ω—ñ—è</span> ‚Äî —Å—É–º–∞ ($u[n]$), —è–∫–∞ –π–¥–µ –Ω–∞ —Å–∏–Ω—Ç–µ–∑.</p>
				
				 <p>–î–∞–ª—ñ —Ñ–æ—Ä–º—É—î—Ç—å—Å—è –ø–∞–∫–µ—Ç –¥–∞–Ω–∏—Ö –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ.</p>

                <div style="background:#f8fafc; border:1px solid #e2e8f0; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h3 style="margin-top:0;">–í –º–µ—Ä–µ–∂—É –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è (–í—Å—å–æ–≥–æ ~150 –±—ñ—Ç):</h3>
                    <div style="display:flex; gap:5px; font-family:monospace; font-size:0.9em; flex-wrap:wrap;">
                        <div style="background:#fee2e2; padding:5px 10px; border-radius:4px; border:1px solid #fecaca;">
                            <strong>LPC Coeffs</strong><br>–§—ñ–ª—å—Ç—Ä (–†–æ—Ç)<br>~40 bits
                        </div>
                        <div style="background:#dbeafe; padding:5px 10px; border-radius:4px; border:1px solid #bfdbfe;">
                            <strong>Pitch Lag (T)</strong><br>–ü–µ—Ä—ñ–æ–¥ —Ç–æ–Ω—É<br>~8 bits
                        </div>
                        <div style="background:#dbeafe; padding:5px 10px; border-radius:4px; border:1px solid #bfdbfe;">
                            <strong>Pitch Gain</strong><br>–ì—É—á–Ω—ñ—Å—Ç—å —Ç–æ–Ω—É<br>~4 bits
                        </div>
                        <div style="background:#dcfce7; padding:5px 10px; border-radius:4px; border:1px solid #bbf7d0;">
                            <strong>Code Index</strong><br>–ü–æ–∑–∏—Ü—ñ—ó —ñ–º–ø—É–ª—å—Å—ñ–≤<br>~35 bits
                        </div>
                        <div style="background:#dcfce7; padding:5px 10px; border-radius:4px; border:1px solid #bbf7d0;">
                            <strong>Code Gain</strong><br>–ì—É—á–Ω—ñ—Å—Ç—å –∫–æ–¥—É<br>~5 bits
                        </div>
                    </div>
                </div>

                <h3>–ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∫–æ–¥—ñ–≤</h3>
                <p>–ü–µ—Ä–µ–±—Ä–∞—Ç–∏ –≤—Å—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –¥–æ–≤–≥–æ ($40^4$ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ–π). ACELP –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î <strong>"—Ç—Ä–µ–∫–∏" (Interleaved Tracks)</strong>:</p>
                <ul>
                    <li>–Ü–º–ø—É–ª—å—Å 1 —Å—Ç–∞–≤–∏—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ –ø–æ–∑–∏—Ü—ñ—ó: 0, 5, 10, 15...</li>
                    <li>–Ü–º–ø—É–ª—å—Å 2 —Å—Ç–∞–≤–∏—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ –ø–æ–∑–∏—Ü—ñ—ó: 1, 6, 11, 16...</li>
                </ul>
                <p>–ö–æ–¥–µ—Ä –ø–µ—Ä–µ–±–∏—Ä–∞—î –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –≤ —Ü–∏—Ö –º–µ–∂–∞—Ö, –∫–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É –ø—Ä–æ–ø—É—Å–∫–∞—é—á–∏ –≤–∞—Ä—ñ–∞–Ω—Ç —á–µ—Ä–µ–∑ <strong>–§—ñ–ª—å—Ç—Ä –°–∏–Ω—Ç–µ–∑—É (Step 4)</strong> —ñ –ø–æ—Ä—ñ–≤–Ω—é—é—á–∏ –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª–æ–º (Analysis-by-Synthesis). –û–±–∏—Ä–∞—î—Ç—å—Å—è —Ç–æ–π –∫–æ–¥, —è–∫–∏–π –¥–∞—î –Ω–∞–π–º–µ–Ω—à—É –ø–æ–º–∏–ª–∫—É <em>–¥–ª—è –≤—É—Ö–∞</em>.</p>
                
				
				
            `,
            action: () => {
                // 1. –û—Ç—Ä–∏–º—É—î–º–æ —ñ–¥–µ–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫ (Target)
                const targetRes = filterFIR(displayFrame, [1, ...lpc_coeffs]);
                
                // 2. –°–ò–ú–£–õ–Ø–¶–Ü–Ø ACELP –ü–û–®–£–ö–£ (–°–ø—Ä–æ—â–µ–Ω–∞)
                
                // –ê) –ó–Ω–∞—Ö–æ–¥–∏–º–æ Pitch (v[n])
                // –®—É–∫–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É (Lag), —è–∫–∞ –¥–∞—î –∫—Ä–∞—â—É –∫–æ—Ä–µ–ª—è—Ü—ñ—é
                let bestLag = 20;
                let maxCorr = -Infinity;
                // –ü—Ä–æ—Å—Ç–∏–π –ø–æ—à—É–∫ –ø—ñ—Ç—á–∞ –≤ –º–µ–∂–∞—Ö 20..140
                for(let L=20; L<140; L++) {
                    let corr = 0;
                    // –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –∑–∞–ª–∏—à–æ–∫ –∑ –π–æ–≥–æ –∂ –≤–µ—Ä—Å—ñ—î—é, –∑—Å—É–Ω—É—Ç–æ—é –Ω–∞ L (—ñ–º—ñ—Ç–∞—Ü—ñ—è –±—É—Ñ–µ—Ä–∞)
                    // (–¢—É—Ç –¥–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è –±–µ—Ä–µ–º–æ –∞–≤—Ç–æ–∫–æ—Ä–µ–ª—è—Ü—ñ—é –≤—ñ–∫–æ–Ω–∏)
                    for(let i=0; i<targetRes.length-L; i++) corr += targetRes[i] * targetRes[i+L];
                    if(corr > maxCorr) { maxCorr = corr; bestLag = L; }
                }

                // –°—Ç–≤–æ—Ä—é—î–º–æ –≤–µ–∫—Ç–æ—Ä v[n] (Pitch contribution)
                // –£ —Ä–µ–∞–ª—å–Ω–æ–º—É –∫–æ–¥–µ–∫—É —Ü–µ –±–µ—Ä–µ—Ç—å—Å—è –∑ "adaptive codebook" (–º–∏–Ω—É–ª–æ–≥–æ —Å–∏–Ω—Ç–µ–∑—É)
                // –¢—É—Ç –º–∏ –∑—ñ–º—ñ—Ç—É—î–º–æ —Ü–µ, –≤–∑—è–≤—à–∏ —Å–∏–≥–Ω–∞–ª –∑—Å—É–Ω—É—Ç–∏–π –Ω–∞ bestLag
                let v_n = new Float32Array(targetRes.length);
                // –ó–∞–ø–æ–≤–Ω—é—î–º–æ "–∑ –º–∏–Ω—É–ª–æ–≥–æ" (—Ü–∏–∫–ª—ñ—á–Ω–æ, —è–∫—â–æ lag –∫–æ—Ä–æ—Ç–∫–∏–π)
                for(let i=0; i<targetRes.length; i++) {
                    let pastIdx = i - bestLag;
                    if (pastIdx < 0) pastIdx += bestLag; // –≥—Ä—É–±–∞ —ñ–º—ñ—Ç–∞—Ü—ñ—è –∫—ñ–ª—å—Ü–µ–≤–æ–≥–æ –±—É—Ñ–µ—Ä–∞
                    // –ê–±–æ –ø—Ä–æ—Å—Ç–æ –≤—ñ–∑—å–º–µ–º–æ —Å–∏–Ω—É—Å–æ—ó–¥—É –Ω–∞ —á–∞—Å—Ç–æ—Ç—ñ –ø—ñ—Ç—á–∞ –¥–ª—è –∫—Ä–∞—Å–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏, 
                    // –±–æ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –±—É—Ñ–µ—Ä —É –Ω–∞—Å —Ç—É—Ç –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π
                     v_n[i] = targetRes[ Math.abs(i - bestLag) % targetRes.length ] * 0.8; 
                }
                
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ g_p (Gain) - –Ω–∞—Å–∫—ñ–ª—å–∫–∏ "—Å–∏–ª—å–Ω–∏–π" –ø—ñ—Ç—á
                // –ü—Ä–æ—Å—Ç–æ –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ 0.8 –¥–ª—è –¥–µ–º–æ –∞–±–æ –ø–æ—Ä–∞—Ö—É—î–º–æ –ø—Ä–æ–µ–∫—Ü—ñ—é
                let g_p = 0.8; 

                // –ë) –ó–Ω–∞—Ö–æ–¥–∏–º–æ Code (c[n]) - Matching Pursuit
                // –í—ñ–¥–Ω—ñ–º–∞—î–º–æ –ø—ñ—Ç—á –≤—ñ–¥ –æ—Ä–∏–≥—ñ–Ω–∞–ª—É, –æ—Ç—Ä–∏–º—É—î–º–æ –ø–æ–º–∏–ª–∫—É, —è–∫—É —Ç—Ä–µ–±–∞ –∑–∞–∫—Ä–∏—Ç–∏ –∫–æ–¥–æ–º
                let error = new Float32Array(targetRes.length);
                for(let i=0; i<targetRes.length; i++) error[i] = targetRes[i] - (g_p * v_n[i]);

                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø—ñ–∫–∏ (Pulse Search) -
                let c_n = new Float32Array(targetRes.length).fill(0);
                
                // –ó–Ω–∞–π–¥–µ–º–æ 5 –Ω–∞–π—Å–∏–ª—å–Ω—ñ—à–∏—Ö –ø—ñ–∫—ñ–≤ (MP iteration)
                let tempErr = [...error];
                for(let k=0; k<8; k++) {
                    let maxVal = 0; let maxIdx = 0;
                    for(let i=0; i<tempErr.length; i++) {
                        if(Math.abs(tempErr[i]) > maxVal) { maxVal = Math.abs(tempErr[i]); maxIdx = i; }
                    }
                    // –°—Ç–∞–≤–∏–º–æ —ñ–º–ø—É–ª—å—Å
                    let sign = tempErr[maxIdx] > 0 ? 1 : -1;
                    c_n[maxIdx] = sign; 
                    
                    // "–í—ñ–¥–Ω—ñ–º–∞—î–º–æ" —Ü–µ–π –ø—ñ–∫ (Matching Pursuit)
                    tempErr[maxIdx] = 0; // –°–ø—Ä–æ—â–µ–Ω–æ –∑–∞–Ω—É–ª—é—î–º–æ
                }
                
                // g_c - –∞–º–ø–ª—ñ—Ç—É–¥–∞ –ø—ñ–∫—ñ–≤
                let g_c = 0;
                // –û—Ü—ñ–Ω–∏–º–æ —Å–µ—Ä–µ–¥–Ω—é –∞–º–ø–ª—ñ—Ç—É–¥—É –ø–æ–º–∏–ª–∫–∏ –≤ –º—ñ—Å—Ü—è—Ö –ø—ñ–∫—ñ–≤
                let peaksCount = 0;
                for(let i=0; i<c_n.length; i++) {
                    if(c_n[i] !== 0) { g_c += Math.abs(error[i]); peaksCount++; }
                }
                g_c = (g_c / (peaksCount || 1));

                // –í) –§—ñ–Ω–∞–ª—å–Ω–∞ —Å—É–º–∞
                let u_n = new Float32Array(targetRes.length);
                for(let i=0; i<u_n.length; i++) {
                    u_n[i] = (g_p * v_n[i]) + (g_c * c_n[i]);
                }

                // –ì–†–ê–§–Ü–ö
                // –ú–∞–ª—é—î–º–æ —Ç—Ä–∏ —Å–∫–ª–∞–¥–æ–≤—ñ
                document.getElementById('chart2Container').style.display = 'block';
                const ctx = document.getElementById('secChart').getContext('2d');
                if(chart2) chart2.destroy();
                
                chart2 = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: [...Array(targetRes.length).keys()], 
                        datasets: [
                            {
                                label: "1. Pitch (–ú–∏–Ω—É–ª–µ) g_p*v[n]", 
                                data: [...v_n].map(x => x * g_p), 
                                borderColor: '#2563eb', 
                                borderWidth: 2, 
                                pointRadius: 0,
                                borderDash: [5, 5], // –ü—É–Ω–∫—Ç–∏—Ä
                                order: 2
                            },
                            {
                                label: "2. Code (–Ü–º–ø—É–ª—å—Å–∏) g_c*c[n]", 
                                data: [...c_n].map(x => x * g_c), 
                                type: 'bar', // –°—Ç–æ–≤–ø—á–∏–∫–∏ –¥–ª—è —ñ–º–ø—É–ª—å—Å—ñ–≤
                                backgroundColor: '#dc2626',
                                barThickness: 3,
                                order: 1
                            },
                            {
                                label: "3. –°—É–º–∞ (u[n])", 
                                data: [...u_n], 
                                borderColor: '#16a34a', 
                                borderWidth: 2, 
                                pointRadius: 0,
                                order: 0
                            }
                        ] 
                    },
                    options: { 
                        responsive:true, 
                        maintainAspectRatio:false, 
                        animation: { duration: 2000 }, // –ê–Ω—ñ–º–∞—Ü—ñ—è —â–æ–± –±—É–ª–æ –≤–∏–¥–Ω–æ —è–∫ –±—É–¥—É—î—Ç—å—Å—è
                        interaction: { mode: 'index', intersect: false }
                    }
                });
                
                // –í–µ—Ä—Ö–Ω—ñ–π –≥—Ä–∞—Ñ—ñ–∫ - –æ—Ä–∏–≥—ñ–Ω–∞–ª –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
                drawWaveform(targetRes, "–û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –ó–∞–ª–∏—à–æ–∫ (–¶—ñ–ª—å)");
            }
        },
     
	 //////-----------
	 
	 {
            title: "–ö—Ä–æ–∫ 7: –ë–∞–ª–∞–Ω—Å —è–∫–æ—Å—Ç—ñ —Ç–∞ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è",
            html: `
                <p>–í —Ä–µ–∞–ª—å–Ω–∏—Ö –∫–æ–¥–µ–∫–∞—Ö –º–∏ –æ–±–º–µ–∂–µ–Ω—ñ —à–≤–∏–¥–∫—ñ—Å—Ç—é —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É (–±—ñ—Ç—Ä–µ–π—Ç–æ–º). –ú–∏ –Ω–µ –º–æ–∂–µ–º–æ –ø–µ—Ä–µ–¥–∞—Ç–∏ —ñ–¥–µ–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫.</p>
                <p>–ú–∏ –∑–º—É—à–µ–Ω—ñ –≤–∏–±–∏—Ä–∞—Ç–∏ –ª–∏—à–µ –¥–µ–∫—ñ–ª—å–∫–∞ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∏—Ö —ñ–º–ø—É–ª—å—Å—ñ–≤. –¶–µ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è <strong>Sparse Coding (–†–æ–∑—Ä—ñ–¥–∂–µ–Ω–µ –∫–æ–¥—É–≤–∞–Ω–Ω—è)</strong>.</p>
                
                <div class="theory-box" style="padding: 15px; border-left-color: #f59e0b; background: #fffbeb;">
                    <strong>–°–ø—Ä–æ–±—É–π—Ç–µ —Å–∞–º—ñ:</strong> –†—É—Ö–∞–π—Ç–µ —Å–ª–∞–π–¥–µ—Ä, —â–æ–± –¥–æ–¥–∞—Ç–∏ –±—ñ–ª—å—à–µ —ñ–º–ø—É–ª—å—Å—ñ–≤ –∫–æ–¥—É ($c[n]$) –¥–æ —Å–∏–≥–Ω–∞–ª—É.
                    <ul style="margin-bottom:0;">
                        <li><strong>0 —ñ–º–ø—É–ª—å—Å—ñ–≤:</strong> –ß—É—Ç–∏ —Ç—ñ–ª—å–∫–∏ "—Ä–æ–±–æ—Ç–∏–∑–æ–≤–∞–Ω–∏–π" –≥—É–ª (–ø—Ä–∞—Ü—é—î –ª–∏—à–µ Pitch).</li>
                        <li><strong>4-10 —ñ–º–ø—É–ª—å—Å—ñ–≤:</strong> –°—Ç–∞–Ω–¥–∞—Ä—Ç –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É (GSM/ACELP).</li>
                        <li><strong>40+ —ñ–º–ø—É–ª—å—Å—ñ–≤:</strong> –í–∏—Å–æ–∫–∞ —è–∫—ñ—Å—Ç—å, –º–∞–π–∂–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª.</li>
                    </ul>
                </div>

                <div class="slider-section" style="display:block; margin-top:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ–º–ø—É–ª—å—Å—ñ–≤ (–¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è):</strong>
                        <span id="pulseCountLabel" style="font-weight:bold; color:#2563eb; font-size:1.2em;">0</span>
                    </div>
                    <input type="range" id="pulseDemoSlider" min="0" max="64" value="0" step="1" style="width:100%" oninput="updatePulseDemo(this.value)">
                    <div style="display:flex; justify-content:space-between; font-size:0.8em; color:#64748b; margin-top:5px;">
                        <span>–¢—ñ–ª—å–∫–∏ –¢–æ–Ω (Pitch)</span>
                        <span>–°—Ç–∞–Ω–¥–∞—Ä—Ç ACELP (~4)</span>
                        <span>–í–∏—Å–æ–∫–∞ —è–∫—ñ—Å—Ç—å</span>
                    </div>
                </div>

                <p style="font-size: 0.9em; margin-top: 15px;">
                    <span style="color:#2563eb">üü¶ –°–∏–Ω—è –ª—ñ–Ω—ñ—è</span>: –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –≥–æ–ª–æ—Å.<br>
                    <span style="color:#dc2626">üü• –ß–µ—Ä–≤–æ–Ω–∞ –ª—ñ–Ω—ñ—è</span>: –°–∏–Ω—Ç–µ–∑–æ–≤–∞–Ω–∏–π –≥–æ–ª–æ—Å. –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —è–∫ —á–µ—Ä–≤–æ–Ω–∞ –ª—ñ–Ω—ñ—è "–ø—Ä–∏–ª–∏–ø–∞—î" –¥–æ —Å–∏–Ω—å–æ—ó –ø—Ä–∏ –∑–±—ñ–ª—å—à–µ–Ω–Ω—ñ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —ñ–º–ø—É–ª—å—Å—ñ–≤.
                </p>
            `,
            action: () => {
                // 1. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö (–ö–µ—à—É–≤–∞–Ω–Ω—è –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞)
                // –†–æ–±–∏–º–æ –∞–Ω–∞–ª—ñ–∑ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –≤—Ö–æ–¥—ñ –≤ –∫—Ä–æ–∫
                
                // –∞) –ó–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–¥–µ–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫
                const targetRes = filterFIR(displayFrame, [1, ...lpc_coeffs]);
                
                // –±) –ó–Ω–∞—Ö–æ–¥–∏–º–æ Pitch –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (—è–∫ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –∫—Ä–æ–∫–∞—Ö)
                let bestLag = 20; let maxCorr = -Infinity;
                for(let L=20; L<140; L++) {
                    let c = 0; for(let i=0; i<targetRes.length-L; i++) c+=targetRes[i]*targetRes[i+L];
                    if(c>maxCorr){ maxCorr=c; bestLag=L; }
                }
                
                let v_n = new Float32Array(targetRes.length);
                for(let i=0; i<targetRes.length; i++) v_n[i] = targetRes[Math.abs(i-bestLag)%targetRes.length];
                
                // –û—Ü—ñ–Ω–∫–∞ Gain Pitch (–ø—Ä–æ—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ü—ñ—è)
                let num=0, den=0;
                for(let i=0; i<targetRes.length; i++) { num += targetRes[i]*v_n[i]; den += v_n[i]*v_n[i]; }
                let g_p = (den > 0.001) ? num/den : 0;
                if(g_p > 1.2) g_p = 1.2; // Limiter

                // –≤) –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω–∏–π –æ–±'—î–∫—Ç –¥–ª—è –¥–æ—Å—Ç—É–ø—É –∑ —Ñ—É–Ω–∫—Ü—ñ—ó —Å–ª–∞–π–¥–µ—Ä–∞
                window.step7Cache = {
                    targetRes: targetRes,
                    v_n: v_n,
                    g_p: g_p,
                    lpc: [1, ...lpc_coeffs],
                    origSignal: displayFrame
                };

                // 2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≥—Ä–∞—Ñ—ñ–∫–∞ (0 —ñ–º–ø—É–ª—å—Å—ñ–≤)
                document.getElementById('pulseDemoSlider').value = 0;
                updatePulseDemo(0);
            }
        },
	 
//////-----------
	  {
            title: "–§—ñ–Ω–∞–ª: –í–æ–∫–æ–¥–µ—Ä",
            html: `
                <p>–¢–µ–ø–µ—Ä –º–∏ –º–∞—î–º–æ –≤—Å–µ –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–æ–ª–æ—Å—É:</p>
                <ol>
                    <li>–§—ñ–ª—å—Ç—Ä $1/A(z)$ (—Ñ–æ—Ä–º–∞ —Ä–æ—Ç–æ–≤–æ—ó –ø–æ—Ä–æ–∂–Ω–∏–Ω–∏ —ñ –≥–æ—Ä–ª–∞).</li>
                    <li>–î–∂–µ—Ä–µ–ª–æ –∑–±—É–¥–∂–µ–Ω–Ω—è –∫–æ–¥–∏-—ñ–º–ø—É–ª—å—Å–∏ (–≥–æ–ª–æ—Å–æ–≤—ñ –∑–≤'—è–∑–∫–∏).</li>
                </ol>
                 `,
            action: () => {
                document.getElementById('vocoderControls').style.display = 'block';
                // Demo
                const res = filterFIR(displayFrame, [1, ...lpc_coeffs]);
                const synth = filterIIR(res, [1, ...lpc_coeffs]);
                drawDualChart(displayFrame, synth, "–û—Ä–∏–≥—ñ–Ω–∞–ª", "–°–∏–Ω—Ç–µ–∑");
            }
        }
    ];

    // --- –õ–û–ì–Ü–ö–ê –Ü–ù–¢–ï–†–§–ï–ô–°–£ ---

    async function startRecording() {
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.resume();
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const recorder = new MediaRecorder(stream);
            const chunks = [];
            
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks);
                const buf = await blob.arrayBuffer();
                const decoded = await audioCtx.decodeAudioData(buf);
                fullBuffer = decoded.getChannelData(0);
                
                // Pre-emphasis (High-pass filter)
                for(let i=fullBuffer.length-1; i>0; i--) fullBuffer[i] -= 0.95 * fullBuffer[i-1];

                // –ó–Ω–∞–π—Ç–∏ –≥—É—á–Ω–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç
                let maxE = 0, idx = 0;
                for(let i=1000; i<fullBuffer.length-FRAME_SIZE-1000; i+=200) {
                    let e = 0; 
                    for(let j=0; j<FRAME_SIZE; j++) e += Math.abs(fullBuffer[i+j]);
                    if(e > maxE) { maxE = e; idx = i; }
                }
                displayFrame = fullBuffer.slice(idx, idx+FRAME_SIZE);

                document.getElementById('status').innerText = "–ó–∞–ø–∏—Å–∞–Ω–æ!";
                document.getElementById('btnRecord').disabled = true;
                document.getElementById('btnStep').disabled = false;
                document.getElementById('btnReset').style.display = 'inline-block';
                nextStep();
            };
            
            recorder.start();
            document.getElementById('status').innerText = "–°–∫–∞–∂—ñ—Ç—å —Å–ª–æ–≤–æ";
            setTimeout(() => recorder.stop(), 1500);
            
        } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞: " + e); }
    }

    function nextStep() {
        if(currentStep < steps.length) {
            const s = steps[currentStep];
            const container = document.getElementById('theoryContent');
            
            // 1. –û–Ω–æ–≤–ª—é—î–º–æ HTML
            container.innerHTML = `<h2>${s.title}</h2>` + s.html;
            
            // 2. –í–∏–∫–ª–∏–∫–∞—î–º–æ MathJax —Ä–µ–Ω–¥–µ—Ä (Promise-based)
            MathJax.typesetPromise([container]).then(() => {
                // 3. –í–∏–∫–æ–Ω—É—î–º–æ –≥—Ä–∞—Ñ—ñ—á–Ω—ñ –¥—ñ—ó –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä—É
                s.action();
            });

            currentStep++;
            if(currentStep >= steps.length) document.getElementById('btnStep').disabled = true;
        }
    }

    // --- –ê–£–î–Ü–û –î–í–ò–ì–£–ù (PIPELINE) ---

    function processAudio(ratio) {
        // ratio: 0 (Buzz) -> 1 (Original Residual)
        const blockSize = 512;
        const out = new Float32Array(fullBuffer.length);
        const synthesisMem = new Float32Array(LPC_ORDER).fill(0);
        
        for(let i=0; i < fullBuffer.length - blockSize; i+=blockSize) {
            let frame = fullBuffer.slice(i, i+blockSize);
            
            // Analysis
            let wFrame = applyHamming(frame);
            let r = autocorrelate(wFrame, LPC_ORDER);
            if (r[0] < 0.00001) continue; 
            
            let lpc = levinsonDurbin(r, LPC_ORDER).a;
            
            // Pitch Detection (Simplified)
            let r_pitch = autocorrelate(wFrame, 150);
            let lag = 50; let maxV = -Infinity;
            for(let k=20; k<145; k++) {
                 if(r_pitch[k]>maxV && r_pitch[k]>r_pitch[k-1] && r_pitch[k]>r_pitch[k+1]) { maxV=r_pitch[k]; lag=k; }
            }
            
            // Residual
            let res = filterFIR(frame, [1, ...lpc]);
            
            // Modification (Vocoder)
            let modRes = new Float32Array(res.length);
            
            // Generate Synthetic Buzz
            let buzz = new Float32Array(res.length);
            let energy = 0; for(let v of res) energy += v*v;
            let rms = Math.sqrt(energy/res.length);
            
            for(let n=0; n<res.length; n++) {
                if(n % lag === 0) buzz[n] = rms * Math.sqrt(lag); // Pulse
            }
            
            // Mix
            for(let n=0; n<res.length; n++) {
                modRes[n] = (ratio * res[n]) + ((1-ratio) * buzz[n]);
            }
            
            // Synthesis
            let synth = filterIIR(modRes, [1, ...lpc], synthesisMem);
            out.set(synth, i);
        }
        
        // De-emphasis
        for(let i=0; i<out.length-1; i++) out[i+1] += 0.95 * out[i];
        
        // Normalize
        let maxVal = 0; for(let v of out) if(Math.abs(v)>maxVal) maxVal = Math.abs(v);
        if(maxVal>0) for(let i=0; i<out.length; i++) out[i] = (out[i]/maxVal)*0.8;
        
        return out;
    }

    function playAudioResult() {
        if(!audioCtx) return;
        const val = document.getElementById('compSlider').value / 100;
        document.getElementById('status').innerText = "–û–±—Ä–æ–±–∫–∞...";
        
        setTimeout(() => {
            const data = processAudio(val);
            const buf = audioCtx.createBuffer(1, data.length, audioCtx.sampleRate);
            buf.getChannelData(0).set(data);
            const src = audioCtx.createBufferSource();
            src.buffer = buf;
            src.connect(audioCtx.destination);
            src.start();
            document.getElementById('status').innerText = "–í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è...";
        }, 50);
    }

    function updateSlider(v) {
        let txt = v + "%";
        if(v==100) txt += " (–û—Ä–∏–≥—ñ–Ω–∞–ª)";
        else if(v==0) txt += " (–†–æ–±–æ—Ç/Buzz)";
        document.getElementById('compLabel').innerText = txt;
    }

    // --- –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê ---

    function applyHamming(d) {
        return d.map((v,i) => v * (0.54 - 0.46 * Math.cos(2*Math.PI*i/(d.length-1))));
    }
    
    function autocorrelate(x, maxLag) {
        let res = [];
        for(let k=0; k<=maxLag; k++) {
            let s = 0;
            for(let n=0; n<x.length-k; n++) s += x[n]*x[n+k];
            res.push(s);
        }
        return res;
    }
    
    function levinsonDurbin(r, p) {
        let a = []; let e = r[0];
        for(let i=1; i<=p; i++) {
            let acc = 0; for(let j=1; j<i; j++) acc += a[j-1]*r[i-j];
            let k = -(r[i] + acc)/e;
            let new_a = new Array(i);
            new_a[i-1] = k;
            for(let j=1; j<i; j++) new_a[j-1] = a[j-1] + k*a[i-1-j];
            a = new_a;
            e *= (1 - k*k);
        }
        return {a};
    }
    
    function filterFIR(x, a) {
        let y = new Float32Array(x.length);
        for(let n=0; n<x.length; n++) {
            let s = x[n];
            for(let k=1; k<a.length; k++) if(n>=k) s += a[k]*x[n-k];
            y[n] = s;
        }
        return y;
    }
    
    function filterIIR(x, a, mem) {
        let y = new Float32Array(x.length);
        let ord = a.length-1;
        for(let n=0; n<x.length; n++) {
            let s = x[n];
            for(let k=1; k<=ord; k++) {
                let val = (n>=k) ? y[n-k] : mem[ord-k];
                s -= a[k]*val;
            }
            // Clamp for stability
            if(s>4) s=4; if(s<-4) s=-4;
            y[n] = s;
        }
        for(let i=0; i<ord; i++) mem[i] = y[y.length-1-i];
        return y;
    }

    // --- –ì–†–ê–§–Ü–ö–ò ---
    
    function drawWaveform(d, lbl) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart1) chart1.destroy();
        chart1 = new Chart(ctx, {
            type: 'line',
            data: { labels: [...Array(d.length).keys()], datasets: [{label: lbl, data: [...d], borderColor:'#2563eb', borderWidth:1, pointRadius:0}] },
            options: { responsive:true, maintainAspectRatio:false, animation:false }
        });
    }
    
    function drawAutocorr(d) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart1) chart1.destroy();
        const max = Math.max(...d);
        chart1 = new Chart(ctx, {
            type: 'line',
            data: { labels: [...Array(d.length).keys()], datasets: [{label: "Autocorrelation", data: d.map(v=>v/max), borderColor:'#0f172a', borderWidth:2, pointRadius:0}] },
            options: { responsive:true, maintainAspectRatio:false }
        });
    }

    function drawLPCSpectrum(sig, lpc) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart1) chart1.destroy();
        
        // FFT (Naive)
        let fft = []; let N = sig.length;
        for(let k=0; k<N/2; k+=2) {
            let re=0, im=0;
            for(let n=0; n<N; n++) { let phi=-2*Math.PI*k*n/N; re+=sig[n]*Math.cos(phi); im+=sig[n]*Math.sin(phi); }
            fft.push(20*Math.log10(Math.sqrt(re*re+im*im)+1e-6));
        }
        
        // LPC Response
        let lresp = [];
        for(let k=0; k<N/2; k+=2) {
            let w = Math.PI*k/(N/2);
            let re=1, im=0;
            for(let m=0; m<lpc.length; m++) { let phi=-(m+1)*w; re+=lpc[m]*Math.cos(phi); im+=lpc[m]*Math.sin(phi); }
            lresp.push(20*Math.log10(1/(Math.sqrt(re*re+im*im)+1e-6)));
        }
        
        let off = Math.max(...fft) - Math.max(...lresp);
        
        chart1 = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: [...Array(fft.length).keys()], 
                datasets: [
                    {label: "FFT (–†–µ–∞–ª—å–Ω–∏–π)", data: fft, borderColor:'#cbd5e1', borderWidth:1},
                    {label: "LPC (–ú–æ–¥–µ–ª—å)", data: lresp.map(v=>v+off), borderColor:'#dc2626', borderWidth:2}
                ] 
            },
            options: { responsive:true, maintainAspectRatio:false }
        });
    }
    
    function drawDualChart(d1, d2, l1, l2) {
        drawWaveform(d1, l1);
        document.getElementById('chart2Container').style.display = 'block';
        const ctx = document.getElementById('secChart').getContext('2d');
        if(chart2) chart2.destroy();
        chart2 = new Chart(ctx, {
            type: 'line',
            data: { labels: [...Array(d2.length).keys()], datasets: [{label: l2, data: [...d2], borderColor:'#16a34a', borderWidth:1, pointRadius:0}] },
            options: { responsive:true, maintainAspectRatio:false, animation:false }
        });
    }
	
	
	// --- –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø –ö–†–û–ö–£ 7 (–î–ò–ù–ê–ú–Ü–ß–ù–ò–ô –°–ò–ù–¢–ï–ó) ---
    
  /*  function updatePulseDemo(pulseCount) {
        pulseCount = parseInt(pulseCount);
        document.getElementById('pulseCountLabel').innerText = pulseCount + (pulseCount === 0 ? " (–¢—ñ–ª—å–∫–∏ Pitch)" : " —ñ–º–ø—É–ª—å—Å—ñ–≤");
        
        const cache = window.step7Cache;
        if(!cache) return;

        const N = cache.targetRes.length;
        
        // 1. –ü–æ—á–∏–Ω–∞—î–º–æ –∑ Pitch –≤–∫–ª–∞–¥—É
        // error - —Ü–µ —Ç–µ, —â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥–∞–º–∏
        let currentRes = new Float32Array(N); // –¢—É—Ç –±—É–¥–µ –Ω–∞–∫–æ–ø–∏—á—É–≤–∞—Ç–∏—Å—å u[n]
        let error = new Float32Array(N);      // –ü–æ—Ç–æ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞
        
        // –î–æ–¥–∞—î–º–æ Pitch (v[n] * g_p)
        for(let i=0; i<N; i++) {
            let pitchVal = cache.v_n[i] * cache.g_p;
            currentRes[i] = pitchVal;
            error[i] = cache.targetRes[i] - pitchVal; 
        }

        // 2. –î–æ–¥–∞—î–º–æ N —ñ–º–ø—É–ª—å—Å—ñ–≤ (Matching Pursuit)
        // –¶–µ —Å–ø—Ä–æ—â–µ–Ω–∞ —ñ–º—ñ—Ç–∞—Ü—ñ—è ACELP (–∂–∞–¥—ñ–±–Ω–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º)
        let c_n = new Float32Array(N).fill(0);
        let tempError = Float32Array.from(error); // –ö–æ–ø—ñ—è –¥–ª—è –ø–æ—à—É–∫—É

        for(let k=0; k<pulseCount; k++) {
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞–∫—Å–∏–º—É–º –∞–±—Å–æ–ª—é—Ç–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏
            let maxVal = -1; 
            let maxIdx = -1;
            
            for(let i=0; i<N; i++) {
                if(Math.abs(tempError[i]) > maxVal) {
                    maxVal = Math.abs(tempError[i]);
                    maxIdx = i;
                }
            }

            if(maxIdx !== -1) {
                // –°—Ç–∞–≤–∏–º–æ —ñ–º–ø—É–ª—å—Å
                let sign = tempError[maxIdx] > 0 ? 1.0 : -1.0;
                // –£ —Å–ø—Ä–∞–≤–∂–Ω—å–æ–º—É ACELP gain (g_c) —Å–ø—ñ–ª—å–Ω–∏–π, —Ç—É—Ç –¥–ª—è –¥–µ–º–æ
                // –º–∏ –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º–æ –∞–º–ø–ª—ñ—Ç—É–¥—É –ø–æ–º–∏–ª–∫–∏ —è–∫ –≤–∞–≥—É —ñ–º–ø—É–ª—å—Å—É
                let gain = maxVal; 
                
                c_n[maxIdx] += sign * gain;
                
                // –í–∏–¥–∞–ª—è—î–º–æ —Ü–µ–π –ø—ñ–∫ –∑ –ø–æ–º–∏–ª–∫–∏ (—ñ–º—ñ—Ç–∞—Ü—ñ—è –≤—ñ–¥–Ω—ñ–º–∞–Ω–Ω—è)
                tempError[maxIdx] = 0; 
                // –í —ñ–¥–µ–∞–ª—ñ —Ç—Ä–µ–±–∞ –≤—ñ–¥–Ω—ñ–º–∞—Ç–∏ impulse response, –∞–ª–µ –¥–ª—è –¥–µ–º–æ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑–∞–Ω—É–ª–µ–Ω–Ω—è
            }
        }

        // 3. –°—É–º—É—î–º–æ Pitch + Code
        for(let i=0; i<N; i++) {
            currentRes[i] += c_n[i];
        }

        // 4. –°–ò–ù–¢–ï–ó (–ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —á–µ—Ä–µ–∑ —Ñ—ñ–ª—å—Ç—Ä 1/A(z))
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ filterIIR –∑ –Ω—É–ª—å–æ–≤–æ—é –ø–∞–º'—è—Ç—Ç—é –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É
        const synthesizedParams = filterIIR(currentRes, cache.lpc, new Float32Array(LPC_ORDER).fill(0));

        // 5. –ú–∞–ª—é—î–º–æ
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ drawDualChart, –∞–ª–µ –∑–º—ñ–Ω–∏–º–æ —Ç—Ä–æ—Ö–∏ –∫–æ–ª—å–æ—Ä–∏
        // –û—Ä–∏–≥—ñ–Ω–∞–ª (—Å–∏–Ω—ñ–π) vs –°–∏–Ω—Ç–µ–∑ (—á–µ—Ä–≤–æ–Ω–∏–π)
        
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart1) chart1.destroy();
        
        chart1 = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: [...Array(N).keys()], 
                datasets: [
                    {
                        label: "–û—Ä–∏–≥—ñ–Ω–∞–ª (Recorded)", 
                        data: [...cache.origSignal], 
                        borderColor: '#2563eb', // –°–∏–Ω—ñ–π
                        borderWidth: 2, 
                        pointRadius: 0,
                        order: 1
                    },
                    {
                        label: `–°–∏–Ω—Ç–µ–∑ (${pulseCount} pulses)`, 
                        data: [...synthesizedParams], 
                        borderColor: '#dc2626', // –ß–µ—Ä–≤–æ–Ω–∏–π
                        borderWidth: 1.5, 
                        pointRadius: 0,
                        order: 0
                    }
                ] 
            },
            options: { 
                responsive:true, 
                maintainAspectRatio:false, 
                animation: false, // –í–∏–º–∏–∫–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Å–ª–∞–π–¥–µ—Ä–∞
                interaction: { mode: 'index', intersect: false }
            }
        });

        // –•–æ–≤–∞—î–º–æ –¥—Ä—É–≥–∏–π –≥—Ä–∞—Ñ—ñ–∫, –≤—ñ–Ω —Ç—É—Ç –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
        document.getElementById('chart2Container').style.display = 'none';
    }*/
	///old
	
	function updatePulseDemo(pulseCount) {
        pulseCount = parseInt(pulseCount);
        document.getElementById('pulseCountLabel').innerText = pulseCount + (pulseCount === 0 ? " (–¢—ñ–ª—å–∫–∏ Pitch)" : " —ñ–º–ø—É–ª—å—Å—ñ–≤");
        
        const cache = window.step7Cache;
        if(!cache) return;

        const N = cache.targetRes.length;
        
        // 1. –ü–æ—á–∏–Ω–∞—î–º–æ –∑ Pitch –≤–∫–ª–∞–¥—É
        let currentRes = new Float32Array(N); 
        let error = new Float32Array(N);      
        
        // –î–æ–¥–∞—î–º–æ Pitch (v[n] * g_p)
        for(let i=0; i<N; i++) {
            let pitchVal = cache.v_n[i] * cache.g_p;
            currentRes[i] = pitchVal;
            error[i] = cache.targetRes[i] - pitchVal; 
        }

        // 2. –î–æ–¥–∞—î–º–æ N —ñ–º–ø—É–ª—å—Å—ñ–≤ (Matching Pursuit)
        let c_n = new Float32Array(N).fill(0); // –ú–∞—Å–∏–≤ —á–∏—Å—Ç–æ –¥–ª—è —ñ–º–ø—É–ª—å—Å—ñ–≤ (–¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó)
        let tempError = Float32Array.from(error); 

        for(let k=0; k<pulseCount; k++) {
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞–∫—Å–∏–º—É–º –∞–±—Å–æ–ª—é—Ç–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏
            let maxVal = -1; 
            let maxIdx = -1;
            
            for(let i=0; i<N; i++) {
                if(Math.abs(tempError[i]) > maxVal) {
                    maxVal = Math.abs(tempError[i]);
                    maxIdx = i;
                }
            }

            if(maxIdx !== -1) {
                let sign = tempError[maxIdx] > 0 ? 1.0 : -1.0;
                let gain = maxVal; 
                
                // –î–æ–¥–∞—î–º–æ —ñ–º–ø—É–ª—å—Å –≤ –∑–∞–≥–∞–ª—å–Ω–∏–π —Å–∏–≥–Ω–∞–ª –∑–±—É–¥–∂–µ–Ω–Ω—è
                let pulseVal = sign * gain;
                c_n[maxIdx] += pulseVal;       // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–∫—Ä–µ–º–æ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫—É
                currentRes[maxIdx] += pulseVal; // –î–æ–¥–∞—î–º–æ –¥–æ –∑–±—É–¥–∂–µ–Ω–Ω—è
                
                // –ó–∞–Ω—É–ª—è—î–º–æ –ø–æ–º–∏–ª–∫—É –≤ —Ü—å–æ–º—É –º—ñ—Å—Ü—ñ
                tempError[maxIdx] = 0; 
            }
        }

        // 3. –°–ò–ù–¢–ï–ó
        const synthesizedParams = filterIIR(currentRes, cache.lpc, new Float32Array(LPC_ORDER).fill(0));

        // 4. –ú–∞–ª—é—î–º–æ (–ö–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫)
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart1) chart1.destroy();
        
        chart1 = new Chart(ctx, {
            data: { 
                labels: [...Array(N).keys()], 
                datasets: [
                    {
                        type: 'line',
                        label: "–û—Ä–∏–≥—ñ–Ω–∞–ª", 
                        data: [...cache.origSignal], 
                        borderColor: '#2563eb', // –°–∏–Ω—ñ–π
                        borderWidth: 2, 
                        pointRadius: 0,
                        order: 2,
                        yAxisID: 'y'
                    },
                    {
                        type: 'line',
                        label: "–°–∏–Ω—Ç–µ–∑", 
                        data: [...synthesizedParams], 
                        borderColor: '#000000', // –ß–µ—Ä–≤–æ–Ω–∏–π
                        borderWidth: 2, 
                        pointRadius: 0,
                        order: 1,
                        yAxisID: 'y'
                    },
                    {
                        type: 'bar',
                        label: "–Ü–º–ø—É–ª—å—Å–∏ (Code)", 
                        data: [...c_n], 
                        backgroundColor: '#ff0011', // 
                        barThickness: 4, // –¢–æ–≤—â–∏–Ω–∞ "–≥–æ–ª–æ–∫"
                        order: 3,
                        yAxisID: 'y1' // –ü—Ä–∏–≤'—è–∑—É—î–º–æ –¥–æ –ø—Ä–∞–≤–æ—ó –æ—Å—ñ
                    }
                ] 
            },
            options: { 
                responsive:true, 
                maintainAspectRatio:false, 
                animation: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: '–ê–º–ø–ª—ñ—Ç—É–¥–∞ –≥–æ–ª–æ—Å—É' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false }, // –©–æ–± —Å—ñ—Ç–∫–∞ –Ω–µ –Ω–∞–∫–ª–∞–¥–∞–ª–∞—Å—å
                        title: { display: true, text: '–ê–º–ø–ª—ñ—Ç—É–¥–∞ —ñ–º–ø—É–ª—å—Å—ñ–≤' },
                        suggestedMin: -0.015, // –¢—Ä–æ—Ö–∏ –ø–æ–≤—ñ—Ç—Ä—è –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫—É —ñ–º–ø—É–ª—å—Å—ñ–≤
                        suggestedMax: 0.015
                    }
                }
            }
        });

        document.getElementById('chart2Container').style.display = 'none';
    }

</script>
</body>
</html>