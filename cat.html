<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDPM</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --border: #333;
            --text: #eee;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --purple: #8b5cf6;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        h1, h2, h3 { margin-top: 0; font-weight: 600; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* PANELS */
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 100%;
            box-sizing: border-box;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        /* CONTROLS */
        .row { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin: 10px 0; }
        .btn-grp { display: flex; gap: 10px; flex-wrap: wrap; width: 100%; }
        
        button {
            flex: 1;
            padding: 12px 20px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 120px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .b-blue { background: var(--accent); }
        .b-green { background: var(--success); }
        .b-purp { background: var(--purple); }
        .b-gray { background: #4b5563; }
        .b-red { background: var(--danger); }

        input[type=range] { flex: 1; accent-color: var(--purple); cursor: pointer; }
        select { background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; font-size: 14px; }
        label { cursor: pointer; display: flex; align-items: center; gap: 5px; user-select: none; }

        /* CANVASES */
        canvas.draw, canvas.gen {
            background: #000;
            border: 1px solid #555;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
            image-rendering: pixelated;
            max-width: 100%;
            height: auto;
        }
        
        /* PREVIEWS STRIP */
        #previews {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding: 8px;
            background: #0a0a0a;
            border: 1px solid #333;
            height: 60px;
            margin-top: 15px;
            border-radius: 6px;
        }
        .prev-item { position: relative; flex-shrink: 0; width: 50px; height: 50px; }
        .prev-item img { width: 100%; height: 100%; border: 1px solid #444; image-rendering: pixelated; }
        .prev-del {
            position: absolute; top: -5px; right: -5px;
            background: var(--danger); color: white;
            border-radius: 50%; width: 18px; height: 18px;
            font-size: 12px; line-height: 18px; text-align: center;
            cursor: pointer; display: none; border: 1px solid #fff;
            z-index: 2;
        }
        .prev-item:hover .prev-del { display: block; }

        /* GRAPH */
        canvas.graph { width: 100%; height: 60px; background: #222; border-bottom: 1px solid #444; border-radius: 4px; }

        /* SPOILERS (DETAILS/SUMMARY) */
        details {
            background: #181818;
            border: 1px solid #333;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }
        summary {
            background: #252525;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: "‚ñº"; font-size: 0.8em; transition: transform 0.3s; }
        details[open] summary::after { transform: rotate(180deg); }
        
        .theory-content { padding: 20px; font-size: 0.95em; border-top: 1px solid #333; }
        .theory-block { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .theory-block:last-child { border-bottom: none; }
        
        /* DIAGRAMS */
        .diagram-flow {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin: 20px 0; flex-wrap: wrap;
        }
        .d-node {
            background: #333; padding: 10px 15px; border-radius: 8px; border: 2px solid #555;
            text-align: center; font-family: monospace;
        }
        .d-arrow { font-size: 20px; color: #777; }
        .highlight { color: var(--accent); font-weight: bold; }
        .math-var { font-family: 'Times New Roman', serif; font-style: italic; color: #a78bfa; }

        @media (max-width: 600px) {
            .btn-grp { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">

<details>
        <summary>üéì –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞</summary>
        <div class="theory-content">
            
              
            <div class="theory-block">
                <h3>–î–∏—Ñ—É–∑—ñ–π–Ω—ñ –º–æ–¥–µ–ª—ñ: –†—É–π–Ω—É–≤–∞–Ω–Ω—è —Ç–∞ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è</h3>
                <p>–£—è–≤—ñ—Ç—å, —â–æ –≤–∏ –∫–∞–ø–∞—î—Ç–µ —á–æ—Ä–Ω–∏–ª–æ —É —Å–∫–ª—è–Ω–∫—É –∑ –≤–æ–¥–æ—é. –ó —á–∞—Å–æ–º —á–æ—Ä–Ω–∏–ª–æ —Ä–æ–∑—Å—ñ—é—î—Ç—å—Å—è, —ñ –≤–æ–¥–∞ —Å—Ç–∞—î –º—É—Ç–Ω–æ—é. –¶–µ ‚Äî <strong>–ø—Ä—è–º–∏–π –ø—Ä–æ—Ü–µ—Å (–¥–∏—Ñ—É–∑—ñ—è)</strong>, —è–∫–∏–π —Ä—É–π–Ω—É—î —Å—Ç—Ä—É–∫—Ç—É—Ä—É.</p>
                <p>–ù–∞—à–∞ –º–µ—Ç–∞ ‚Äî –Ω–∞–≤—á–∏—Ç–∏ –Ω–µ–π—Ä–æ–º–µ—Ä–µ–∂—É "–ø–µ—Ä–µ–º–æ—Ç—É–≤–∞—Ç–∏ —á–∞—Å –Ω–∞–∑–∞–¥". –Ø–∫—â–æ –º–∏ –∑–º–æ–∂–µ–º–æ –∫—Ä–æ–∫ –∑–∞ –∫—Ä–æ–∫–æ–º –∑—ñ–±—Ä–∞—Ç–∏ —á–æ—Ä–Ω–∏–ª–æ –Ω–∞–∑–∞–¥ —É –∫—Ä–∞–ø–ª—é, –º–∏ –∑–º–æ–∂–µ–º–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—é –∫—Ä–∞–ø–ª—é (–∞–±–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ—Ç–∞) –∑ –∞–±—Å–æ–ª—é—Ç–Ω–æ –∫–∞–ª–∞–º—É—Ç–Ω–æ—ó –≤–æ–¥–∏ (–±—ñ–ª–æ–≥–æ —à—É–º—É).</p>
            </div>
			 <div class="theory-block">
                <h3>–ß–æ–º—É –Ω–µ –ø—Ä–æ—Å—Ç–æ "—Å–µ—Ä–µ–¥–Ω—î –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–Ω–µ"?</h3>
                <p>–¶–µ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–µ –ø–∏—Ç–∞–Ω–Ω—è. –Ø–∫—â–æ –º–∏ –≤—ñ–∑—å–º–µ–º–æ 1000 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π —Ä—ñ–∑–Ω–∏—Ö –∫–æ—Ç—ñ–≤ —ñ –∑–Ω–∞–π–¥–µ–º–æ —Å–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ –ø—ñ–∫—Å–µ–ª—è, –º–∏ –æ—Ç—Ä–∏–º–∞—î–º–æ <strong>—Å—ñ—Ä—É –ø–ª—è–º—É</strong> (—Å–µ—Ä–µ–¥–Ω—î –º—ñ–∂ —á–æ—Ä–Ω–∏–º —ñ –±—ñ–ª–∏–º –∫–æ—Ç–æ–º ‚Äî —Å—ñ—Ä–µ –º—ñ—Å–∏–≤–æ, –∞ –Ω–µ —Å—ñ—Ä–∏–π –∫—ñ—Ç). </p>
                <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –°–µ—Ä–µ–¥–Ω—î –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–Ω–µ –º—ñ–Ω—ñ–º—ñ–∑—É—î –ø–æ–º–∏–ª–∫—É, –∞–ª–µ –≤–±–∏–≤–∞—î –¥–µ—Ç–∞–ª—ñ. –í–æ–Ω–æ —à—É–∫–∞—î "—Ü–µ–Ω—Ç—Ä" —Ä–æ–∑–ø–æ–¥—ñ–ª—É –¥–∞–Ω–∏—Ö.<br>
                <strong>–†—ñ—à–µ–Ω–Ω—è –î–∏—Ñ—É–∑—ñ—ó:</strong> –ú–∏ –Ω–µ —à—É–∫–∞—î–º–æ "—Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∫–æ—Ç–∞". –ú–∏ –≤—á–∏–º–æ—Å—è –º–∞–ª—é–≤–∞—Ç–∏ <em>—à–ª—è—Ö</em> –≤—ñ–¥ —Ö–∞–æ—Å—É –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ, —á—ñ—Ç–∫–æ–≥–æ –∫–æ—Ç–∞. –ú–∏ –≤—á–∏–º–æ —Ä–æ–∑–ø–æ–¥—ñ–ª –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç–µ–π, –∞ –Ω–µ –æ–¥–Ω—É —Ç–æ—á–∫—É.</p>
            </div>

            <div class="theory-block">
                <h3> –ú–∞—Ä–∫–æ–≤—Å—å–∫–∏–π –ª–∞–Ω—Ü—é–≥ (Markov Chain)</h3>
                <p>–ú–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π –ø—Ä–æ—Ü–µ—Å - —Ü–µ –ø—Ä–æ—Ü–µ—Å <strong>–±–µ–∑ –ø–∞–º'—è—Ç—ñ.</strong>. </p>
				 <p>–©–æ–± –¥–æ–¥–∞—Ç–∏ —à—É–º –¥–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ \(x_t\), –Ω–∞–º –Ω–µ —Ç—Ä–µ–±–∞ –∑–Ω–∞—Ç–∏, —è–∫–æ—é –≤–æ–Ω–∞ –±—É–ª–∞ –Ω–∞ –ø–æ—á–∞—Ç–∫—É (\(x_0\)). –ù–∞–º –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑–Ω–∞—Ç–∏ –ª–∏—à–µ —ó—ó —Å—Ç–∞–Ω –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –∫—Ä–æ—Ü—ñ \(x_{t-1}\). –ú–∞–π–±—É—Ç–Ω—î –∑–∞–ª–µ–∂–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –≤—ñ–¥ —Ç–µ–ø–µ—Ä—ñ—à–Ω—å–æ–≥–æ.</p>
            
                <div class="diagram-flow">
                    <div class="d-node" style="border-color: #10b981;">X‚ÇÄ<br>(–ö—ñ—Ç)</div>
                    <div class="d-arrow">‚Üí q(x‚ÇÅ|x‚ÇÄ) ‚Üí</div>
                    <div class="d-node">X‚ÇÅ<br>(–¢—Ä–æ—Ö–∏ —à—É–º—É)</div>
                    <div class="d-arrow">‚Üí q(x‚ÇÇ|x‚ÇÅ) ‚Üí</div>
                    <div class="d-node">X‚ÇÇ</div>
                    <div class="d-arrow">...</div>
                    <div class="d-node" style="border-color: #ef4444;">X_T<br>(–®—É–º)</div>
                </div>
               </div>

            <div class="theory-block">
                <h3>–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –º–æ–¥–µ–ª—å —à—É–º—É: \(\beta_t\), \(q\) —Ç–∞ \(\epsilon\)</h3>
                <p>–ü—Ä—è–º–∏–π –ø—Ä–æ—Ü–µ—Å —Ä—É–π–Ω—É–≤–∞–Ω–Ω—è –æ–ø–∏—Å—É—î—Ç—å—Å—è —Ñ–æ—Ä–º—É–ª–æ—é:</p>
                $$ x_t = \sqrt{1 - \beta_t} x_{t-1} + \sqrt{\beta_t} \cdot \epsilon $$
                <p><strong>–†–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞ –±—É–∫–≤:</strong></p>
                <ul style="list-style: none; padding-left: 10px;">
                    <li> <strong>\(\beta_t\) (Noise Schedule / –†–æ–∑–∫–ª–∞–¥ —à—É–º—É)</strong>: –¶–µ –Ω–≥—Ä–∞—Ñ—ñ–∫ (—Ä–æ–∑–∫–ª–∞–¥) –∑–∞ —á–∞—Å–æ–º. –¶–µ —á–∏—Å–ª–æ –≤—ñ–¥ 0 –¥–æ 1, —è–∫–µ –∫–∞–∂–µ: "—è–∫—É —á–∞—Å—Ç–∫—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó —Å—Ç–µ—Ä—Ç–∏ –Ω–∞ –∫—Ä–æ—Ü—ñ \(t\)". –°–ø–æ—á–∞—Ç–∫—É \(\beta\) –º–∞–ª–µ–Ω—å–∫–µ (—Å—Ç–∏—Ä–∞—î–º–æ –º–∞–ª–æ), –≤ –∫—ñ–Ω—Ü—ñ ‚Äî –≤–µ–ª–∏–∫–µ.</li>
                    <li> <strong>\(\epsilon\) (–ï–ø—Å–∏–ª–æ–Ω)</strong>: –¶–µ —Å–∞–º —à—É–º. –í–∏–ø–∞–¥–∫–æ–≤–∏–π –≤–µ–∫—Ç–æ—Ä –∑ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–æ–∑–ø–æ–¥—ñ–ª—É \(\mathcal{N}(0, I)\). –¶–µ "—Å–º—ñ—Ç—Ç—è", —è–∫–µ –º–∏ –¥–æ–¥–∞—î–º–æ.</li>
                    <li> <strong>\(q(x_t|x_{t-1})\)</strong>: –¶–µ –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è —É–º–æ–≤–Ω–æ–≥–æ —Ä–æ–∑–ø–æ–¥—ñ–ª—É –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç–µ–π –ø—Ä—è–º–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É (—Ä—É–π–Ω—É–≤–∞–Ω–Ω—è). –ú–∏ –∑–Ω–∞—î–º–æ \(q\), –±–æ —Å–∞–º—ñ –π–æ–≥–æ –∑–∞–¥–∞—î–º–æ.</li>
                </ul>
            </div>

            <div class="theory-block">
                <h3>–ó–≤–æ—Ä–æ—Ç–Ω–∏–π –ø—Ä–æ—Ü–µ—Å</h3>
                <p>–ù–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –∑–Ω–∞–π—Ç–∏ –∑–≤–æ—Ä–æ—Ç–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é \(p_\theta(x_{t-1}|x_t)\). –û—Å–∫—ñ–ª—å–∫–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ —Ç–æ—á–Ω–æ –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ —ó—ó –Ω–µ–º–æ–∂–ª–∏–≤–æ (—ñ–Ω—Ç–µ–≥—Ä–∞–ª –ø–æ –≤—Å—ñ—Ö –º–æ–∂–ª–∏–≤–∏—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∞—Ö —Å–≤—ñ—Ç—É), –º–∏ –Ω–∞–±–ª–∏–∂–∞—î–º–æ —ó—ó –Ω–µ–π—Ä–æ–º–µ—Ä–µ–∂–µ—é.</p>
                
                <p><strong>–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞: U-Net vs MLP</strong></p>
                <ul>
                    <li><strong>U-Net (–°—Ç–∞–Ω–¥–∞—Ä—Ç —ñ–Ω–¥—É—Å—Ç—Ä—ñ—ó):</strong> –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∑–≥–æ—Ä—Ç–∫–∏ (Conv2D). –†–æ–∑—É–º—ñ—î, —â–æ –ø—ñ–∫—Å–µ–ª—å [0,0] —ñ [0,1] ‚Äî —Å—É—Å—ñ–¥–∏. –ó–±–µ—Ä—ñ–≥–∞—î –ø—Ä–æ—Å—Ç–æ—Ä–æ–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –î–æ–≤–≥–æ —Ä–∞—Ö—É—î—Ç—å—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ.</li>
                    <li><strong>MLP (Multi-Layer Perceptron - —É –Ω–∞—Å):</strong> –ú–∏ –ø—Ä–æ—Å—Ç–æ –≤–∏—Ç—è–≥—É—î–º–æ –∫–∞—Ä—Ç–∏–Ω–∫—É 16x16 —É –¥–æ–≤–≥–∏–π —Ä—è–¥–æ–∫ (–≤–µ–∫—Ç–æ—Ä 256 —á–∏—Å–µ–ª).
                        <br><em>–ú—ñ–Ω—É—Å:</em> –ú–µ—Ä–µ–∂–∞ –≤—Ç—Ä–∞—á–∞—î —Ä–æ–∑—É–º—ñ–Ω–Ω—è "—Å—É—Å—ñ–¥—Å—Ç–≤–∞" –ø—ñ–∫—Å–µ–ª—ñ–≤. –á–π –≤–∞–∂—á–µ –Ω–∞–º–∞–ª—é–≤–∞—Ç–∏ —Ä—ñ–≤–Ω—ñ –ª—ñ–Ω—ñ—ó.
                        <br><em>–ü–ª—é—Å:</em> –î—É–∂–µ –ø—Ä–æ—Å—Ç–∞ –º–∞—Ç—Ä–∏—á–Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –ø—Ä–∞—Ü—é—î –º–∏—Ç—Ç—î–≤–æ –Ω–∞–≤—ñ—Ç—å –Ω–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ. –î–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ ‚Äî —ñ–¥–µ–∞–ª—å–Ω–æ.</li>
                </ul>
            </div>
			 <div class="theory-block">
                  <p>–ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–æ—Å—Ç—É 3-—à–∞—Ä–æ–≤—É –ø–æ–≤–Ω–æ–∑–≤'—è–∑–Ω—É –º–µ—Ä–µ–∂—É (MLP) </p>
                <div class="diagram-flow" style="font-size: 0.9em;">
                    <div class="d-node">
                        <strong>INPUT</strong><br>
                        –ü—ñ–∫—Å–µ–ª—ñ \(x_t\) [256]<br>
                        + –ß–∞—Å \(t\) [1]<br>
                        + –£–º–æ–≤–∞ (–ö—ñ—Ç/–ë–∞–Ω—Ç) [2]
                    </div>
                    <div class="d-arrow">‚ûú</div>
                    <div class="d-node">
                        <strong>HIDDEN 1</strong><br>
                        Linear + LeakyReLU
                    </div>
                    <div class="d-arrow">‚ûú</div>
                    <div class="d-node">
                        <strong>HIDDEN 2</strong><br>
                        Linear + LeakyReLU
                    </div>
                    <div class="d-arrow">‚ûú</div>
                    <div class="d-node">
                        <strong>OUTPUT</strong><br>
                        –ü–µ—Ä–µ–¥–±–∞—á–µ–Ω–∏–π —à—É–º \(\epsilon_\theta\) [256]
                    </div>
                </div>
            </div>

        </div>
    </details>

    <div class="panel">
        <div class="panel-header">
            <h2>1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –î–∞—Ç–∞—Å–µ—Ç—É</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <label>–†–æ–∑–º—ñ—Ä:</label>
                <select id="selRes" onchange="initModel()">
                    <option value="16">16 x 16 (–®–≤–∏–¥–∫–æ)</option>
                    <option value="32">32 x 32 (–Ø–∫—ñ—Å–Ω–æ-–ø–æ–≤—ñ–ª—å–Ω–æ)</option>
                </select>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
            <div>
                <canvas id="cDraw" width="160" height="160" class="draw"></canvas>
                <div style="text-align:center; font-size: 0.9em; color:#888; margin-top:5px;">–ú–∞–ª—é–π—Ç–µ —Ç—É—Ç –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü—ñ—é</div>
            </div>

            <div>
                <div class="row" style="justify-content:center; background: #222; padding: 10px; border-radius: 8px;">
                    <span style="color:#aaa;">–ú—ñ—Ç–∫–∞ –∫–ª–∞—Å—É:</span>
                    <label><input type="checkbox" id="chkCat" checked> üê± –ö—ñ—Ç</label>
                    <label><input type="checkbox" id="chkTie" checked> üéÄ –ë–∞–Ω—Ç</label>
                </div>

                <div class="btn-grp">
                    <button class="b-red" onclick="clearC()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
                    <button class="b-blue" onclick="manualAdd()">‚ûï –î–æ–¥–∞—Ç–∏ –≤—Ä—É—á–Ω—É</button>
                    <button class="b-purp" onclick="autoGen()">‚ú® –ê–≤—Ç–æ-–º–∞–ª—é–≤–∞–Ω–Ω—è</button>
                </div>

                <div class="btn-grp" style="margin-top: 10px;">
                    <button class="b-gray" onclick="saveData('data')">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞—Ç–∞—Å–µ—Ç</button>
                    <button class="b-gray" onclick="document.getElementById('fDat').click()">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞—Ç–∞—Å–µ—Ç</button>
                    <button class="b-gray" onclick="saveData('model')">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –º–æ–¥–µ–ª—å</button>
                    <button class="b-gray" onclick="document.getElementById('fMod').click()">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–æ–¥–µ–ª—å</button>
                </div>
                <input type="file" id="fMod" style="display:none" onchange="loadData('model', this)">
                <input type="file" id="fDat" style="display:none" onchange="loadData('data', this)">
            </div>
        </div>

        <div id="previews"></div>
        <div style="font-size:12px; color:#666; text-align:right;">–í—Å—å–æ–≥–æ —Å–µ–º–ø–ª—ñ–≤: <b id="cnt" style="color:#fff">0</b>. –ö–ª—ñ–∫–Ω—ñ—Ç—å [x] —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏.</div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>2. –ù–∞–≤—á–∞–Ω–Ω—è (Training)</h2>
            <div style="text-align:right;">
                –ï–ø–æ—Ö–∞: <span id="ep" class="highlight">0</span> | 
                Loss: <span id="loss" style="color:red; font-weight:bold;">---</span>
                <span id="lrStat" style="font-size:12px; color:#888;"></span>
            </div>
        </div>
  <p>üü¢ <span style="color:#10b981">–ó–µ–ª–µ–Ω–∞ –∑–æ–Ω–∞ (loss< 0.25)</span>: –ú–µ—Ä–µ–∂–∞ –ø–æ—á–∞–ª–∞ —Ä–æ–∑—É–º—ñ—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.</p>
        <canvas id="cGraph" width="600" height="60" class="graph"></canvas>
        
		
		<details style="margin-top:10px;">
            <summary>‚öôÔ∏è–Ø–∫ –≤—á–∏—Ç—å—Å—è –º–µ—Ä–µ–∂–∞</summary>
            <div class="theory-content">
                
                <div class="theory-block">
                    
                    <p>–ù–∞—à–∞ –Ω–µ–π—Ä–æ–º–µ—Ä–µ–∂–∞ ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ —Å–∫–ª–∞–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è \( f(x) \), —è–∫–∞ –º–∞—î –º—ñ–ª—å–π–æ–Ω–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å (–≤–∞–≥ \( W \) —Ç–∞ –∑–º—ñ—â–µ–Ω—å \( b \)).</p>
                    <p><strong>–ú–µ—Ç–∞:</strong> –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Ü—ñ –≤–∞–≥–∏ —Ç–∞–∫, —â–æ–± –º–µ—Ä–µ–∂–∞, –ø–æ–±–∞—á–∏–≤—à–∏ –∑–∞—à—É–º–ª–µ–Ω—É –∫–∞—Ä—Ç–∏–Ω–∫—É, –º–æ–≥–ª–∞ —Å–∫–∞–∑–∞—Ç–∏: <em>"–Ø –±–∞—á—É —Ç—É—Ç –æ—Å—å —Ç–∞–∫–∏–π —à—É–º, —è–∫—â–æ –π–æ–≥–æ –ø—Ä–∏–±—Ä–∞—Ç–∏ ‚Äî –≤–∏–π–¥–µ —â–æ—Å—å —Å—Ö–æ–∂–µ –Ω–∞ –∫–æ—Ç–∞"</em>.</p>
                </div>

                <div class="theory-block">
                    <h3>–©–æ –º–∏ –ø–æ–¥–∞—î–º–æ –Ω–∞ –≤—Ö—ñ–¥ –º–µ—Ä–µ–∂—ñ. </h3>
                    <p>–ú–∏ –Ω–µ —Ä–æ–±–∏–º–æ —à—É–º –ø–æ–∫—Ä–æ–∫–æ–≤–æ (\(x_0 \to x_1 \to \dots \to x_t\)) –ø—ñ–¥ —á–∞—Å –Ω–∞–≤—á–∞–Ω–Ω—è, —Ü–µ –¥–æ–≤–≥–æ. –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ "—Ç–µ–ª–µ–ø–æ—Ä—Ç" ‚Äî —Ñ–æ—Ä–º—É–ª—É, —â–æ –¥–æ–∑–≤–æ–ª—è—î —Å—Ç—Ä–∏–±–Ω—É—Ç–∏ –∑ —á–∏—Å—Ç–æ–≥–æ —Ñ–æ—Ç–æ –∑—Ä–∞–∑—É –≤ –∫—Ä–æ–∫ \(t\).</p>
                    
                    <p>–ê—Ä–≥—É–º–µ–Ω—Ç —É –¥—É–∂–∫–∞—Ö —Ñ–æ—Ä–º—É–ª–∏ Loss ‚Äî —Ü–µ —ñ —î –∑–∞—à—É–º–ª–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ \(x_t\):</p>
                    $$ x_t = \underbrace{\sqrt{\bar{\alpha}_t} x_0}_{\text{–°–∏–≥–Ω–∞–ª}} + \underbrace{\sqrt{1 - \bar{\alpha}_t} \epsilon}_{\text{–®—É–º}} $$

                    <p><strong>–ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è:</strong></p>
                    <ul>
                        <li>\(\alpha_t = 1 - \beta_t\) ‚Äî —Ü–µ "—á–∞—Å—Ç–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É" –∑–∞ –æ–¥–∏–Ω –∫—Ä–æ–∫.</li>
                        <li>\(\bar{\alpha}_t\) (–ê–ª—å—Ñ–∞ –∑ —Ä–∏—Å–∫–æ—é / Alpha Bar) ‚Äî —Ü–µ –∫—É–º—É–ª—è—Ç–∏–≤–Ω–∏–π –¥–æ–±—É—Ç–æ–∫: \(\alpha_1 \cdot \alpha_2 \cdot \dots \cdot \alpha_t\). –í–æ–Ω–∞ –ø–æ–∫–∞–∑—É—î, —Å–∫—ñ–ª—å–∫–∏ <strong>–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É</strong> –∑–∞–ª–∏—à–∏–ª–æ—Å—å –¥–æ –∫—Ä–æ–∫—É \(t\).</li>
                        <li>–Ø–∫—â–æ \(t\) –≤–µ–ª–∏–∫–µ (–∫—ñ–Ω–µ—Ü—å –ø—Ä–æ—Ü–µ—Å—É), \(\bar{\alpha}_t \approx 0\), —Ç–æ–±—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –º–∞–π–∂–µ –ø–æ–≤–Ω—ñ—Å—Ç—é —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —à—É–º—É.</li>
                    </ul>
                </div>

                <div class="theory-block">
                    <h3>3. –§—É–Ω–∫—Ü—ñ—è –í—Ç—Ä–∞—Ç (Loss Function)</h3>
                    <p>–¶–µ –æ—Ü—ñ–Ω–∫—É —è–∫–æ—Å—Ç—ñ –ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–Ω—è. –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ MSE (Mean Squared Error) –º—ñ–∂ <strong>—Å–ø—Ä–∞–≤–∂–Ω—ñ–º —à—É–º–æ–º</strong> —ñ <strong>–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–Ω—è–º –º–µ—Ä–µ–∂—ñ</strong>.</p>
                    
                    $$ L = || \hspace{2mm} \underbrace{\epsilon}_{\text{–§–∞–∫—Ç}} \hspace{2mm} - \hspace{2mm} \underbrace{\epsilon_\theta(\overbrace{x_t}^{\text{–í—Ö—ñ–¥}}, t, c)}_{\text{–ü—Ä–æ–≥–Ω–æ–∑}} \hspace{2mm} ||^2 $$

                    <p><strong>–©–æ —Ç—É—Ç –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è:</strong></p>
                    <ul style="list-style: none; padding-left: 10px;">
                        <li> <strong>\(\epsilon\) (–§–∞–∫—Ç):</strong> –®—É–º, —è–∫–∏–π –º–∏ —Å–∞–º—ñ –∑–≥–µ–Ω–µ—Ä—É–≤–∞–ª–∏ (`randn()`) —ñ –¥–æ–¥–∞–ª–∏ –¥–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ú–∏ –∑–Ω–∞—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å!</li>
                        <li> <strong>\(\epsilon_\theta(...)\) (–ü—Ä–æ–≥–Ω–æ–∑):</strong> –¶–µ –≤–∏—Ö—ñ–¥ –Ω–µ–π—Ä–æ–º–µ—Ä–µ–∂—ñ. –í–æ–Ω–∞ –ø—Ä–∏–π–º–∞—î:
                            <ul>
                                <li>\(x_t\) ‚Äî –∑–∞—à—É–º–ª–µ–Ω—É –∫–∞—Ä—Ç–∏–Ω–∫—É (—Å—É–º—ñ—à –∫–æ—Ç–∞ —ñ —à—É–º—É \(\epsilon\)).</li>
                                <li>\(t\) ‚Äî "—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–∞—Å—É" (—Ä—ñ–≤–µ–Ω—å —à—É–º—É). –ë–µ–∑ –Ω—å–æ–≥–æ –º–µ—Ä–µ–∂–∞ –Ω–µ –∑—Ä–æ–∑—É–º—ñ—î, —á–∏ —Ü–µ –ª–µ–≥–∫–∏–π —Ç—É–º–∞–Ω, —á–∏ –ø–æ–≤–Ω–∏–π —Ö–∞–æ—Å.</li>
                                <li>\(c\) ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–µ–∫—Ç–æ—Ä `[1, 0]` –¥–ª—è –∫–æ—Ç–∞). –¶–µ –ø—ñ–¥–∫–∞–∑–∫–∞: "—à—É–∫–∞–π —Ç—É—Ç –∫–æ—Ç–∞".</li>
                            </ul>
                        </li>
                    </ul>
                    <p>–ú–µ—Ä–µ–∂–∞ –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–≥–∞–¥–∞—Ç–∏ \(\epsilon\), –¥–∏–≤–ª—è—á–∏—Å—å –Ω–∞ \(x_t\).</p>
                </div>

                <div class="theory-block">
                    <h3>–Ø–∫ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –≤–∞–≥–∏ </h3>
                    <p>  –ü–∞—Ä–∞–º–µ—Ç—Ä "–∫—Ä–æ–∫ –Ω–∞–≤—á–∞–Ω–Ω—è" (Learning Rate) –∑'—è–≤–ª—è—î—Ç—å—Å—è —É —Ñ–æ—Ä–º—É–ª—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∞–≥ (–∑–≤–æ—Ä–æ—Ç–Ω–µ –ø–æ—à–∏—Ä–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏ / Backpropagation).</p>
                    <p>–ú–∏ —Ä–∞—Ö—É—î–º–æ –≥—Ä–∞–¥—ñ—î–Ω—Ç \(\nabla L\) (–Ω–∞–ø—Ä—è–º–æ–∫, —É —è–∫–æ–º—É –ø–æ–º–∏–ª–∫–∞ –∑—Ä–æ—Å—Ç–∞—î) —ñ —Ä–æ–±–∏–º–æ –∫—Ä–æ–∫ —É –ø—Ä–æ—Ç–∏–ª–µ–∂–Ω–∏–π –±—ñ–∫:</p>
                    $$ W_{new} = W_{old} - \eta \cdot \nabla L $$
                    <ul>
                        <li><strong>\(W\)</strong> ‚Äî —Ü–µ –≤—Å—ñ –≤–∞–≥–∏ –º–µ—Ä–µ–∂—ñ (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏).</li>
                        <li><strong>\(\eta\) (Learning Rate)</strong> ‚Äî —Ü–µ –¥–æ–≤–∂–∏–Ω–∞ –∫—Ä–æ–∫—É. 
                            <br>‚Ä¢ –Ø–∫—â–æ \(\eta\) –≤–µ–ª–∏–∫–∏–π ‚Äî –º–∏ —à–≤–∏–¥–∫–æ –≤—á–∏–º–æ—Å—è, –∞–ª–µ –º–æ–∂–µ–º–æ "–ø–µ—Ä–µ—Å—Ç—Ä–∏–±–Ω—É—Ç–∏" —ñ–¥–µ–∞–ª —ñ Loss –ø–æ—á–Ω–µ —Å–∫–∞–∫–∞—Ç–∏.
                            <br>‚Ä¢ –Ø–∫—â–æ \(\eta\) –º–∞–ª–∏–π ‚Äî –º–∏ —Å–ø—É—Å–∫–∞—î–º–æ—Å—å –ø–ª–∞–≤–Ω–æ, —É—Ç–æ—á–Ω—é—é—á–∏ –¥–µ—Ç–∞–ª—ñ. –¢–æ–º—É –º–∏ –∑–º–µ–Ω—à—É—î–º–æ –π–æ–≥–æ, –∫–æ–ª–∏ Loss —Å—Ç–∞—î –º–∞–ª–∏–º.
                        </li>
                    </ul>
                </div>

				<div class="theory-block">
                    <h3> CFG (Classifier-Free Guidance)</h3>
                    
                    <ul>
                        <li>c (Context / –í–µ–∫—Ç–æ—Ä —É–º–æ–≤–∏): –¶–µ <strong>–Ω–∞–ø—Ä—è–º–æ–∫</strong>. –¶–µ –∫–æ–º–∞–Ω–¥–∞ "–ú–∞–ª—é–π –∫–æ—Ç–∞". –ë–µ–∑ –Ω–µ—ó –º–µ—Ä–µ–∂–∞ –Ω–µ –∑–Ω–∞—î, <em>—â–æ</em> —Å–∞–º–µ –º–∞–ª—é–≤–∞—Ç–∏.</li>
                        <li>s (Scale / –°–∏–ª–∞ –≤–ø–ª–∏–≤—É): –¶–µ <strong>–≥—É—á–Ω—ñ—Å—Ç—å</strong> –∫–æ–º–∞–Ω–¥–∏. –¶–µ —á–∏—Å–ª–æ (—É –Ω–∞—Å 2.5).</li>
                    </ul>
                                        <p><strong>–§–æ—Ä–º—É–ª–∞ –ø—ñ–¥—Å–∏–ª–µ–Ω–Ω—è (–Ω–∞ –∫–æ–∂–Ω–æ–º—É –∫—Ä–æ—Ü—ñ):</strong></p>
                    $$ \epsilon_{final} = \epsilon_{uncond} + s \cdot (\underbrace{\epsilon_{cond} - \epsilon_{uncond}}_{\text{–í–µ–∫—Ç–æ—Ä "–ö–æ—Ç–æ–≤–æ—Å—Ç—ñ"}}) $$
                    
                    <p>–ú–∏ –ø—Ä–æ—Å–∏–º–æ –º–µ—Ä–µ–∂—É –ø–µ—Ä–µ–¥–±–∞—á–∏—Ç–∏ —à—É–º –¥–≤—ñ—á—ñ:</p>
                    <ol>
                        <li>\(\epsilon_{cond} = \epsilon(x_t, t, c=\text{"–ö—ñ—Ç"})\) ‚Äî "–Ø–∫ –≤–∏–≥–ª—è–¥–∞—î —à—É–º, —è–∫—â–æ —Ü–µ –∫—ñ—Ç?"</li>
                        <li>\(\epsilon_{uncond} = \epsilon(x_t, t, c=\emptyset)\) ‚Äî "–Ø–∫ –≤–∏–≥–ª—è–¥–∞—î —à—É–º –≤–∑–∞–≥–∞–ª—ñ?"</li>
                    </ol>
                    <p>–†—ñ–∑–Ω–∏—Ü—è \(\epsilon_{cond} - \epsilon_{uncond}\) –≤–∏–¥—ñ–ª—è—î —É–Ω—ñ–∫–∞–ª—å–Ω—ñ —Ä–∏—Å–∏ –∫–æ—Ç–∞. –ú–∏ –º–Ω–æ–∂–∏–º–æ —Ü–µ –Ω–∞ \(s\), —â–æ–± –∑–º—É—Å–∏—Ç–∏ –º–µ—Ä–µ–∂—É –º–∞–ª—é–≤–∞—Ç–∏ –∫–æ—Ç–∞ "—Å–∏–ª—å–Ω—ñ—à–µ", –Ω—ñ–∂ –≤–æ–Ω–∞ –∑–≤–∏–∫–ª–∞.</p>
                </div>
                <div class="theory-block">
                    <h3> –°–ª–æ–≤–Ω–∏—á–æ–∫</h3>
                    <ul>
                        <li><strong>–ï–ø–æ—Ö–∞ (Epoch):</strong> –û–¥–∏–Ω –ø–æ–≤–Ω–∏–π –ø—Ä–æ—Ö—ñ–¥ —á–µ—Ä–µ–∑ —É–≤–µ—Å—å –≤–∞—à –¥–∞—Ç–∞—Å–µ—Ç (–≤—Å—ñ –∫–∞—Ä—Ç–∏–Ω–∫–∏, —â–æ –≤–∏ –Ω–∞–º–∞–ª—é–≤–∞–ª–∏).</li>
                        <li><strong>Batch.</strong> –£ –Ω–∞—Å —Ü–µ –ø–∞—á–∫–∞ –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∑ –¥–∞—Ç–∞—Å–µ—Ç—É.</li>
                    </ul>
                </div>

            </div>
        </details>
        

        <button class="b-green" id="btnTr" onclick="toggleTrain()" style="width:100%; font-size:1.2em; margin-top:10px;">‚ñ∂ –°–¢–ê–†–¢ –ù–ê–í–ß–ê–ù–ù–Ø</button>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>3. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è (Inference)</h2>
            <span id="status" style="color:#fbbf24; font-weight:bold;">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>

        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
          

            <div style="flex: 1; min-width: 250px;">
                <div class="row" style="background:#222; padding:10px; border-radius:8px;">
                    <span style="color:#aaa;">–©–æ –º–∞–ª—é–≤–∞—Ç–∏?</span>
                    <label><input type="checkbox" id="gCat" checked> üê± –ö—ñ—Ç</label>
                    <label><input type="checkbox" id="gTie"> üéÄ –ë–∞–Ω—Ç</label>
                </div>

                <div class="row">
                    <label>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ <span id="tVal" style="color:var(--purple)">0.5</span></label>
                    <input type="range" min="0.1" max="1.0" step="0.1" value="0.5" oninput="updCfg('temp',this.value); document.getElementById('tVal').innerText=this.value">
                </div>
				
                <button class="b-purp" id="btnGen" onclick="generate()" style="width:100%; margin-top:10px;">üé≤ –ó–ì–ï–ù–ï–†–£–í–ê–¢–ò</button>
						
              
                
					<div style="flex: 0 0 160px; margin: 0 auto;">
					<canvas id="cGen" width="160" height="160" class="gen"></canvas>
					</div>
				<p>–ü–æ—Å—Ç–æ–±—Ä–æ–±–∫–∞</p>
                <div class="row">
                    <label>–ö–æ–Ω—Ç—Ä–∞—Å—Ç</label>
                    <input type="range" min="1.0" max="2.0" step="0.1" value="1.2" oninput="updCfg('cont',this.value); renderFinal()">
                </div>
  <div class="row" style="justify-content: flex-end;">
                    <label><input type="checkbox" id="chkDespeckle" onchange="renderFinal()"> Clean (Despeckle)</label>
                    <label><input type="checkbox" id="chkSmooth" checked onchange="updCfg('smooth', this.checked); renderFinal()"> Smooth</label>
                </div>

             
				
				<details>
            <summary> –ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó</summary>
            <div class="theory-content">
                
               

                <div class="theory-block">
                    <h3>Sampling Loop</h3>
                    <p>–¶–µ –∑–≤–æ—Ä–æ—Ç–Ω–∏–π —à–ª—è—Ö –≤—ñ–¥ \(T\) –¥–æ \(0\). –ú–∏ –Ω–µ –º–æ–∂–µ–º–æ –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–Ω—è—Ç–∏ –≤–µ—Å—å —à—É–º –∑–∞ —Ä–∞–∑ ‚Äî –≤–∏–π–¥–µ "–∫–∞—à–∞". –ú–∏ —Ä–æ–±–∏–º–æ —Ü–µ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –∫—Ä–æ–∫–∞–º–∏.</p>
                    
                    <p><strong>–ö—Ä–æ–∫ \(t \to t-1\):</strong></p>
                    $$ x_{t-1} = \frac{1}{\sqrt{\alpha_t}} \left( x_t - \frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}} \epsilon_\theta \right) + \sigma_t \cdot z \cdot \text{Temp} $$
                    
                    <p>–¶—è —Å—Ç—Ä–∞—à–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ —Ä–æ–±–∏—Ç—å —Ç—Ä–∏ –ø—Ä–æ—Å—Ç—ñ —Ä–µ—á—ñ:</p>
                    <ol>
                        <li>üîµ <strong>–ü—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è:</strong> –ú–µ—Ä–µ–∂–∞ \(\epsilon_\theta\) –≤–≥–∞–¥—É—î —à—É–º.</li>
                        <li>üî¥ <strong>–í—ñ–¥–Ω—ñ–º–∞–Ω–Ω—è:</strong> –ú–∏ –≤—ñ–¥–Ω—ñ–º–∞—î–º–æ —á–∞—Å—Ç–∏–Ω—É —Ü—å–æ–≥–æ —à—É–º—É (–≤–∏—Ä–∞–∑ —É –¥—É–∂–∫–∞—Ö). –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–∞—î —á–∏—Å—Ç—ñ—à–æ—é.</li>
                        <li>üü¢ <strong>–î–æ–¥–∞–≤–∞–Ω–Ω—è –•–∞–æ—Å—É (\(z \cdot \text{Temp}\)):</strong> –ú–∏ –¥–æ–¥–∞—î–º–æ —Ç—Ä–æ—Ö–∏ <em>–Ω–æ–≤–æ–≥–æ</em> –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ —à—É–º—É –Ω–∞–∑–∞–¥!</li>
                    </ol>
                </div>

                <div class="theory-block">
                    <h3>"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞" —ñ –Ω–æ–≤–∏–π —à—É–º</h3>
                    <p>–ù–æ–≤–∏–π —à—É–º - –¥–æ–¥–∞–Ω–æ–∫ \( + \sigma_t \cdot z \) –≤ –∫—ñ–Ω—Ü—ñ —Ñ–æ—Ä–º—É–ª–∏.  \(z \sim \mathcal{N}(0, I)\).</p>
					
					<ul>
                        <li><strong>\(z \sim \mathcal{N}(0, I)\):</strong> –¶–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–ø–∞–¥–∫–æ–≤–æ—Å—Ç—ñ (—à—É–º). </li>
                        <li><strong>\(\sigma_t\) (Sigma):</strong> –¶–µ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π —Ä—ñ–≤–µ–Ω—å "—Ç—Ä–µ–º—Ç—ñ–Ω–Ω—è" –Ω–∞ –∫—Ä–æ—Ü—ñ \(t\).
                            <br>‚Ä¢ –ö–æ–ª–∏ \(t\) –≤–µ–ª–∏–∫–µ (–ø–æ—á–∞—Ç–æ–∫) ‚Äî \(\sigma_t\) –≤–µ–ª–∏–∫–∞ (–º–∏ –º–æ–∂–µ–º–æ —Å–∏–ª—å–Ω–æ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É).
                            <br>‚Ä¢ –ö–æ–ª–∏ \(t \to 0\) (–∫—ñ–Ω–µ—Ü—å) ‚Äî \(\sigma_t \to 0\) (—Ç—Ä–µ–º—Ç—ñ—Ç–∏ –≤–∂–µ –Ω–µ –º–æ–∂–Ω–∞, —Ç—Ä–µ–±–∞ —Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ).</li>
                    </ul>

                    <p><strong>–ü–∞—Ä–∞–¥–æ–∫—Å:</strong> –ú–∏ —á–∏—Å—Ç–∏–º–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤—ñ–¥ —à—É–º—É, –∞–ª–µ –Ω–∞ –∫–æ–∂–Ω–æ–º—É –∫—Ä–æ—Ü—ñ –¥–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π —à—É–º. –ù–∞–≤—ñ—â–æ?!</p>
                    <p>–¶–µ –Ω–µ –¥–æ–∑–≤–æ–ª—è—î –ø—Ä–æ—Ü–µ—Å—É "–∑–∞—Å—Ç—Ä—è–≥—Ç–∏" –≤ —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–æ–º—É, —Ä–æ–∑–º–∏—Ç–æ–º—É —Å—Ç–∞–Ω—ñ. –¶–µ –Ω–∞–≥–∞–¥—É—î <em>–≤—ñ–¥–ø–∞–ª (annealing)</em> —É –º–µ—Ç–∞–ª—É—Ä–≥—ñ—ó. –¢—Ä–æ—Ö–∏ —Ç—Ä—è—Å–∫–∏ –¥–æ–∑–≤–æ–ª—è—î —Å–∏—Å—Ç–µ–º—ñ –≤–ø–∞—Å—Ç–∏ –≤ –±—ñ–ª—å—à –≥–ª–∏–±–æ–∫–∏–π —ñ —á—ñ—Ç–∫–∏–π –º—ñ–Ω—ñ–º—É–º (–∫—Ä–∞—â—É –∫–∞—Ä—Ç–∏–Ω–∫—É).</p>
                    <ul>
                        <li><strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (Temp):</strong> –¶–µ –º–Ω–æ–∂–Ω–∏–∫ –¥–ª—è —Ü—å–æ–≥–æ –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ —à—É–º—É \(z\).
                            <br>‚Ä¢ <strong>Temp = 0:</strong> –ú–∏ –Ω–µ –¥–æ–¥–∞—î–º–æ —à—É–º. –†–µ–∑—É–ª—å—Ç–∞—Ç "–Ω–∞–π–±—ñ–ª—å—à –π–º–æ–≤—ñ—Ä–Ω–∏–π", –∞–ª–µ —á–∞—Å—Ç–æ "–º–∏–ª—å–Ω–∏–π" —ñ –Ω—É–¥–Ω–∏–π.
                            <br>‚Ä¢ <strong>Temp > 0.5:</strong> –î–æ–¥–∞—î–º–æ –≤–∞—Ä—ñ–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å. –î–µ—Ç–∞–ª—ñ —Å—Ç–∞—é—Ç—å –≥–æ—Å—Ç—Ä—ñ—à–∏–º–∏, —Ç–µ–∫—Å—Ç—É—Ä–∏ ‚Äî –±–∞–≥–∞—Ç—à–∏–º–∏.
                        </li>
                    </ul>
                </div>

            </div>
			
			 <div class="theory-block">
                <h3>–ó–∞–ø–∏—Ç–∏ (–ö–æ–º–±—ñ–Ω—É–≤–∞–Ω–Ω—è —É–º–æ–≤)</h3>
                <p>–ö–æ–ª–∏ –≤–∏ –Ω–∞—Ç–∏—Å–∫–∞—î—Ç–µ –≥–∞–ª–æ—á–∫–∏ "–ö—ñ—Ç" —á–∏ "–ë–∞–Ω—Ç", –≤–∏ –∑–º—ñ–Ω—é—î—Ç–µ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—é —Ä—É—Ö—É —à—É–º—É. –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–∏–Ω—Ü–∏–ø <strong>–¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤–µ–∫—Ç–æ—Ä—ñ–≤</strong>.</p>
                <p>–ù–µ–π—Ä–æ–º–µ—Ä–µ–∂–∞ —Ä–æ–±–∏—Ç—å —Ç—Ä–∏ –æ–∫—Ä–µ–º—ñ –ø—Ä–æ–≥–Ω–æ–∑–∏ –Ω–∞ –∫–æ–∂–Ω–æ–º—É –∫—Ä–æ—Ü—ñ:</p>
                <ul style="font-family: monospace; background: #222; padding: 10px; border-radius: 6px;">
                    <li>Œµ_base = –ú–µ—Ä–µ–∂–∞(—à—É–º, t, –ø—É—Å—Ç–∏–π_–∑–∞–ø–∏—Ç)</li>
                    <li>Œµ_cat  = –ú–µ—Ä–µ–∂–∞(—à—É–º, t, "–ö—ñ—Ç")</li>
                    <li>Œµ_tie  = –ú–µ—Ä–µ–∂–∞(—à—É–º, t, "–ë–∞–Ω—Ç")</li>
                </ul>
                
                <p>–§—ñ–Ω–∞–ª—å–Ω–∏–π –Ω–∞–ø—Ä—è–º–æ–∫ —Ä—É—Ö—É —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è —è–∫ —Å—É–º–∞ –≤–µ–∫—Ç–æ—Ä—ñ–≤:</p>
                $$ \epsilon_{total} = \epsilon_{base} + s \cdot (\epsilon_{cat} - \epsilon_{base}) + s \cdot (\epsilon_{tie} - \epsilon_{base}) $$
                
                <p><strong>–©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î?</strong></p>
                <ul>
                    <li>–Ø–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ <strong>—Ç—ñ–ª—å–∫–∏ –ö–æ—Ç–∞</strong>: –ú–∏ –±–µ—Ä–µ–º–æ –±–∞–∑–æ–≤–∏–π —à—É–º —ñ "—à—Ç–æ–≤—Ö–∞—î–º–æ" –π–æ–≥–æ –≤ –±—ñ–∫ –∫–æ—Ç—ñ–≤.</li>
                    <li>–Ø–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ <strong>–ö—ñ—Ç + –ë–∞–Ω—Ç</strong>: –ú–∏ —à—Ç–æ–≤—Ö–∞—î–º–æ —à—É–º –æ–¥–Ω–æ—á–∞—Å–Ω–æ —ñ –¥–æ –∫–æ—Ç—ñ–≤, —ñ –¥–æ –±–∞–Ω—Ç—ñ–≤. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –≤–µ–∫—Ç–æ—Ä–∏ –¥–æ–¥–∞—é—Ç—å—Å—è, —ñ –≤–∏—Ö–æ–¥–∏—Ç—å "–ö—ñ—Ç –∑ –±–∞–Ω—Ç–æ–º".</li>
                    <li><em>s (Scale)</em> ‚Äî —Ü–µ —Å–∏–ª–∞ –ø–æ—à—Ç–æ–≤—Ö—É.</li>
                </ul>
            </div>
        </details>
		
		
		
			</div>
        </div>
    </div>

</div>

<script>
// === 1. CONFIG & STATE ===
let SZ = 16;
let P = SZ*SZ;
const STEPS = 60; //was 40
let HIDDEN = 200; 
const CFG_SCALE = 2.5;

// Settings
const cfg = { temp: 0.5, cont: 1.2, smooth: true };
const updCfg = (k,v) => cfg[k] = (k==='smooth')?v:Number(v);

// Math Helpers
const randn=()=>{let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();return Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v);}
const leaky = x => x > 0 ? x : 0.1 * x;
const d_leaky = x => x > 0 ? 1 : 0.1;
const rnd = (min, max) => Math.random() * (max - min) + min;

// Network State
let W1, B1, W2, B2, W3, B3, ms, vs;
let dataset = [];
let lossHistory = [];
let lastGenRaw = null; // Store last raw generation for live post-process

// Init
function initModel(customW) {
    if(!customW) SZ = parseInt(document.getElementById('selRes').value);
    P = SZ*SZ;
    HIDDEN = SZ === 32 ? 128 : 256;
    
    const init = n => new Float32Array(n).map(()=>(Math.random()-0.5)*0.08);
    const IN_DIM = P + 3; 

    if(customW) {
        // Load weights
        [W1,B1,W2,B2,W3,B3] = customW.map(arr => new Float32Array(arr));
        alert("–ú–æ–¥–µ–ª—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!");
    } else {
        // New random weights
        W1 = init(IN_DIM*HIDDEN); B1 = new Float32Array(HIDDEN);
        W2 = init((HIDDEN+IN_DIM)*HIDDEN); B2 = new Float32Array(HIDDEN);
        W3 = init((HIDDEN+IN_DIM)*P); B3 = new Float32Array(P);
    }
    
    // Reset Optim
    const zeros = n => new Float32Array(n);
    ms = [W1,B1,W2,B2,W3,B3].map(a=>zeros(a.length));
    vs = [W1,B1,W2,B2,W3,B3].map(a=>zeros(a.length));
    
    // UI Reset
    if(!customW) {
        dataset = [];
        lossHistory = [];
        document.getElementById('previews').innerHTML = "";
        document.getElementById('ep').innerText = "0";
    }
    drawGraph();
}

// === 2. DATASET & PREVIEWS ===
const ctxD = document.getElementById('cDraw').getContext('2d');
function clearC() { ctxD.fillStyle="#000"; ctxD.fillRect(0,0,160,160); }

// UI Drawing logic
let isD=false;
const getPos = e => {
    const r = ctxD.canvas.getBoundingClientRect();
    const x = (e.touches?e.touches[0].clientX:e.clientX)-r.left;
    const y = (e.touches?e.touches[0].clientY:e.clientY)-r.top;
    return {x,y};
}
['mousedown','touchstart'].forEach(e=>ctxD.canvas.addEventListener(e, ev=>{ isD=true; ev.preventDefault(); ctxD.beginPath(); const p=getPos(ev); ctxD.moveTo(p.x,p.y); }));
['mousemove','touchmove'].forEach(e=>ctxD.canvas.addEventListener(e, ev=>{ if(!isD)return; ev.preventDefault(); const p=getPos(ev); ctxD.strokeStyle="#fff"; ctxD.lineWidth=SZ===32?8:12; ctxD.lineCap='round'; ctxD.lineTo(p.x,p.y); ctxD.stroke(); }));
['mouseup','touchend'].forEach(e=>ctxD.canvas.addEventListener(e, ()=>isD=false));

function getPixels() {
    const t = document.createElement('canvas'); t.width=SZ; t.height=SZ;
    t.getContext('2d').drawImage(ctxD.canvas,0,0,SZ,SZ);
    const d = t.getContext('2d').getImageData(0,0,SZ,SZ).data;
    const arr = [];
    for(let i=0; i<d.length; i+=4) arr.push( (d[i]/255)*2 - 1 );
    return { arr, src: t.toDataURL() };
}

function updatePreviews() {
    const div = document.getElementById('previews');
    const cnt = document.getElementById('cnt');
    div.innerHTML = "";
    dataset.forEach((item, idx) => {
        const wrap = document.createElement('div'); wrap.className = 'prev-item';
        const img = document.createElement('img'); img.src = item.src;
        const btn = document.createElement('div'); btn.className = 'prev-del'; btn.innerText='x';
        
        btn.onclick = () => { dataset.splice(idx, 1); updatePreviews(); };
        
        wrap.appendChild(img); wrap.appendChild(btn);
        div.appendChild(wrap);
    });
    cnt.innerText = dataset.length;
}

function manualAdd() {
    const l1 = document.getElementById('chkCat').checked?1:0;
    const l2 = document.getElementById('chkTie').checked?1:0;
    const p = getPixels();
    dataset.push({ d: p.arr, src: p.src, l1, l2 });
    clearC();
    updatePreviews();
}

async function autoGen() {
    clearC();
    const delay = ms => new Promise(r => setTimeout(r, ms));
  for(let i=0; i<32; i++) {
        // --- CAT ---
        ctxD.fillStyle="#000"; ctxD.fillRect(0,0,160,160);
        await delay(5);
        ctxD.strokeStyle="#fff"; ctxD.lineWidth=rnd(12,14); //4 , 7
        const cx = 80 + rnd(-10,10), cy = 70 + rnd(-1,15), r = rnd(50, 55);
        
        ctxD.beginPath(); ctxD.arc(cx, cy, r, 0, 6.28); ctxD.stroke();
        await delay(15); // Anim frame
        
        ctxD.beginPath(); 
        ctxD.moveTo(cx-r*0.8, cy-r*0.5); ctxD.lineTo(cx-r*1.1, cy-r-20); ctxD.lineTo(cx-r*0.2, cy-r*0.9); ctxD.stroke();
        await delay(5);
        
        ctxD.beginPath();
        ctxD.moveTo(cx+r*0.8, cy-r*0.5); ctxD.lineTo(cx+r*1.1, cy-r-20); ctxD.lineTo(cx+r*0.2, cy-r*0.9); ctxD.stroke();
        
        // Face
        ctxD.fillStyle="#fff";
        ctxD.fillRect(cx-20, cy-10, 18, 12); ctxD.fillRect(cx+12, cy-10, 18, 13);
        ctxD.beginPath(); ctxD.moveTo(cx, cy+15); ctxD.lineTo(cx-20, cy+25); ctxD.moveTo(cx, cy+15); ctxD.lineTo(cx+20, cy+25); ctxD.stroke();
        
        let p = getPixels();
        dataset.push({ d: p.arr, src: p.src, l1:1, l2:0 });
        updatePreviews();

        // --- BOW ---
        await delay(25);
        ctxD.fillStyle="#000"; ctxD.fillRect(0,0,160,160);
        ctxD.strokeStyle="#fff"; ctxD.lineWidth=rnd(10,12);
        const tx = 80 + rnd(-5,5), ty = 135 + rnd(-5,5), wing = rnd(30, 40), h = rnd(15, 20);
        
        ctxD.beginPath();
        ctxD.moveTo(tx, ty); ctxD.lineTo(tx-wing, ty-h); ctxD.lineTo(tx-wing, ty+h); ctxD.lineTo(tx, ty); ctxD.stroke();
        await delay(5);
        
        ctxD.beginPath();
        ctxD.moveTo(tx, ty); ctxD.lineTo(tx+wing, ty-h); ctxD.lineTo(tx+wing, ty+h); ctxD.lineTo(tx, ty); ctxD.stroke();
        
        ctxD.fillStyle="#fff"; ctxD.beginPath(); ctxD.arc(tx, ty, 8, 0, 6.28); ctxD.fill();
        
        p = getPixels();
        dataset.push({ d: p.arr, src: p.src, l1:0, l2:1 });
        updatePreviews();
        await delay(20);
    }
    clearC();
}

// === 3. IO (SAVE/LOAD) ===
function saveData(type) {
    let data, name;
    if(type === 'model') {
        data = { sz: SZ, w: [W1,B1,W2,B2,W3,B3].map(a => Array.from(a)) };
        name = `ddpm_${SZ}x${SZ}.json`;
    } else {
        data = dataset;
        name = `dataset_${SZ}x${SZ}.json`;
    }
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
}

function loadData(type, input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (e) => {
        const d = JSON.parse(e.target.result);
        if(type === 'model') {
            document.getElementById('selRes').value = d.sz;
            SZ = d.sz;
            initModel(d.w);
        } else {
            dataset = d;
            updatePreviews();
            alert(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${dataset.length} —Å–µ–º–ø–ª—ñ–≤.`);
        }
    };
    r.readAsText(f);
}

// === 4. TRAINING WITH LR SCHEDULER ===
const alphaBar = [];
let prod = 1;
for(let t=0; t<STEPS; t++) {
    const b = 0.0001 + (0.15 - 0.0001)*(t/(STEPS-1)); 
    prod *= (1-b); alphaBar.push(prod);
}

function forward(x, cond) {
    const inp = [...x, ...cond];
    const h1 = new Float32Array(HIDDEN);
    for(let h=0; h<HIDDEN; h++) {
        let s = B1[h]; for(let i=0; i<inp.length; i++) s += inp[i]*W1[i*HIDDEN+h]; h1[h] = leaky(s);
    }
    const inp2 = [...h1, ...inp];
    const h2 = new Float32Array(HIDDEN);
    for(let h=0; h<HIDDEN; h++) {
        let s = B2[h]; for(let i=0; i<inp2.length; i++) s += inp2[i]*W2[i*HIDDEN+h]; h2[h] = leaky(s);
    }
    const inp3 = [...h2, ...inp];
    const out = new Float32Array(P);
    for(let o=0; o<P; o++) {
        let s = B3[o]; for(let i=0; i<inp3.length; i++) s += inp3[i]*W3[i*P+o]; out[o] = s;
    }
    return {inp, h1, inp2, h2, inp3, out};
}

function adam(w, g, m, v, lr) {
    const b1=0.9, b2=0.999;
    for(let i=0; i<w.length; i++) {
        let grad = g[i]; if(grad>1)grad=1; if(grad<-1)grad=-1;
        m[i] = b1*m[i] + (1-b1)*grad; v[i] = b2*v[i] + (1-b2)*grad*grad;
        w[i] -= lr * m[i] / (Math.sqrt(v[i])+1e-8);
    }
}

function trainStep(x0, l1_in, l2_in, lr) {
    let l1 = l1_in, l2 = l2_in;
    if (Math.random() < 0.2) { l1 = 0; l2 = 0; } // CFG Dropout

    const t = Math.floor(Math.random()*STEPS);
    const noise = new Float32Array(P).map(()=>randn());
    const ab = alphaBar[t];
    const xt = x0.map((v,i) => v*Math.sqrt(ab) + noise[i]*Math.sqrt(1-ab));
    
    const fwd = forward(xt, [t/STEPS, l1, l2]);
    let loss=0; const gOut = new Float32Array(P);
    for(let i=0; i<P; i++) {
        const e = fwd.out[i] - noise[i]; loss += e*e; gOut[i] = 2*e/P;
    }
    
    const D3=HIDDEN+P+3, D2=HIDDEN+P+3;
    const gW3=new Float32Array(W3.length), gB3=new Float32Array(P), gIn3=new Float32Array(D3);
    for(let o=0; o<P; o++) {
        const g=gOut[o]; gB3[o]=g; for(let i=0; i<D3; i++) { gW3[i*P+o]=g*fwd.inp3[i]; gIn3[i]+=g*W3[i*P+o]; }
    }
    const gH2=gIn3.slice(0,HIDDEN);
    const gW2=new Float32Array(W2.length), gB2=new Float32Array(HIDDEN), gIn2=new Float32Array(D2);
    for(let h=0; h<HIDDEN; h++) {
        const g=gH2[h]*d_leaky(fwd.h2[h]); gB2[h]=g; for(let i=0; i<D2; i++) { gW2[i*HIDDEN+h]=g*fwd.inp2[i]; gIn2[i]+=g*W2[i*HIDDEN+h]; }
    }
    const gH1=gIn2.slice(0,HIDDEN);
    const gW1=new Float32Array(W1.length), gB1=new Float32Array(HIDDEN);
    for(let h=0; h<HIDDEN; h++) {
        const g=gH1[h]*d_leaky(fwd.h1[h]); gB1[h]=g; for(let i=0; i<P+3; i++) gW1[i*HIDDEN+h]=g*fwd.inp[i];
    }
    
    adam(W3,gW3,ms[4],vs[4], lr); adam(B3,gB3,ms[5],vs[5], lr);
    adam(W2,gW2,ms[2],vs[2], lr); adam(B2,gB2,ms[3],vs[3], lr);
    adam(W1,gW1,ms[0],vs[0], lr); adam(B1,gB1,ms[1],vs[1], lr);
    
    return loss/P;
}

// Train Loop
let isT=false, epoch=0;
const ctxGraph = document.getElementById('cGraph').getContext('2d');

function toggleTrain(){
    if(!dataset.length)return alert("–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –¥–∞—Ç–∞—Å–µ—Ç!");
    isT=!isT; document.getElementById('btnTr').innerText=isT?"‚è∏ –°–¢–û–ü":"‚ñ∂ –°–¢–ê–†–¢ –ù–ê–í–ß–ê–ù–ù–Ø";
    if(isT) loop();
}

function loop(){
    if(!isT)return;
    let ls=0; const bsz = SZ===32?20:40;
    
    // --- LR SCHEDULER ---
    let lr = 0.0015;
    const lastLoss = lossHistory.length ? lossHistory[lossHistory.length-1] : 1.0;
    
    if (lastLoss < 0.15) lr = 0.0001;      // Precision mode
    else if (lastLoss < 0.3) lr = 0.0005;  // Stability mode
    
    document.getElementById('lrStat').innerText = `(LR: ${lr})`;

    for(let k=0;k<bsz;k++){
        const d=dataset[Math.floor(Math.random()*dataset.length)];
        ls += trainStep(d.d, d.l1, d.l2, lr);
    }
    epoch++;
    const avg = ls/bsz;
    lossHistory.push(avg); if(lossHistory.length>100) lossHistory.shift();
    
    document.getElementById('loss').innerText=avg.toFixed(3);
    document.getElementById('loss').style.color = avg<0.25 ? "#0f0" : (avg<0.4 ? "#fbbf24" : "red");
    document.getElementById('ep').innerText=epoch;
    
    if(epoch%3===0) drawGraph();
    requestAnimationFrame(loop);
}

function drawGraph() {
    const w = ctxGraph.canvas.width, h = ctxGraph.canvas.height;
    ctxGraph.clearRect(0,0,w,h);
    const yZone = h - (0.25 * h); 
    ctxGraph.fillStyle = "#1a3320"; ctxGraph.fillRect(0, yZone, w, h-yZone); // Green zone
    if(lossHistory.length < 2) return;
    ctxGraph.strokeStyle = "#0f0"; ctxGraph.lineWidth=2; ctxGraph.beginPath();
    for(let i=0; i<lossHistory.length; i++) {
        const x = (i / (100-1)) * w;
        let val = lossHistory[i]; if(val>1) val=1;
        const y = h - (val * h);
        if(i===0) ctxGraph.moveTo(x,y); else ctxGraph.lineTo(x,y);
    }
    ctxGraph.stroke();
}

// === 5. GENERATION & LIVE RENDER ===
const ctxGen = document.getElementById('cGen').getContext('2d');

// Despeckle Logic
function applyDespeckle(arr) {
    const res = new Float32Array(arr);
    for(let y=1; y<SZ-1; y++) {
        for(let x=1; x<SZ-1; x++) {
            const i = y*SZ + x;
            const c = arr[i] > 0 ? 1 : -1; 
            const n = [arr[i-1], arr[i+1], arr[i-SZ], arr[i+SZ]];
            let opp = 0; for(let k=0; k<4; k++) if( (n[k]>0?1:-1) !== c ) opp++;
            if(opp === 4) res[i] = -c; 
        }
    }
    return res;
}

// Live Render Function
function renderFinal() {
    if(!lastGenRaw) return;
    
    // 1. Despeckle if checked
    let data = document.getElementById('chkDespeckle').checked ? applyDespeckle(lastGenRaw) : lastGenRaw;
    
    // 2. Contrast & Convert to pixels
    const tmp = document.createElement('canvas'); tmp.width=SZ; tmp.height=SZ;
    const tid = tmp.getContext('2d').createImageData(SZ,SZ);
    
    for(let i=0; i<P; i++) {
        let v = (data[i]+1)/2; // 0..1
        v = (v - 0.5) * cfg.cont + 0.5; // Contrast
        v = v*255; v = v<0?0:v>255?255:v;
        tid.data[i*4]=v; tid.data[i*4+1]=v; tid.data[i*4+2]=v; tid.data[i*4+3]=255;
    }
    tmp.getContext('2d').putImageData(tid,0,0);
    
    // 3. Smooth Upscale?
    ctxGen.imageSmoothingEnabled = cfg.smooth;
    ctxGen.imageSmoothingQuality = "high";
    ctxGen.clearRect(0,0,160,160);
    ctxGen.drawImage(tmp, 0, 0, 160, 160);
}

async function generate() {
    if(isT) toggleTrain();
    const btn = document.getElementById('btnGen');
    btn.disabled=true;
    
    const wantCat = document.getElementById('gCat').checked;
    const wantTie = document.getElementById('gTie').checked;
    let x = new Float32Array(P).map(()=>randn());
    
    for(let t=STEPS-1; t>=0; t--) {
        document.getElementById('status').innerText = `Denoising... ${t}`;
        
        const fwd_uncond = forward(x, [t/STEPS, 0, 0]);
        let final_eps = new Float32Array(fwd_uncond.out);
        
        if(wantCat) {
            const fwd_cat = forward(x, [t/STEPS, 1, 0]);
            for(let i=0; i<P; i++) final_eps[i] += CFG_SCALE * (fwd_cat.out[i] - fwd_uncond.out[i]);
        }
        if(wantTie) {
            const fwd_tie = forward(x, [t/STEPS, 0, 1]);
            for(let i=0; i<P; i++) final_eps[i] += CFG_SCALE * (fwd_tie.out[i] - fwd_uncond.out[i]);
        }
        
        const ab = alphaBar[t];
        const beta = 1 - (ab/(t>0?alphaBar[t-1]:1));
        const sigma = Math.sqrt(beta);
        
        for(let i=0; i<P; i++) {
            let z = (t>0) ? randn() : 0;
            z *= cfg.temp; 
            x[i] = (1/Math.sqrt(1-beta)) * (x[i] - (beta/Math.sqrt(1-ab))*final_eps[i]) + sigma*z;
        }

        lastGenRaw = x; // Update buffer
        renderFinal();  // Draw current step
        await new Promise(r=>setTimeout(r, 10));
    }
    document.getElementById('status').innerText = "–ì–æ—Ç–æ–≤–æ";
    btn.disabled=false;
}

initModel();
</script>
</body>
</html>